#!/bin/bash -eux

package=$1
suffix=
if [ $# -ge 2 ]
then
    suffix=$2
fi

cd "/tmp/config/geoportal/${package}_geoportal/locale"

for lang in $(ls -d */ | sed "s#/##"); do
    msgfmt -o "${lang}/LC_MESSAGES/${package}_geoportal-client${suffix}.mo" \
        "${lang}/LC_MESSAGES/${package}_geoportal-client${suffix}.po"
    if [ -e "${lang}/LC_MESSAGES/${package}_geoportal-server${suffix}.mo" ]; then
        msgfmt -o "${lang}/LC_MESSAGES/${package}_geoportal-server${suffix}.mo" \
            "${lang}/LC_MESSAGES/${package}_geoportal-server${suffix}.po"
    fi
    node /usr/bin/compile-catalog \
        "/opt/c2cgeoportal/geoportal/c2cgeoportal_geoportal/locale/${lang}/LC_MESSAGES/ngeo.po" \
        "/opt/c2cgeoportal/geoportal/c2cgeoportal_geoportal/locale/${lang}/LC_MESSAGES/gmf.po" \
        "${lang}/LC_MESSAGES/${package}_geoportal-client${suffix}.po" \
        >"../static/${lang}${suffix}.json"
    if [ "${SIMPLE}" == TRUE ]; then
        mv "${lang}/LC_MESSAGES/${package}_geoportal-client${suffix}.mo" \
            "${lang}/LC_MESSAGES/geomapfishapp_geoportal-client${suffix}.mo"
        if [ -e "${lang}/LC_MESSAGES/${package}_geoportal-server${suffix}.mo" ]; then
            mv "${lang}/LC_MESSAGES/${package}_geoportal-server${suffix}.mo" \
                "${lang}/LC_MESSAGES/geomapfishapp_geoportal-server${suffix}.mo"
        fi
    fi
done

rm -rf */LC_MESSAGES/*.po
