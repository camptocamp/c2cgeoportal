<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Authentication &mdash; c2cgeoportal  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="c2cgeoportal  documentation" href="../index.html" />
    <link rel="up" title="Integrator Guide" href="index.html" />
    <link rel="next" title="Extend the data model" href="extend_data_model.html" />
    <link rel="prev" title="Infrastructure and Deployment" href="deploy.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="authentication">
<span id="integrator-authentication"></span><h1>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-default-policy">
<h2>The default policy<a class="headerlink" href="#the-default-policy" title="Permalink to this headline">¶</a></h2>
<p>By default <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> applications use an <em>auth ticket</em> authentication
policy (<code class="docutils literal"><span class="pre">AuthTktAuthenticationPolicy</span></code>). With this policy the user name is
obtained from the &#8220;auth ticket&#8221; cookie set in the request.</p>
<p>The policy is created, and added to the application&#8217;s configuration, in the
application&#8217;s main <code class="docutils literal"><span class="pre">__init__.py</span></code> file.</p>
</div>
<div class="section" id="using-another-policy">
<h2>Using another policy<a class="headerlink" href="#using-another-policy" title="Permalink to this headline">¶</a></h2>
<p>When using <code class="docutils literal"><span class="pre">AuthTktAuthenticationPolicy</span></code> an &#8220;auth ticket&#8221; cookie should be
set in the request for the user to be identified. In some applications using
another identification mechanism may be needed.</p>
<div class="section" id="example-with-a-remote-user-policy">
<h3>Example with a &#8220;remote user&#8221; policy<a class="headerlink" href="#example-with-a-remote-user-policy" title="Permalink to this headline">¶</a></h3>
<p>For example, in a project of ours, the c2cgeoportal application needs to
integrate with the Nevis single sign-on environment. This SSO system is
composed of a central auth server, and a proxy running as an Apache module.
The proxy takes care of communicating with the auth server, and sets the
username in the <code class="docutils literal"><span class="pre">REMOTE_USER</span></code> environment variable when the user has been
identified. With this system an &#8220;auth ticket&#8221; policy cannot be used, obviously.
A <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/1.3-branch/api/authentication.html#pyramid.authentication.RemoteUserAuthenticationPolicy">&#8220;remote user&#8221; authentication policy</a>
should be used instead.</p>
<p>To use a &#8220;remote user&#8221; authentication policy edit the application&#8217;s
main <code class="docutils literal"><span class="pre">__init__.py</span></code> file, and set <code class="docutils literal"><span class="pre">authentication_policy</span></code> to a
<code class="docutils literal"><span class="pre">RemoteUserAuthenticationPolicy</span></code> instance:</p>
<div class="code python highlight-python"><div class="highlight"><pre>from pyramid.config import Configurator
from pyramid.authentication import RemoteUserAuthenticationPolicy
from c2cgeoportal import locale_negotiator
from c2cgeoportal.resources import FAModels, defaultgroupsfinder
from ${package}.resources import Root

def main(global_config, **settings):
    &quot;&quot;&quot; This function returns a Pyramid WSGI application.
    &quot;&quot;&quot;
    authentication_policy = RemoteUserAuthenticationPolicy(
            callback=defaultgroupsfinder)
    config = Configurator(root_factory=Root, settings=settings,
            locale_negotiator=locale_negotiator,
            authentication_policy=authentication_policy)
    # ...
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">c2cgeoportal</span></code> provides an authentication policy callback, namely
<code class="docutils literal"><span class="pre">defaultgroupsfinder</span></code>, that is appropriate in most cases. This callback
assumes that <code class="docutils literal"><span class="pre">request.user.role</span></code> is a reference to the <code class="docutils literal"><span class="pre">Role</span></code> database
object (more information below). This callback is required for admin users to
be able to access to the admin interface.</p>
<p>It is important to note that when using a &#8220;remote user&#8221; authentication policy
the authentication process is delegated to an outside system. So calls to
<code class="docutils literal"><span class="pre">pyramid.security.remember</span></code> and <code class="docutils literal"><span class="pre">pyramid.security.forget</span></code>, as done in
c2cgeoportal&#8217;s <code class="docutils literal"><span class="pre">login</span></code> and <code class="docutils literal"><span class="pre">logout</span></code> views, have no effect.</p>
<p>With an authentication policy set in the application configuration the user
name can be obtained by calling <code class="docutils literal"><span class="pre">request.unauthenticated_userid</span></code>.
(This function returns <code class="docutils literal"><span class="pre">None</span></code> if there&#8217;s currently no authenticated user.)
But c2cgeoportal applications need to also know about the user&#8217;s <em>role</em> to
work properly.</p>
<p>So when using an external authentication system this system should also provide
the c2cgeoportal application with the name of the user&#8217;s role. This can be done
in <code class="docutils literal"><span class="pre">apache/wsgi.conf.mako</span></code> by relying on the <a class="reference external" href="http://httpd.apache.org/docs/2.2/mod/mod_setenvif.html">mod_setenvif</a> Apache module&#8217;s
<code class="docutils literal"><span class="pre">SetEnvIf</span></code> directive. For example:</p>
<div class="highlight-python"><div class="highlight"><pre>SetEnvIf isiwebsectoken &lt;role&gt;(.*)&lt;/role&gt; rolename=$1
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre>SetEnvIf isiwebsectoken &#39;&lt;field name=&quot;roles&quot;&gt;([a-zA-Z0-9,\.]*)&lt;/field&gt;&#39; rolename=$1
</pre></div>
</div>
<p>With this <code class="docutils literal"><span class="pre">mod_setenvif</span></code> extracts the role name from the <code class="docutils literal"><span class="pre">isiwebsectoken</span></code> header
and places it in the <code class="docutils literal"><span class="pre">rolename</span></code> environment variable. See the <code class="docutils literal"><span class="pre">mod_setenvif</span></code>
documentation for more details.</p>
<p>The connection between the nevisProxy and the application is established using
an Apache module called NINAP. The above Apache configuration may also contain
NINAP directives (see nevisProxy documentation). For instance to indicate what
field in the <code class="docutils literal"><span class="pre">isiwebsectoken</span></code> header contains the username:</p>
<div class="highlight-python"><div class="highlight"><pre>NINAP_UserPattern &#39;&lt;field name=&quot;loginId&quot;&gt;([a-zA-Z0-9\._-]*)&lt;/field&gt;&#39;
</pre></div>
</div>
<p>Eventually the following directives activate the access restriction to the
application:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;Location /&lt;instance_id&gt;/wsgi&gt;
  AuthType sectoken
  Require valid-user
&lt;/Location&gt;
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> code expects that the user data (user name, role name and
user functionalities) are available through the <code class="docutils literal"><span class="pre">user</span></code> property in the
<code class="docutils literal"><span class="pre">request</span></code> object. More specifically it expects <code class="docutils literal"><span class="pre">request.user.role.id</span></code> to
contain the role id, and <code class="docutils literal"><span class="pre">request.user.role.name</span></code> to contain the role name.
<code class="docutils literal"><span class="pre">request.user.username</span></code> and <code class="docutils literal"><span class="pre">request.user.functionalities</span></code> must be provided
as well.
Therefore the application should redefine the callback function that adds
a <code class="docutils literal"><span class="pre">user</span></code> property to the request. This is done by calling the
<code class="docutils literal"><span class="pre">set_request_property</span></code> function on the <code class="docutils literal"><span class="pre">Configurator</span></code> object.
You may for example add to <code class="docutils literal"><span class="pre">__init__.py</span></code>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_user_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">c2cgeoportal.models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">Role</span>
    <span class="k">class</span> <span class="nc">O</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">unauthenticated_userid</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">O</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">rolename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rolename&#39;</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">DBSession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Role</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">rolename</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">functionalities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">user</span>
</pre></div>
</div>
<p>And then, in the application&#8217;s <code class="docutils literal"><span class="pre">main</span></code> function:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">set_request_property</span><span class="p">(</span><span class="n">get_user_from_request</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span>
                            <span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">reify</span></code> argument is to <code class="docutils literal"><span class="pre">True</span></code> to cache the function&#8217;s return value and
actually execute the function only once per request. In this example the user
name is obtained by calling <code class="docutils literal"><span class="pre">unauthenticated_userid</span></code>, itself relying on the
authentication policy set in the application. The role object is obtained from
the value of the <code class="docutils literal"><span class="pre">rolename</span></code> environment variable by querying the database.</p>
<p>Please note that <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> expects the admin role to be <code class="docutils literal"><span class="pre">role_admin</span></code>.
If for some reason you need to use another name for this role, you may define
an alias in a project-specific callback and use it instead of the standard
<code class="docutils literal"><span class="pre">defaultgroupsfinder</span></code> as <code class="docutils literal"><span class="pre">AuthenticationPolicy</span></code> argument in <code class="docutils literal"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mygroupsfinder</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span>
    <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&lt;your_admin_rolename&gt;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;role_admin&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">role</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">authentication_policy</span> <span class="o">=</span> <span class="n">RemoteUserAuthenticationPolicy</span><span class="p">(</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">mygroupsfinder</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">c2cgeoportal</span></code> registers its own request property callback for <code class="docutils literal"><span class="pre">user</span></code>.
The one registered by the application overwrites it.</p>
</div>
<p>You should be set at this point.</p>
</div>
</div>
<div class="section" id="custom-user-validation">
<h2>Custom user validation<a class="headerlink" href="#custom-user-validation" title="Permalink to this headline">¶</a></h2>
<p>For logging in <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> validates the user credentials
(username/password) by reading the user information from the <code class="docutils literal"><span class="pre">user</span></code> database
table. If a c2cgeoportal application should work with another user information
source, like LDAP, another <em>client validation</em> mechanism should be set up.
<code class="docutils literal"><span class="pre">c2cgeoportal</span></code> provides a specific <code class="docutils literal"><span class="pre">Configurator</span></code> function for that, namely
<code class="docutils literal"><span class="pre">set_user_validator</span></code> which allow to register a custom validator.
Here&#8217;s an example:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">custom_user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyramid_ldap</span> <span class="kn">import</span> <span class="n">get_ldap_connector</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">get_ldap_connector</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>
<span class="o">...</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_user_validator</span><span class="p">(</span><span class="n">custom_user_validator</span><span class="p">)</span>
</pre></div>
</div>
<p>The validator function is passed three arguments: <code class="docutils literal"><span class="pre">request</span></code>, <code class="docutils literal"><span class="pre">username</span></code>,
and <code class="docutils literal"><span class="pre">password</span></code>. The function should return a string containing all the data
you want to keep if the credentials are valid, and <code class="docutils literal"><span class="pre">None</span></code> otherwise.</p>
<p>In this example the <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid_ldap/en/latest/">pyramid_ldap package</a> is used as
the user information source.</p>
<p>User validators can obviously be chained. For example, a user validator
function that queries the <code class="docutils literal"><span class="pre">user</span></code> database table if the user does not exist in
LDAP would look like this:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">custom_user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">c2cgeoportal</span> <span class="kn">import</span> <span class="n">default_user_validator</span>
    <span class="kn">from</span> <span class="nn">pyramid_ldap</span> <span class="kn">import</span> <span class="n">get_ldap_connector</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">get_ldap_connector</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">default_user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="custom-user-validation-ldap">
<h3>Custom user validation - LDAP<a class="headerlink" href="#custom-user-validation-ldap" title="Permalink to this headline">¶</a></h3>
<p>Full example using pyramid_ldap, see <cite># LDAP</cite> / <cite># END LDAP</cite> blocs.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="c1"># LDAP</span>
<span class="c1"># get_user_from_request also needed for the same reason</span>
<span class="kn">from</span> <span class="nn">c2cgeoportal</span> <span class="kn">import</span> <span class="n">locale_negotiator</span><span class="p">,</span> <span class="n">add_interface</span><span class="p">,</span> \
    <span class="n">INTERFACE_TYPE_SENCHA_TOUCH</span><span class="p">,</span> <span class="n">get_user_from_request</span>
<span class="c1"># END LDAP</span>
<span class="kn">from</span> <span class="nn">c2cgeoportal.lib.authentication</span> <span class="kn">import</span> <span class="n">create_authentication</span>
<span class="kn">from</span> <span class="nn">yourproject.resources</span> <span class="kn">import</span> <span class="n">Root</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># LDAP</span>
<span class="c1"># dependencies</span>
<span class="kn">import</span> <span class="nn">ldap</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span>
<span class="c1"># END LDAP</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># LDAP</span>
<span class="c1"># authenticate on LDAP and return cleaned user data</span>
<span class="k">def</span> <span class="nf">custom_user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">c2cgeoportal</span> <span class="kn">import</span> <span class="n">default_user_validator</span>
    <span class="kn">from</span> <span class="nn">pyramid_ldap</span> <span class="kn">import</span> <span class="n">get_ldap_connector</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">get_ldap_connector</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;user </span><span class="si">%s</span><span class="s1"> found in ldap&#39;</span> <span class="o">%</span> <span class="n">username</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;uid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user </span><span class="si">%s</span><span class="s2"> not found in ldap, searching locally&quot;</span> <span class="o">%</span> <span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">default_user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

<span class="c1"># get custom user data from request and link with existing c2cgeoportal</span>
<span class="c1"># role in your project</span>
<span class="k">def</span> <span class="nf">custom_get_user_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">O</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="kn">from</span> <span class="nn">c2cgeoportal.models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">Role</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;_user&#39;</span><span class="p">):</span>
        <span class="c1"># avoid recursive calls from</span>
        <span class="c1"># get_user_from_request -&gt; request.authenticated_userid -&gt; ...</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">_user</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user is not authenticated or is a ldap user&quot;</span><span class="p">)</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">unauthenticated_userid</span>
        <span class="k">if</span> <span class="n">identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">O</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">identity</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">functionalities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">is_password_changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">DBSession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Role</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">identity</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">request</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span>

    <span class="k">return</span> <span class="n">user</span>
<span class="c1"># END LDAP</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span>
        <span class="n">root_factory</span><span class="o">=</span><span class="n">Root</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
        <span class="n">locale_negotiator</span><span class="o">=</span><span class="n">locale_negotiator</span><span class="p">,</span>
        <span class="n">authentication_policy</span><span class="o">=</span><span class="n">create_authentication</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s2">&quot;c2cgeoportal&quot;</span><span class="p">)</span>

    <span class="c1"># LDAP</span>
    <span class="c1"># dependencies</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_ldap&#39;</span><span class="p">)</span>

    <span class="c1"># LDAP config</span>
    <span class="n">config</span><span class="o">.</span><span class="n">ldap_setup</span><span class="p">(</span>
        <span class="s1">&#39;ldap://ldap.server.host&#39;</span><span class="p">,</span>
        <span class="n">bind</span><span class="o">=</span><span class="s1">&#39;CN=ldap user,CN=Users,DC=example,DC=com&#39;</span><span class="p">,</span>
        <span class="n">passwd</span><span class="o">=</span><span class="s1">&#39;ld@pu5er&#39;</span>
    <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">ldap_set_login_query</span><span class="p">(</span>
        <span class="n">base_dn</span><span class="o">=</span><span class="s1">&#39;CN=Users,DC=example,DC=com&#39;</span><span class="p">,</span>
        <span class="n">filter_tmpl</span><span class="o">=</span><span class="s1">&#39;(uid=</span><span class="si">%(login)s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_ONELEVEL</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">ldap_set_groups_query</span><span class="p">(</span>
        <span class="n">base_dn</span><span class="o">=</span><span class="s1">&#39;CN=Users,DC=example,DC=com&#39;</span><span class="p">,</span>
        <span class="n">filter_tmpl</span><span class="o">=</span><span class="s1">&#39;(&amp;(objectCategory=group)(member=</span><span class="si">%(userdn)s</span><span class="s1">))&#39;</span><span class="p">,</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
        <span class="n">cache_period</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># END LDAP</span>

    <span class="c1"># scan view decorator for adding routes</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>

    <span class="c1"># add the interfaces</span>
    <span class="n">add_interface</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">add_interface</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)</span>
    <span class="n">add_interface</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;routing&quot;</span><span class="p">)</span>
    <span class="n">add_interface</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;mobile&quot;</span><span class="p">,</span> <span class="n">INTERFACE_TYPE_SENCHA_TOUCH</span><span class="p">)</span>

    <span class="c1"># LDAP</span>
    <span class="c1"># register the customized function</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_user_validator</span><span class="p">(</span><span class="n">custom_user_validator</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">custom_get_user_from_request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># END LDAP</span>

    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Authentication</a><ul>
<li><a class="reference internal" href="#the-default-policy">The default policy</a></li>
<li><a class="reference internal" href="#using-another-policy">Using another policy</a><ul>
<li><a class="reference internal" href="#example-with-a-remote-user-policy">Example with a &#8220;remote user&#8221; policy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-user-validation">Custom user validation</a><ul>
<li><a class="reference internal" href="#custom-user-validation-ldap">Custom user validation - LDAP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
      <li>Previous: <a href="deploy.html" title="previous chapter">Infrastructure and Deployment</a></li>
      <li>Next: <a href="extend_data_model.html" title="next chapter">Extend the data model</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/integrator/authentication.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-2014, Camptocamp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="../_sources/integrator/authentication.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/camptocamp/c2cgeoportal" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>