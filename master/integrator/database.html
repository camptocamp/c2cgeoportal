<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Database &#8212; c2cgeoportal  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../_static/css/c2c.css?v=939896e0" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Configuration Guide for advanced settings" href="configuration.html" />
    <link rel="prev" title="Project structure" href="structure.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="database">
<span id="integrator-database"></span><h1>Database<a class="headerlink" href="#database" title="Link to this heading">¶</a></h1>
<section id="schema">
<h2>Schema<a class="headerlink" href="#schema" title="Link to this heading">¶</a></h2>
<p>The database tables are separated in two schemas:</p>
<ul class="simple">
<li><p>The ‘main’ schema, which can be configured with the <code class="docutils literal notranslate"><span class="pre">PGSCHEMA</span></code> environment variable, contains the data that can be modified only by the administrator interface.</p></li>
<li><p>The ‘static’ schema, which can be configured with the <code class="docutils literal notranslate"><span class="pre">PGSCHEMA_STATIC</span></code> environment variable, contains the data that can be modified by the end user through the web application (user password, short links, OAuth token and audit logs, not the editing data).</p></li>
</ul>
<p>This separation makes possible to manage the application configuration (the layer tree) on the integration environment, and copy it to the production environment without any risk of overwriting the data modified by the end user.</p>
</section>
<section id="update-lifecycle">
<h2>Update lifecycle<a class="headerlink" href="#update-lifecycle" title="Link to this heading">¶</a></h2>
<p>The recommended setup is to have integration and production data on the same database, using
separate schemas. This setup allows for simpler switches between integration and production.</p>
<p>The recommended setup for the <code class="docutils literal notranslate"><span class="pre">static</span></code> schema is to have exactly one schema for integration
and one for production, e.-g.:
<code class="docutils literal notranslate"><span class="pre">integration_static</span></code> for the integration environment,
and <code class="docutils literal notranslate"><span class="pre">production_static</span></code> for production environment.</p>
<p>For the data of the <code class="docutils literal notranslate"><span class="pre">main</span></code> schema, we recommend to have one schema for each version of the application.
The following example shows how an update can be performed from a version <code class="docutils literal notranslate"><span class="pre">2019</span></code> to a version <code class="docutils literal notranslate"><span class="pre">2020</span></code>:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Integration schema name</p></th>
<th class="head"><p>Production schema name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Initial state</p></td>
<td><p>main_2019</p></td>
<td><p>main_2019</p></td>
</tr>
<tr class="row-odd"><td><p>Start a new version</p></td>
<td><p>main_2020</p></td>
<td><p>main_2019</p></td>
</tr>
<tr class="row-even"><td><p>Do the changes</p></td>
<td><p>main_2020</p></td>
<td><p>main_2019</p></td>
</tr>
<tr class="row-odd"><td><p>Publish the new version</p></td>
<td><p>main_2020</p></td>
<td><p>main_2020</p></td>
</tr>
</tbody>
</table>
<section id="initial-state">
<h3>Initial state<a class="headerlink" href="#initial-state" title="Link to this heading">¶</a></h3>
<p>Starting point is that the current version is the same on integration and production =&gt; <code class="docutils literal notranslate"><span class="pre">main_2019</span></code>.</p>
</section>
<section id="prepare-the-project">
<h3>Prepare the project<a class="headerlink" href="#prepare-the-project" title="Link to this heading">¶</a></h3>
<p>To be able to proceed like this, the variables <code class="docutils literal notranslate"><span class="pre">PGSCHEMA</span></code> and <code class="docutils literal notranslate"><span class="pre">PGSCHEMA_STATIC</span></code>
should be managed in your env files:</p>
<ul class="simple">
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">PGSCHEMA</span></code> should be set in the <code class="docutils literal notranslate"><span class="pre">env.project</span></code>; in this example, it will be set to
<code class="docutils literal notranslate"><span class="pre">main_2019</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">PGSCHEMA_STATIC</span></code> variable for production should be set in a specific env file
for production e.-g. <code class="docutils literal notranslate"><span class="pre">env.production</span></code>; it will be set for example to <code class="docutils literal notranslate"><span class="pre">integration_static</span></code> in the
env file, and to <code class="docutils literal notranslate"><span class="pre">production_static</span></code> in the production env file.</p></li>
<li><p>The line <code class="docutils literal notranslate"><span class="pre">PGSCHEMA=main</span></code> should be removed from your <code class="docutils literal notranslate"><span class="pre">env.project</span></code> file.</p></li>
</ul>
</section>
<section id="start-a-new-version">
<h3>Start a new version<a class="headerlink" href="#start-a-new-version" title="Link to this heading">¶</a></h3>
<p>When starting changes such as an application change and/or administration settings,
create a new schema <code class="docutils literal notranslate"><span class="pre">main_2020</span></code> and use it on integration. Now, integration uses <code class="docutils literal notranslate"><span class="pre">main_2020</span></code>,
while production still uses <code class="docutils literal notranslate"><span class="pre">main_2019</span></code>.</p>
<p>To create the new schema, you should copy the old one, for that <cite>c2cgeoportal</cite> provides a Postgres
function called <cite>clone_schema</cite>.
If you have not yet created this function in your database, use to following command to create it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker<span class="w"> </span>compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>tools<span class="w"> </span>psql<span class="w"> </span>--file<span class="o">=</span>/opt/clone_schema.sql</span>
</pre></div></div><p>To use the function, connect to your database and perform the following statement:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">clone_schema</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;&lt;current_schema_name&gt;&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;&lt;new_schema_name&gt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">TRUE</span><span class="p">);</span>
</pre></div>
</div>
<p>In our example, it will be:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">clone_schema</span><span class="p">(</span><span class="s1">&#39;main_2019&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;main_2020&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">TRUE</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">PGSCHEMA</span></code> variable should be set in the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to <code class="docutils literal notranslate"><span class="pre">main_2020</span></code>.</p>
</section>
<section id="do-the-changes">
<h3>Do the changes<a class="headerlink" href="#do-the-changes" title="Link to this heading">¶</a></h3>
<p>Now you can do the changes including upgrades.</p>
<p>If you want to restructure a geodata table, you should create a new table, use the new table name in your
mapfiles and your QGIS projects. The new table will be automatically used when you publish the new version.</p>
<p>To do a test on an editing table during integration, you should copy the table with e.-g.:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">edit</span><span class="p">.</span><span class="n">poi</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">edit</span><span class="p">.</span><span class="n">oi_integration</span><span class="p">;</span>
</pre></div>
</div>
<p>Use the new table in the ‘Geo table’ field of your layer in the administration interface.</p>
<p>Do your tests.</p>
<p>Don’t forget to put back your old value before publishing the new version.</p>
</section>
<section id="publish-the-new-version">
<h3>Publish the new version<a class="headerlink" href="#publish-the-new-version" title="Link to this heading">¶</a></h3>
<p>Publish the new version on production: now, integration and production both use <code class="docutils literal notranslate"><span class="pre">main_2020</span></code>.</p>
<p>For OpenShift projects, just push the integration branch into the production branch.</p>
<p>The schema <code class="docutils literal notranslate"><span class="pre">main_2019</span></code> still exists, so if needed, the production can be rolled back to this content.</p>
</section>
<section id="editing">
<h3>Editing<a class="headerlink" href="#editing" title="Link to this heading">¶</a></h3>
<p>To have a different schema for the geodata used in the editing, we can define the geo_table as follows:
<code class="docutils literal notranslate"><span class="pre">{GEODATA_SCHEMA}.table</span></code> where <code class="docutils literal notranslate"><span class="pre">{GEODATA_SCHEMA}</span></code> will be replaced by the <code class="docutils literal notranslate"><span class="pre">GEODATA_SCHEMA</span></code>
environment variable.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">c2cgeoportal</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=camptocamp&repo=c2cgeoportal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../administrator/index.html">Administrator Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Integrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
      <li>Previous: <a href="structure.html" title="previous chapter">Project structure</a></li>
      <li>Next: <a href="configuration.html" title="next chapter">Configuration Guide for advanced settings</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2011-2024, Camptocamp.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/integrator/database.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>