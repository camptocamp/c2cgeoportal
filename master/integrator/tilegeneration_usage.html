<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>TileCloud-chain Usage &#8212; c2cgeoportal  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../_static/css/c2c.css?v=939896e0" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="TileGeneration Configuration Reference" href="tilegeneration_ref.html" />
    <link rel="prev" title="TileGeneration" href="tilegeneration_doc.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="tilecloud-chain-usage">
<span id="integrator-tilegeneration-usage"></span><h1>TileCloud-chain Usage<a class="headerlink" href="#tilecloud-chain-usage" title="Link to this heading">¶</a></h1>
<p>Upstream documentation:</p>
<section id="configure">
<h2>Configure<a class="headerlink" href="#configure" title="Link to this heading">¶</a></h2>
<section id="configure-grids">
<h3>Configure grids<a class="headerlink" href="#configure-grids" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">grid</span></code> describes how the tiles are arranged.</p>
<p>Especially on <code class="docutils literal notranslate"><span class="pre">s3</span></code> or <code class="docutils literal notranslate"><span class="pre">azure</span></code> be careful to choose every of the grid settings before generating the
tiles. If you change one of them you must regenerate all the tiles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">resolutions</span></code> in [px/m] describes all the resolutions available for this layer. For a raster layer, have
a look to the maximum resolution of the source files. It is not needed to generate tiles at smaller
resolutions than the sources, it is preferable to use the OpenLayers client zoom. Note that you can add a
resolution in the end without regenerating all the tiles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bbox</span></code> should match the resolution of the extent. <strong>CAREFUL: you will have big issue if you use this
parameter to generate the tile on a restricted area</strong>: use the <code class="docutils literal notranslate"><span class="pre">bbox</span></code> on the layer instead.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">srs</span></code> specifies the code of the projection.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">unit</span></code> is the unit used by the projection.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tile_size</span></code> is the tile size in [px], defaults to 256.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">matrix_identifier</span></code> is <code class="docutils literal notranslate"><span class="pre">zoom</span></code> by default and can also be set to <code class="docutils literal notranslate"><span class="pre">resolution</span></code>. It specifies how the z
index is build to store the tiles, for example, for the resolutions <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">1,</span> <span class="pre">0.5]</span></code> the used values are
<code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1,</span> <span class="pre">2]</span></code> based on the zoom and <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">1,</span> <span class="pre">0_5]</span></code> based on the resolution. The second has the advantage of
allowing to add a new resolution without regenerating all the tiles, but it does not work with MapCache.</p>
</section>
<section id="configure-caches">
<h3>Configure caches<a class="headerlink" href="#configure-caches" title="Link to this heading">¶</a></h3>
<p>The available tile caches are: <code class="docutils literal notranslate"><span class="pre">s3</span></code>, <code class="docutils literal notranslate"><span class="pre">azure</span></code>, <code class="docutils literal notranslate"><span class="pre">bsddb</span></code>, <code class="docutils literal notranslate"><span class="pre">mbtile</span></code> and <code class="docutils literal notranslate"><span class="pre">filesystem</span></code>.</p>
<p>The best solution to store the tiles, <code class="docutils literal notranslate"><span class="pre">s3</span></code>, <code class="docutils literal notranslate"><span class="pre">azure</span></code>, <code class="docutils literal notranslate"><span class="pre">mbtiles</span></code> and <code class="docutils literal notranslate"><span class="pre">bsddb</span></code>, have the advantage of using only one
file per layer - style dimensions. To serve the <code class="docutils literal notranslate"><span class="pre">mbtile</span></code> and the <code class="docutils literal notranslate"><span class="pre">bsddb</span></code> see Distribute the tiles.</p>
<p><code class="docutils literal notranslate"><span class="pre">s3</span></code> needs a <code class="docutils literal notranslate"><span class="pre">bucket</span></code> and a <code class="docutils literal notranslate"><span class="pre">folder</span></code> (defaults to ‘’).</p>
<p><code class="docutils literal notranslate"><span class="pre">azure</span></code> needs a <code class="docutils literal notranslate"><span class="pre">container</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">mbtiles</span></code>, <code class="docutils literal notranslate"><span class="pre">bsddb</span></code> and <code class="docutils literal notranslate"><span class="pre">filesystem</span></code> just need a <code class="docutils literal notranslate"><span class="pre">folder</span></code>.</p>
<p>On all the caches we can add some information to generate the URL where the tiles are available. This is
needed to generate the capabilities. We can specify:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">http_url</span></code> direct url to the tiles root.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">http_urls</span></code> (array) urls to the tiles root.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">http_url</span></code> and <code class="docutils literal notranslate"><span class="pre">hosts</span></code> (array), where each value of <code class="docutils literal notranslate"><span class="pre">hosts</span></code> is used to replace <code class="docutils literal notranslate"><span class="pre">%(host)s</span></code> in
<code class="docutils literal notranslate"><span class="pre">http_url</span></code>.</p></li>
</ul>
<p>In all case <code class="docutils literal notranslate"><span class="pre">http_url</span></code> or <code class="docutils literal notranslate"><span class="pre">http_urls</span></code> can include all attributes of this cache as <code class="docutils literal notranslate"><span class="pre">%(attribute)s</span></code>.</p>
<section id="mbtiles-vs-berkeley-db-bsddb">
<h4>MBTiles vs Berkeley DB (<code class="docutils literal notranslate"><span class="pre">bsddb</span></code>)<a class="headerlink" href="#mbtiles-vs-berkeley-db-bsddb" title="Link to this heading">¶</a></h4>
<ul class="simple">
<li><p>Read performance: similar, eventually the MBTiles is 10% faster.</p></li>
<li><p>Write performance: The Berkeley DB is largely faster, about 10 times.</p></li>
<li><p>List the tiles: the MBTiles is largely faster, but we usually don’t need it.</p></li>
</ul>
</section>
</section>
<section id="configure-layers">
<h3>Configure layers<a class="headerlink" href="#configure-layers" title="Link to this heading">¶</a></h3>
<p>First, all the attributes in <code class="docutils literal notranslate"><span class="pre">layer_default</span></code> are copied in all the layers to define the default values.</p>
<p>We have two <code class="docutils literal notranslate"><span class="pre">type</span></code> of layer: <code class="docutils literal notranslate"><span class="pre">wms</span></code> or <code class="docutils literal notranslate"><span class="pre">mapnik</span></code>.</p>
<p>To start the common attributes are:</p>
<p><code class="docutils literal notranslate"><span class="pre">min_resolution_seed</span></code> the minimum resolution that is seeded, other resolutions are served by MapCache.</p>
<p><code class="docutils literal notranslate"><span class="pre">bbox</span></code> used to limit the tiles generation.</p>
<p><code class="docutils literal notranslate"><span class="pre">px_buffer</span></code> a buffer in px around the object area (geoms or extent).</p>
<section id="wmts-layout">
<h4>WMTS layout<a class="headerlink" href="#wmts-layout" title="Link to this heading">¶</a></h4>
<p>To generate the file paths and the WMTS capabilities we need additional information:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">mime_type</span></code> of the tiles, it’s also used by the WMS GetMap and to upload the tiles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">wmts_style</span></code> defaults to ‘default’.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">extension</span></code> is used to end the filename.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">dimensions</span></code> (defaults to []) is an array of objects that have a <code class="docutils literal notranslate"><span class="pre">name</span></code>, a <code class="docutils literal notranslate"><span class="pre">default</span></code> value specified
in the capabilities, a <code class="docutils literal notranslate"><span class="pre">value</span></code> to generate the tiles (it can be overwritten by an argument), and an array of
<code class="docutils literal notranslate"><span class="pre">values</span></code> that contains all the possible values available in the capabilities.</p>
<p>For example if you generate the tiles and capabilities with the following configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dimensions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATE</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2012</span>
<span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2012</span>
<span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2012</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>then with the following configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dimensions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATE</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2012</span>
<span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2013</span>
<span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2012</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2013</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>We will have two set of tiles <code class="docutils literal notranslate"><span class="pre">2012</span></code> and <code class="docutils literal notranslate"><span class="pre">2013</span></code>, both accessible by the capabilities, and by default we
will see the first set of tiles.</p>
</section>
<section id="meta-tiles">
<h4>Meta tiles<a class="headerlink" href="#meta-tiles" title="Link to this heading">¶</a></h4>
<p>The meta tiles are activated by setting <code class="docutils literal notranslate"><span class="pre">meta</span></code> to <code class="docutils literal notranslate"><span class="pre">on</span></code> (by default it’s <code class="docutils literal notranslate"><span class="pre">off</span></code>).</p>
<p>The meta tiles are used for two things: first to generate multiple tiles with only one WMS query. By setting
<code class="docutils literal notranslate"><span class="pre">meta_size</span></code> to 8 we will generate a square of 8 by 8 tiles in one shot.</p>
<p>The second usage of meta tiles is prevent cut label names: this is solved by getting a bigger image and cutting
the borders. The <code class="docutils literal notranslate"><span class="pre">meta_buffer</span></code> should be set to a bigger value than half the size of the longest label.</p>
</section>
<section id="configure-hash">
<h4>Configure hash<a class="headerlink" href="#configure-hash" title="Link to this heading">¶</a></h4>
<p>We can filter tiles and meta tiles by using an hash.</p>
<p>The configuration of this hash is in the layer like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">empty_metatile_detection</span><span class="p">:</span>
<span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">740</span>
<span class="w">    </span><span class="nt">hash</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3237839c217b51b8a9644d596982f342f8041546</span>
<span class="nt">empty_tile_detection</span><span class="p">:</span>
<span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">921</span>
<span class="w">    </span><span class="nt">hash</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1e3da153be87a493c4c71198366485f290cad43c</span>
</pre></div>
</div>
<p>To easily generate this configuration we can use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">generate</span><span class="o">-</span><span class="n">tiles</span> <span class="o">--</span><span class="n">get</span><span class="o">-</span><span class="nb">hash</span> <span class="o">&lt;</span><span class="n">z</span><span class="o">/</span><span class="n">x</span><span class="o">/</span><span class="n">y</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">l</span> <span class="o">&lt;</span><span class="n">layer_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">&lt;z/x/y&gt;</span></code> should refer to an empty tile/metatile. Generally it’s a good idea to use z as the maximum
zoom, x and y as 0.</p>
</section>
<section id="configure-geom-sql">
<h4>Configure geom/sql<a class="headerlink" href="#configure-geom-sql" title="Link to this heading">¶</a></h4>
<p>We can generate the tiles only on some geometries stored in PostGis.</p>
<p>The configuration is in the layer like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">geoms</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user=www-data password=www-data dbname=&lt;db&gt; host=localhost</span>
<span class="w">    </span><span class="nt">sql</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;column&gt; AS geom FROM &lt;table&gt;</span>
<span class="w">    </span><span class="nt">min_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;resolution&gt;</span><span class="w"> </span><span class="c1"># included, optional, last win</span>
<span class="w">    </span><span class="nt">max_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;resolution&gt;</span><span class="w"> </span><span class="c1"># included, optional, last win</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">geoms</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user=postgresql password=postgresql dbname=tests host=localhost</span>
<span class="w">    </span><span class="nt">sql</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">the_geom AS geom FROM tests.polygon</span>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user=postgresql password=postgresql dbname=tests host=localhost</span>
<span class="w">    </span><span class="nt">sql</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">the_geom AS geom FROM tests.point</span>
<span class="w">    </span><span class="nt">min_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">max_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</pre></div>
</div>
<p>It’s preferable to use simple geometries, too complex geometries can slow down the generation.</p>
</section>
<section id="legends">
<h4>Legends<a class="headerlink" href="#legends" title="Link to this heading">¶</a></h4>
<p>To be able to generate legends with <code class="docutils literal notranslate"><span class="pre">generate-controller</span> <span class="pre">--generate-legend-images</span></code> you should have
<code class="docutils literal notranslate"><span class="pre">legend_mime</span></code> and <code class="docutils literal notranslate"><span class="pre">legend_extension</span></code> in the layer configuration.</p>
<p>for example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">legend_mime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/png</span>
<span class="nt">legend_extension</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">png</span>
</pre></div>
</div>
<p>Then it will create a legend image per layer and per zoom level named
<code class="docutils literal notranslate"><span class="pre">.../1.0.0/{{layer}}/{{wmts_style}}/legend{{zoom}}.{{legend_extension}}</span></code> only if she is different from the
previous zoom level. If we have only one legend image it still stores in the file named
<code class="docutils literal notranslate"><span class="pre">legend0.{{legend_extension}}</span></code>.</p>
<p>When we do <code class="docutils literal notranslate"><span class="pre">generate-controller</span> <span class="pre">--generate-wmts-capabilities</span></code> we will at first parse the legend images to
generate a layer configuration like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">legends</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">mime_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/png</span>
<span class="w">    </span><span class="nt">href</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://host/tiles/layer/style/legend0.png</span>
<span class="w">    </span><span class="nt">min_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span><span class="w"> </span><span class="c1"># optional, [m/px]</span>
<span class="w">    </span><span class="nt">max_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000</span><span class="w"> </span><span class="c1"># optional, [m/px]</span>
<span class="w">    </span><span class="nt">min_scale</span><span class="p">:</span><span class="w"> </span><span class="c1"># if define overwrite the min_resolution [m/m]</span>
<span class="w">    </span><span class="nt">max_scale</span><span class="p">:</span><span class="w"> </span><span class="c1"># if define overwrite the max_resolution [m/m]</span>
</pre></div>
</div>
<p>If you define a legends array in the layer configuration it is directly used to generate the capabilities.</p>
</section>
<section id="wms-layers">
<h4>WMS layers<a class="headerlink" href="#wms-layers" title="Link to this heading">¶</a></h4>
<p>The additional value needed by the WMS is the URL of the server and the <code class="docutils literal notranslate"><span class="pre">layers</span></code>.</p>
<p>The previously defined <code class="docutils literal notranslate"><span class="pre">mime_type</span></code> is also used in the WMS requests.</p>
<p>To customize the request you also have the attributes <code class="docutils literal notranslate"><span class="pre">params</span></code>, <code class="docutils literal notranslate"><span class="pre">headers</span></code> and <code class="docutils literal notranslate"><span class="pre">generate_salt</span></code>. In
<code class="docutils literal notranslate"><span class="pre">params</span></code> you can specify additional parameter of the WMS request, in <code class="docutils literal notranslate"><span class="pre">headers</span></code> you can modify the request
headers. In <code class="docutils literal notranslate"><span class="pre">version</span></code>, you can change the WMS version. See the Proxy/cache issue for additional information.</p>
</section>
<section id="mapnik-layers">
<h4>Mapnik layers<a class="headerlink" href="#mapnik-layers" title="Link to this heading">¶</a></h4>
<p>We need to specify the <code class="docutils literal notranslate"><span class="pre">mapfile</span></code> path.</p>
<p>With Mapnik we have the possibility to specify a <code class="docutils literal notranslate"><span class="pre">data_buffer</span></code> then we should set the unneeded
<code class="docutils literal notranslate"><span class="pre">meta_buffer</span></code> to 0.</p>
<p>And the <code class="docutils literal notranslate"><span class="pre">output_format</span></code> used for the Mapnik renderer, can be <code class="docutils literal notranslate"><span class="pre">png</span></code>, <code class="docutils literal notranslate"><span class="pre">png256</span></code>, <code class="docutils literal notranslate"><span class="pre">jpeg</span></code>, <code class="docutils literal notranslate"><span class="pre">grid</span></code>
(grid_renderer).</p>
<section id="mapnik-grid-layers">
<h5>Mapnik grid layers<a class="headerlink" href="#mapnik-grid-layers" title="Link to this heading">¶</a></h5>
<p>With Mapnik we can generate UTFGrid tiles (JSON format that describes the tiles present on a corresponding
tile) by using the <code class="docutils literal notranslate"><span class="pre">output_format</span></code> ‘grid’, see also:
<a class="reference external" href="https://github.com/mapnik/mapnik/wiki/MapnikRenderers#grid_renderer">https://github.com/mapnik/mapnik/wiki/MapnikRenderers#grid_renderer</a>.</p>
<p>Specific configuration:</p>
<p>We have a specific way to <code class="docutils literal notranslate"><span class="pre">drop_empty_utfgrid</span></code> by using the <code class="docutils literal notranslate"><span class="pre">on</span></code> value.</p>
<p>We should specify the pseudo pixel size [px] with the <code class="docutils literal notranslate"><span class="pre">resolution</span></code>.</p>
<p>And the <code class="docutils literal notranslate"><span class="pre">layers_fields</span></code> that we want to get the attributes. Object with the layer name as key and the values
in an array as value.</p>
<p>In fact the Mapnik documentation says that’s working only for one layer.</p>
<p>And don’t forget to change the <code class="docutils literal notranslate"><span class="pre">extension</span></code> to <code class="docutils literal notranslate"><span class="pre">json</span></code>, and the <code class="docutils literal notranslate"><span class="pre">mime_type</span></code> to <code class="docutils literal notranslate"><span class="pre">application/utfgrid</span></code> and
the <code class="docutils literal notranslate"><span class="pre">meta</span></code> to <code class="docutils literal notranslate"><span class="pre">off</span></code> (not supported).</p>
<p>Configuration example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">grid</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mapnik</span>
<span class="w">    </span><span class="nt">mapfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">style.mapnik</span>
<span class="w">    </span><span class="nt">output_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grid</span>
<span class="w">    </span><span class="nt">extension</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">json</span>
<span class="w">    </span><span class="nt">mime_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/utfgrid</span>
<span class="w">    </span><span class="nt">drop_empty_utfgrid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">on</span>
<span class="w">    </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">    </span><span class="nt">meta</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">off</span>
<span class="w">    </span><span class="nt">data_buffer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">    </span><span class="nt">layers_fields</span><span class="p">:</span>
<span class="w">        </span><span class="nt">buildings</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">street</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="process">
<h3>Process<a class="headerlink" href="#process" title="Link to this heading">¶</a></h3>
<p>We can configure some tile commands to process the tiles. They can be automatically be called in the tile
generation it we set the property <code class="docutils literal notranslate"><span class="pre">post_process</span></code> or <code class="docutils literal notranslate"><span class="pre">pre_hash_post_process</span></code> in the layer configuration.</p>
<p>The process is a set of names processes, and each one has a list of commands declared like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">process</span><span class="p">:</span><span class="w">  </span><span class="c1"># root process config</span>
<span class="w">    </span><span class="nt">optipng</span><span class="p">:</span><span class="w">  </span><span class="c1"># the process command</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">optipng %(args)s -q -zc9 -zm8 -zs3 -f5 -o %(out)s %(in)s</span><span class="w">  </span><span class="c1"># the command line</span>
<span class="w">        </span><span class="nt">need_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># if false the command rewrite the input file, default is false</span>
<span class="w">        </span><span class="nt">arg</span><span class="p">:</span><span class="w">  </span><span class="c1"># argument used with the different log switches, in all cases default is &#39;&#39;</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-q&#39;</span><span class="w"> </span><span class="c1"># the argument used by default</span>
<span class="w">            </span><span class="nt">quiet</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-q&#39;</span><span class="w"> </span><span class="c1"># the argument used in quiet mode</span>
<span class="w">            </span><span class="nt">verbose</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-v&#39;</span><span class="w"> </span><span class="c1"># the argument used in verbose mode</span>
<span class="w">            </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-log</span><span class="nv"> </span><span class="s">/tmp/optipng.log&#39;</span><span class="w"> </span><span class="c1"># the argument user in debug mode</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cmd</span></code> can have the following optional argument:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">args</span></code> the argument configured in the arg section.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">in</span></code>, <code class="docutils literal notranslate"><span class="pre">out</span></code> the input and output files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code> the tile coordinates.</p></li>
</ul>
</section>
<section id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Link to this heading">¶</a></h3>
<p>Tile logs can be saved to a PostgreSQL database with this configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">logging</span><span class="p">:</span>
<span class="w">    </span><span class="nt">database</span><span class="p">:</span>
<span class="w">       </span><span class="nt">dbname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_db</span>
<span class="w">       </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
<span class="w">       </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class="w">       </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tilecloud_logs</span>

<span class="l l-Scalar l-Scalar-Plain">PostgreSQL authentication can be specified with the ``PGUSER`` and ``PGPASSWORD`` environment variables.</span>
<span class="l l-Scalar l-Scalar-Plain">If the database is not reachable, the process will wait until it is.</span>
</pre></div>
</div>
</section>
<section id="tiles-error-file">
<h3>Tiles error file<a class="headerlink" href="#tiles-error-file" title="Link to this heading">¶</a></h3>
<p>If we set a file path in configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">generation</span><span class="p">:</span>
<span class="w">    </span><span class="nt">error_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;path&gt;</span>
</pre></div>
</div>
<p>The tiles that’s in error will be append to the file, ant the tiles can be regenerated with
<code class="docutils literal notranslate"><span class="pre">generate-tiles</span> <span class="pre">--tiles</span> <span class="pre">&lt;path&gt;</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;path&gt;</span></code> can be <code class="docutils literal notranslate"><span class="pre">/tmp/error_{layer}_{datetime:%Y-%m-%d_%H:%M:%S}</span></code> to have one file per layer and per
run.</p>
<p>The tiles file looks like:</p>
<p><code class="docutils literal notranslate"><span class="pre">{.sourceCode</span> <span class="pre">.}</span> <span class="pre">#</span> <span class="pre">[time]</span> <span class="pre">some</span> <span class="pre">comments</span> <span class="pre">z/x/y</span> <span class="pre">#</span> <span class="pre">[time]</span> <span class="pre">the</span> <span class="pre">error</span> <span class="pre">z/x/y:+m/+m</span> <span class="pre">#</span> <span class="pre">[time]</span> <span class="pre">the</span> <span class="pre">error</span></code></p>
<p>The first line is just a comment, the second, is for an error on a tile, and the third is for an error on a
meta tile.</p>
</section>
<section id="proxy-cache-issue">
<h3>Proxy/cache issue<a class="headerlink" href="#proxy-cache-issue" title="Link to this heading">¶</a></h3>
<p>In general we shouldn’t generate tiles throw a proxy, to do that you should configure the layers as this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">layers_name</span><span class="p">:</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost/wms</span>
<span class="w">    </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">the_host_name</span>
</pre></div>
</div>
<p>The idea is to get the WMS server on <code class="docutils literal notranslate"><span class="pre">localhost</span></code> and use the <code class="docutils literal notranslate"><span class="pre">Host</span></code> header to select the right Apache
VirtualHost.</p>
<p>To don’t have cache we use the as default the headers:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">headers</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Cache-Control</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no-cache, no-store</span>
<span class="w">    </span><span class="nt">Pragma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no-cache</span>
</pre></div>
</div>
<p>And if you steal have issue you can add a <code class="docutils literal notranslate"><span class="pre">SALT</span></code> random argument by setting the layer parameter
<code class="docutils literal notranslate"><span class="pre">generate_salt</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</section>
<section id="alternate-mime-type">
<h3>Alternate mime type<a class="headerlink" href="#alternate-mime-type" title="Link to this heading">¶</a></h3>
<p>By default TileCloud support only the <code class="docutils literal notranslate"><span class="pre">image/jpeg</span></code> and <code class="docutils literal notranslate"><span class="pre">image/png</span></code> mime type.</p>
</section>
</section>
<section id="queue-store">
<h2>Queue store<a class="headerlink" href="#queue-store" title="Link to this heading">¶</a></h2>
<p>We can store the queue in different store: Redis (<code class="docutils literal notranslate"><span class="pre">redis</span></code>), Amazone SQS (<code class="docutils literal notranslate"><span class="pre">sqs</span></code>) or PostgreSQL
(<code class="docutils literal notranslate"><span class="pre">postgresql</span></code>), see the related section for the configuration.</p>
<p>To configure witch store to use we should set the <code class="docutils literal notranslate"><span class="pre">queue_store</span></code> in the configuration file,
default it’s on Redis.</p>
</section>
<section id="postgresql">
<h2>PostgreSQL<a class="headerlink" href="#postgresql" title="Link to this heading">¶</a></h2>
<p>Is it possible to store the queue in a PostgreSQL database, for that you should at least set the
<code class="docutils literal notranslate"><span class="pre">queue_store</span></code> to <code class="docutils literal notranslate"><span class="pre">postgresql</span></code> in your (main) configuration file, and set the SqlAlchemy URL in the
configuration file or in the <code class="docutils literal notranslate"><span class="pre">TILECLOUD_CHAIN_SQLALCHEMY_URL</span></code> environment variable.</p>
<p>See the [configuration reference](<a class="reference external" href="https://github.com/camptocamp/tilecloud-chain/blob/master/tilecloud_chain/CONFIG.md#definitions/postgresql">https://github.com/camptocamp/tilecloud-chain/blob/master/tilecloud_chain/CONFIG.md#definitions/postgresql</a>) for the other configuration possibilities.</p>
<p>With that the admin page is enhance with a job concept with enhanced status and they can be
canceled, and restarted.</p>
<p>Note that you should have an external process to clean the old jobs in the database.</p>
</section>
<section id="amazon-services">
<h2>Amazon services<a class="headerlink" href="#amazon-services" title="Link to this heading">¶</a></h2>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Link to this heading">¶</a></h3>
<p>To be authenticated by Amazon you should set those environments variable before running a command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1"><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>...</span>
<span class="prompt1"><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>...</span>
</pre></div></div></section>
<section id="configure-s3">
<h3>Configure S3<a class="headerlink" href="#configure-s3" title="Link to this heading">¶</a></h3>
<p>The cache configuration is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">s3</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3</span>
<span class="w">    </span><span class="c1"># the s3 bucket name</span>
<span class="w">    </span><span class="nt">bucket</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tiles</span>
<span class="w">    </span><span class="c1"># the used folder in the bucket [default is &#39;&#39;]</span>
<span class="w">    </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span>
<span class="w">    </span><span class="c1"># for GetCapabilities</span>
<span class="w">    </span><span class="nt">http_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://%(host)s/%(bucket)s/%(folder)s/</span>
<span class="w">    </span><span class="nt">cache_control</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;public,</span><span class="nv"> </span><span class="s">max-age=14400&#39;</span>
<span class="w">    </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wmts0.&lt;host&gt;</span>
</pre></div>
</div>
<p>The bucket should already exists. If you don’t use Amazon’s S3, you must specify the <code class="docutils literal notranslate"><span class="pre">host</span></code> and the
<code class="docutils literal notranslate"><span class="pre">tiles_url</span></code> configuration parameter.</p>
</section>
<section id="configure-sqs">
<h3>Configure SQS<a class="headerlink" href="#configure-sqs" title="Link to this heading">¶</a></h3>
<p>The configuration in layer is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sqs</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># The region where the SQS queue is</span>
<span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eu-west-1</span>
<span class="w">    </span><span class="c1"># The SQS queue name, it should already exists</span>
<span class="w">    </span><span class="nt">queue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">the_name</span>
</pre></div>
</div>
<p>The queue should be used only by one layer.</p>
<p>To use the SQS queue we should first fill the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--role<span class="w"> </span>master<span class="w"> </span>--layer<span class="w"> </span>&lt;a_layer&gt;</span>
</pre></div></div><p>And then generate the tiles present in the SQS queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--role<span class="w"> </span>slave<span class="w"> </span>--layer<span class="w"> </span>&lt;a_layer&gt;</span>
</pre></div></div><p>For the slave to keep listening when the queue is empty and be able to support more than one layer, you must
enable the daemon mode and must not specify the layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--role<span class="w"> </span>slave<span class="w"> </span>--daemon</span>
</pre></div></div></section>
<section id="configure-sns">
<h3>Configure SNS<a class="headerlink" href="#configure-sns" title="Link to this heading">¶</a></h3>
<p>SNS can be used to send a message when the generation ends.</p>
<p>The configuration is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sns</span><span class="p">:</span>
<span class="w">    </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:sns:eu-west-1:your-account-id:tilecloud</span>
<span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eu-west-1</span>
</pre></div>
</div>
<p>The topic should already exists.</p>
</section>
<section id="amazon-tool">
<h3>Amazon tool<a class="headerlink" href="#amazon-tool" title="Link to this heading">¶</a></h3>
<p>Amazon has a command line tool (<a class="reference external" href="http://aws.amazon.com/fr/cli/">homepage</a>).</p>
<p>To use it, add in the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">awscli</span></code> as an <code class="docutils literal notranslate"><span class="pre">install_requires</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'aws</span> <span class="pre">=</span> <span class="pre">awscli.clidriver:main',</span></code> in the <code class="docutils literal notranslate"><span class="pre">console_scripts</span></code>.</p></li>
</ul>
<p>Than install it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>awscli
</pre></div>
</div>
<p>And use it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws<span class="w"> </span><span class="nb">help</span>
</pre></div>
</div>
<p>For example to delete many tiles do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws<span class="w"> </span>s3<span class="w"> </span>rm<span class="w"> </span>--recursive<span class="w"> </span>s3://your_bucket_name/folder
</pre></div>
</div>
</section>
<section id="configure-azure">
<h3>Configure Azure<a class="headerlink" href="#configure-azure" title="Link to this heading">¶</a></h3>
<p>The cache configuration is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">azure</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure</span>
<span class="w">    </span><span class="c1"># the Azure container name</span>
<span class="w">    </span><span class="nt">container</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tiles</span>
<span class="w">    </span><span class="c1"># the used folder in the container [default is &#39;&#39;]</span>
<span class="w">    </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span>
<span class="w">    </span><span class="c1"># for GetCapabilities</span>
<span class="w">    </span><span class="nt">http_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://%(host)s/%(bucket)s/%(folder)s/</span>
<span class="w">    </span><span class="nt">cache_control</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;public,</span><span class="nv"> </span><span class="s">max-age=14400&#39;</span>
<span class="w">    </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wmts0.&lt;host&gt;</span>
</pre></div>
</div>
<p>The container should already exists.</p>
<p>For the authentication you should set those environment variables:
<code class="docutils literal notranslate"><span class="pre">AZURE_STORAGE_CONNECTION_STRING</span></code> on your local environment,
or <code class="docutils literal notranslate"><span class="pre">AZURE_STORAGE_ACCOUNT_URL</span></code> if you run your container on Azure.</p>
</section>
</section>
<section id="other-related-configuration">
<h2>Other related configuration<a class="headerlink" href="#other-related-configuration" title="Link to this heading">¶</a></h2>
</section>
<section id="configure-the-server">
<h2>Configure the server<a class="headerlink" href="#configure-the-server" title="Link to this heading">¶</a></h2>
<p>The server can be configure as it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span>
<span class="w">    </span><span class="nt">layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">a_layer</span><span class="w"> </span><span class="c1"># Restrict to serve an certain number of layers [default is all]</span>
<span class="w">    </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mbtiles</span><span class="w"> </span><span class="c1"># The used cache [default use generation/default_cache]</span>
<span class="w">    </span><span class="c1"># the URL without location to MapCache, [default is http://localhost/]</span>
<span class="w">    </span><span class="nt">geoms_redirect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># use the geoms to redirect to MapCache [default is false]</span>
<span class="w">    </span><span class="c1"># allowed extension in the static path (default value), not used for s3.</span>
<span class="w">    </span><span class="nt">static_allow_extension</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">jpeg</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">png</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">xml</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">js</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">html</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">css</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>The minimal configuration is to enable it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>You should also configure the <code class="docutils literal notranslate"><span class="pre">http_url</span></code> of the used cache, to something like
<code class="docutils literal notranslate"><span class="pre">https://%(host)s/${instanceid}/tiles</span></code> or like <code class="docutils literal notranslate"><span class="pre">https://%(host)s/${instanceid}/wsgi/tiles</span></code> if you use the
Pyramid view.</p>
<section id="pyramid-view">
<h3>Pyramid view<a class="headerlink" href="#pyramid-view" title="Link to this heading">¶</a></h3>
<p>To use the pyramid view use the following configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;tilegeneration_configfile&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;the configuration file&gt;&#39;</span><span class="p">,</span>
<span class="p">})</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;tiles&#39;</span><span class="p">,</span> <span class="s1">&#39;/tiles/\*path&#39;</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="s1">&#39;tilecloud_chain.server:PyramidView&#39;</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;tiles&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="internal-wsgi-server">
<h3>Internal WSGI server<a class="headerlink" href="#internal-wsgi-server" title="Link to this heading">¶</a></h3>
<p>in <code class="docutils literal notranslate"><span class="pre">production.ini</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">app</span><span class="p">:</span><span class="n">tiles</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">tilecloud_chain</span><span class="c1">#server</span>
<span class="n">configfile</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">here</span><span class="p">)</span><span class="n">s</span><span class="o">/</span><span class="n">tilegeneration</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>with the Apache configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WSGIDaemonProcess tiles:${instanceid} display-name=%{GROUP} user=${modwsgi_user}
WSGIScriptAlias /${instanceid}/tiles ${directory}/apache/wmts.wsgi
&lt;Location /${instanceid}/tiles&gt;
    WSGIProcessGroup tiles:${instanceid}
    WSGIApplicationGroup %{GLOBAL}
&lt;/Location&gt;
</pre></div>
</div>
</section>
</section>
<section id="commands">
<h2>Commands<a class="headerlink" href="#commands" title="Link to this heading">¶</a></h2>
<section id="available-commands">
<h3>Available commands<a class="headerlink" href="#available-commands" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">generate-controller</span></code> generate the annex files like legend.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-tiles</span></code> generate the tiles.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-copy</span></code> copy the tiles from a cache to an other.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-process</span></code> process the tiles using a configured process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-cost</span></code> estimate the cost.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import-expiretiles</span></code> import the osm2pgsql expire-tiles file as geoms in the database.</p></li>
</ul>
<p>Each commands have a <code class="docutils literal notranslate"><span class="pre">--help</span></code> option to give a full arguments help.</p>
</section>
<section id="generate-tiles">
<h3>Generate tiles<a class="headerlink" href="#generate-tiles" title="Link to this heading">¶</a></h3>
<p>Generate all the tiles:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles</span>
</pre></div></div><p>Generate a specific layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--layer<span class="w"> </span>&lt;a_layer&gt;</span>
</pre></div></div><p>Generate a specific zoom:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--zoom<span class="w"> </span><span class="m">5</span></span>
</pre></div></div><p>Generate a specific zoom range:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--zoom<span class="w"> </span><span class="m">2</span>-8</span>
</pre></div></div><p>Generate a specific some zoom levels:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--zoom<span class="w"> </span><span class="m">2</span>,4,7</span>
</pre></div></div><p>Generate tiles from an (error) tiles file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--layer<span class="w"> </span>&lt;a_layer&gt;<span class="w"> </span>--tiles<span class="w"> </span>&lt;z/x/y&gt;</span>
</pre></div></div><p>Generate tiles on a bbox:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--bbox<span class="w"> </span>&lt;MINX&gt;<span class="w"> </span>&lt;MINY&gt;<span class="w"> </span>&lt;MAXX&gt;<span class="w"> </span>&lt;MAXY&gt;</span>
</pre></div></div><p>Generate a tiles near a tile coordinate (useful for test):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--near<span class="w"> </span>&lt;X&gt;<span class="w"> </span>&lt;Y&gt;</span>
</pre></div></div><p>Generate a tiles in a different cache than the default one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles<span class="w"> </span>--cache<span class="w"> </span>&lt;a_cache&gt;</span>
</pre></div></div></section>
</section>
<section id="explain-cost">
<h2>Explain cost<a class="headerlink" href="#explain-cost" title="Link to this heading">¶</a></h2>
<p>Configuration (default values):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cost</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># [nb/month]</span>
<span class="w">    </span><span class="nt">request_per_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">    </span><span class="nt">cloudfront</span><span class="p">:</span>
<span class="w">        </span><span class="nt">download</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.12,</span>
<span class="w">        </span><span class="nt">get</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.009</span>
<span class="w">    </span><span class="nt">request_per_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">    </span><span class="nt">s3</span><span class="p">:</span>
<span class="w">        </span><span class="nt">download</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.12,</span>
<span class="w">        </span><span class="nt">get</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01,</span>
<span class="w">        </span><span class="nt">put</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01,</span>
<span class="w">        </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.125</span>
<span class="w">    </span><span class="nt">sqs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">request</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>
</pre></div>
</div>
<p>Layer configuration (default values):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cost</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metatile_generation_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0,</span>
<span class="w">    </span><span class="nt">tile_generation_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0,</span>
<span class="w">    </span><span class="nt">tile_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20.0,</span>
<span class="w">    </span><span class="nt">tileonly_generation_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60.0</span>
</pre></div>
</div>
<p>The following commands can be used to know the time and cost to do generation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller<span class="w"> </span>--cost</span>
</pre></div></div><section id="useful-options">
<h3>Useful options<a class="headerlink" href="#useful-options" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">--quiet</span></code> or <code class="docutils literal notranslate"><span class="pre">-q</span></code>: used to display only errors.</p>
<p><code class="docutils literal notranslate"><span class="pre">--verbose</span></code> or <code class="docutils literal notranslate"><span class="pre">-v</span></code>: used to display info messages.</p>
<p><code class="docutils literal notranslate"><span class="pre">--debug</span></code> or <code class="docutils literal notranslate"><span class="pre">-d</span></code>: used to display debug message, please use this option to report issue. With the debug
mode we don’t catch exceptions, and we don’t log time messages.</p>
<p><code class="docutils literal notranslate"><span class="pre">--test</span> <span class="pre">&lt;n&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">&lt;n&gt;</span></code>: used to generate only <code class="docutils literal notranslate"><span class="pre">&lt;n&gt;</span></code> tiles, useful for test.</p>
</section>
</section>
<section id="mutualized">
<h2>Mutualized<a class="headerlink" href="#mutualized" title="Link to this heading">¶</a></h2>
<p>The mutualized mode consist by having multiple project files with the projects related configurations
(layers, cache, …) and one main configuration file with the global configuration (number of process,
log format, redis, …).</p>
<p>Configuration keys which should be set in the main configuration file are identified in property’s
descriptions of the <code class="docutils literal notranslate"><span class="pre">schema.json</span></code> file.</p>
</section>
<section id="important-remarks">
<h2>Important remarks<a class="headerlink" href="#important-remarks" title="Link to this heading">¶</a></h2>
<p>Especially on S3 the grid name, the layer name, the dimensions, can’t be changed (understand if we want to
change them we should regenerate all the tiles).</p>
<p>By default we also can’t insert a zoom level, if you think that you need it we can set the grid property
<code class="docutils literal notranslate"><span class="pre">matrix_identifier:</span> <span class="pre">resolution</span></code>, bit it don’t work with MapCache.</p>
<p>Please use the <code class="docutils literal notranslate"><span class="pre">--debug</span></code> to report issue.</p>
</section>
<section id="environment-variables">
<h2>Environment variables<a class="headerlink" href="#environment-variables" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TILEGENERATION_CONFIGFILE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">/etc/tilegeneration/config.yaml</span></code>, the all in one
configuration file to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILEGENERATION_MAIN_CONFIGFILE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">/etc/tilegeneration/config.yaml</span></code>, the main
configuration file to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILEGENERATION_HOSTSFILE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">/etc/tilegeneration/hosts.yaml</span></code>, the hosts to config file
mapping file to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILEGENERATION_MAX_GENERATION_TIME</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">60</span></code>, the maximum time to generate the tiles (lock timeout) in second.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_NB_THREAD</span></code>: Default is <code class="docutils literal notranslate"><span class="pre">2</span></code>, the number of thread used to generate the tiles (If we use meta tiles)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">METATILE_NB_THREAD</span></code>: Default is <code class="docutils literal notranslate"><span class="pre">25</span></code>, the number of thread used to generate the meta tiles (If we use
meta tiles, also to generate the tiles)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SERVER_NB_THREAD</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">10</span></code>, the number of thread used to generate the meta tiles in the server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_QUEUE_SIZE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">2</span></code>, the queue size just after the Redis queue</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_CHUNK_SIZE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">1</span></code>, the chunk size to process the tiles after the meta tiles.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILECLOUD_CHAIN_MAX_OUTPUT_LENGTH</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">1000</span></code>, the maximum number of character of the
output to be display in the admin interface.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILECLOUD_CHAIN_CONCURRENT_GET_LEGEND</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">10</span></code>, the number of concurrent request to get the
legend images during the generation of the capabilities.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOG_TYPE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">console</span></code>, can also be <code class="docutils literal notranslate"><span class="pre">json</span></code> to log in JSON for <code class="docutils literal notranslate"><span class="pre">Logstash</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILECLOUD_CHAIN_LOG_LEVEL</span></code> Default to <code class="docutils literal notranslate"><span class="pre">INFO</span></code>,
<code class="docutils literal notranslate"><span class="pre">TILECLOUD_LOG_LEVEL</span></code> Default to <code class="docutils literal notranslate"><span class="pre">INFO</span></code>,
<code class="docutils literal notranslate"><span class="pre">C2CWSGI_LOG_LEVEL</span></code> Default to <code class="docutils literal notranslate"><span class="pre">WARN</span></code>,
<code class="docutils literal notranslate"><span class="pre">OTHER_LOG_LEVEL</span></code> Default to <code class="docutils literal notranslate"><span class="pre">WARN</span></code>, the logging level of deferent components, can be <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>,
<code class="docutils literal notranslate"><span class="pre">INFO</span></code>, <code class="docutils literal notranslate"><span class="pre">WARN</span></code>, <code class="docutils literal notranslate"><span class="pre">ERROR</span></code> or <code class="docutils literal notranslate"><span class="pre">CRITICAL</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_SERVER_LOGLEVEL</span></code> Default to <code class="docutils literal notranslate"><span class="pre">quiet</span></code> the log level used in the server part.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_MAPCACHE_LOGLEVEL``Default</span> <span class="pre">to</span> <span class="pre">``verbose</span></code> the log level used in the internal mapcache.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEVELOPMENT</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">0</span></code> set it to <code class="docutils literal notranslate"><span class="pre">1</span></code> to have the Pyramid development options.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VISIBLE_ENTRY_POINT</span></code> Default to <code class="docutils literal notranslate"><span class="pre">/tiles/</span></code> the entrypoint path.</p></li>
</ul>
</section>
<section id="admin-and-test-pages">
<h2>Admin and test pages<a class="headerlink" href="#admin-and-test-pages" title="Link to this heading">¶</a></h2>
<p>On the URL <cite>&lt;base URL&gt;/admin/</cite> you can see the status of the generation, a tool to generate the tiles, and a link
to a test page.</p>
<p>Beware, the test page assumes we have configured only one grid.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo of c2cgeoportal"/>
            </a></p>
<h1 class="logo"><a href="../index.html">c2cgeoportal</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=camptocamp&repo=c2cgeoportal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../administrator/index.html">Administrator Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Integrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
  <li><a href="configuration.html">Configuration Guide for advanced settings</a><ul>
  <li><a href="tilegeneration.html">Tile generation configuration</a><ul>
      <li>Previous: <a href="tilegeneration_doc.html" title="previous chapter">TileGeneration</a></li>
      <li>Next: <a href="tilegeneration_ref.html" title="next chapter">TileGeneration Configuration Reference</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2011-2025, Camptocamp.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/integrator/tilegeneration_usage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>