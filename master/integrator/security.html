<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Security &#8212; c2cgeoportal  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../_static/css/c2c.css?v=939896e0" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Additional features" href="features.html" />
    <link rel="prev" title="Customize the application" href="customize.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="security">
<span id="integrator-security"></span><h1>Security<a class="headerlink" href="#security" title="Link to this heading">¶</a></h1>
<section id="authentication">
<span id="integrator-authentication"></span><h2>Authentication<a class="headerlink" href="#authentication" title="Link to this heading">¶</a></h2>
<section id="supported-standards">
<h3>Supported standards<a class="headerlink" href="#supported-standards" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><cite>OpenID Connect</cite>: as client, to be able to connect to an external OpenID Connect (OIDC) server.</p></li>
<li><p><cite>TOTP</cite>: for two-factor authentication (2FA), this can be used for example with Google Authenticator.</p></li>
<li><p><cite>OAuth2</cite> as server: An external application can use GeoMapFish as a single sign-on (SSO) for the
authentication, even if it was initially implemented to be able to connect from QGIS desktop on an
application that requires two factor authentication.</p></li>
</ul>
</section>
<section id="the-default-policy">
<h3>The default policy<a class="headerlink" href="#the-default-policy" title="Link to this heading">¶</a></h3>
<p>By default, <code class="docutils literal notranslate"><span class="pre">c2cgeoportal</span></code> applications use an <em>auth ticket</em> authentication
policy (<code class="docutils literal notranslate"><span class="pre">AuthTktAuthenticationPolicy</span></code>). With this policy, the user name is
obtained from the “auth ticket” cookie set in the request.
The policy is created, and added to the application’s configuration, in the
application’s main <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file.</p>
<p>In the file <code class="docutils literal notranslate"><span class="pre">env.project</span></code>, you can configure the policy with the following variables:</p>
<p><code class="docutils literal notranslate"><span class="pre">AUTHTKT_TIMEOUT</span></code>: Default to one day.
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_REISSUE_TIME</span></code>: Default to 2h30, recommended to be 10 times smaller than <code class="docutils literal notranslate"><span class="pre">AUTHTKT_TIMEOUT</span></code>.
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_MAXAGE</span></code>: Default to one day, good to have the same value as <code class="docutils literal notranslate"><span class="pre">AUTHTKT_TIMEOUT</span></code>.
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_SECRET</span></code>: Should be defined
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_COOKIENAME</span></code>: Should be defined
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_HTTP_ONLY</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">true</span></code>.
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_SECURE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">true</span></code>.
<code class="docutils literal notranslate"><span class="pre">AUTHTKT_SAMESITE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">Lax</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With the default configuration, for security reasons, the authentication will only work if the project is
served on <code class="docutils literal notranslate"><span class="pre">https</span></code>.</p>
</div>
<p>See also <a class="reference external" href="https://docs.pylonsproject.org/projects/pyramid/en/latest/api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy">the official documentation</a>.</p>
</section>
<section id="using-another-policy">
<h3>Using another policy<a class="headerlink" href="#using-another-policy" title="Link to this heading">¶</a></h3>
<p>When using <code class="docutils literal notranslate"><span class="pre">AuthTktAuthenticationPolicy</span></code>, an “auth ticket” cookie should be
set in the request for the user to be identified. In some applications, using
a custom identification mechanism may be needed instead, for instance to use SSO.
Our knowledge base has an example of how this can be achieved.</p>
</section>
<section id="user-validation">
<h3>User validation<a class="headerlink" href="#user-validation" title="Link to this heading">¶</a></h3>
<p>For logging in, <code class="docutils literal notranslate"><span class="pre">c2cgeoportal</span></code> validates the user credentials
(username/password) by reading the user information from the <code class="docutils literal notranslate"><span class="pre">user</span></code> database
table. If a c2cgeoportal application should work with another user information
source, like LDAP, a custom <em>client validation</em> mechanism can be set up.
Our knowledge base has an example of how this can be achieved.</p>
</section>
<section id="basic-auth">
<h3>Basic auth<a class="headerlink" href="#basic-auth" title="Link to this heading">¶</a></h3>
<p>To be able to access the OGC services from your desktop GIS, you should enable the basic authentication
by setting <code class="docutils literal notranslate"><span class="pre">BASICAUTH</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> in the <code class="docutils literal notranslate"><span class="pre">env.project</span></code> file.</p>
<p>To force the application to ask for a password, you should have the attribute <code class="docutils literal notranslate"><span class="pre">authentication_required</span></code>
in your query string.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For security reasons, basic authentication and two factor authentication should not be enabled together.</p>
</div>
</section>
<section id="two-factors-authentication">
<h3>Two factors authentication<a class="headerlink" href="#two-factors-authentication" title="Link to this heading">¶</a></h3>
<p>GeoMapFish support TOTP (Time-Based One-Time Password Algorithm) two factors authentication
(<a class="reference external" href="https://tools.ietf.org/html/rfc6238">RFC 6238</a>).
To enable the two factors authentication you should set the following settings:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authentication</span><span class="p">:</span>
<span class="w">    </span><span class="nt">two_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">two_factor_issuer_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;used_issuer_name&gt;</span>
</pre></div>
</div>
<p>If a user lost his second authentication factor he can’t ask for a new one, to reset it the administrator
should uncheck the ‘The user changed his password’ field on the user in the admin interface.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For security reasons, basic authentication and two factor authentication should not be enabled together,
you should use <a class="reference internal" href="#integrator-authentication-oauth2"><span class="std std-ref">OAuth2</span></a> for that.</p>
</div>
</section>
<section id="account-lockout">
<h3>Account lockout<a class="headerlink" href="#account-lockout" title="Link to this heading">¶</a></h3>
<p>To lock an account after a certain number of authentication failures, set the following settings:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authentication</span><span class="p">:</span>
<span class="w">    </span><span class="nt">max_consecutive_failures</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<p>To unlock a user, the administrator should uncheck the ‘Deactivated’ field on the user in the
admin interface.</p>
</section>
<section id="intranet">
<h3>Intranet<a class="headerlink" href="#intranet" title="Link to this heading">¶</a></h3>
<p>To configure the intranet networks fill in the configuration like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
<span class="w">  </span><span class="nt">intranet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.0/24</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.0/255.255.255.0</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.0/0.0.0.255</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2001:db00::0/24</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">2001:db00::0/ffff:ff00:</span><span class="p">:</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://docs.python.org/3.4/library/ipaddress.html#ipaddress.IPv4Network">Python documentation</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Intranet detection is provided to improve usability for web site usage within the Intranet;
however, please be aware that Intranet detection is not a secure mechanism. To secure access to sensitive
data, do not rely on Intranet detection; for that, you must use user authentication.</p>
<p>A user can easily manually set the <cite>Forwarded</cite> or <cite>X-Forwarded-For</cite> header to spoof his IP.</p>
</div>
</section>
<section id="lost-admin-password">
<h3>Lost admin password<a class="headerlink" href="#lost-admin-password" title="Link to this heading">¶</a></h3>
<p>You can generate a new admin password the following command:</p>
<p><p>Reset a user password.
The username is used as password if the password is not provided with the corresponding option.
User can be created if it does not exist yet.</p>
</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">docker</span> <span class="n">compose</span> <span class="n">exec</span> <span class="n">geoportal</span> <span class="n">manage</span><span class="o">-</span><span class="n">users</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">password</span> <span class="n">PASSWORD</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="o">--</span><span class="n">create</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="o">--</span><span class="n">rolename</span> <span class="n">ROLENAME</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="o">--</span><span class="n">email</span> <span class="n">EMAIL</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="n">config_uri</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="n">config_vars</span> <span class="o">...</span><span class="p">]</span> <span class="n">user</span>
</pre></div>
</div>
<section id="c2cgeoportal_geoportal.scripts.manage_users-get_argparser-positional-arguments">
<h4>Positional Arguments<a class="headerlink" href="#c2cgeoportal_geoportal.scripts.manage_users-get_argparser-positional-arguments" title="Link to this heading">¶</a></h4>
<dl class="option-list">
<dt><kbd>config_uri</kbd></dt>
<dd><p>The URI to the configuration file.</p>
<p>Default: <code class="docutils literal notranslate"><span class="pre">'c2c://geoportal/development.ini'</span></code></p>
</dd>
<dt><kbd>config_vars</kbd></dt>
<dd><p>Variables required by the config file. For example, <cite>http_port=%(http_port)s</cite> would expect <cite>http_port=8080</cite> to be passed here.</p>
<p>Default: <code class="docutils literal notranslate"><span class="pre">()</span></code></p>
</dd>
<dt><kbd>user</kbd></dt>
<dd><p>The user</p>
</dd>
</dl>
</section>
<section id="c2cgeoportal_geoportal.scripts.manage_users-get_argparser-named-arguments">
<h4>Named Arguments<a class="headerlink" href="#c2cgeoportal_geoportal.scripts.manage_users-get_argparser-named-arguments" title="Link to this heading">¶</a></h4>
<dl class="option-list">
<dt><kbd>--password, -p</kbd></dt>
<dd><p>Set password (if not set, username is used as password</p>
</dd>
<dt><kbd>--create, -c</kbd></dt>
<dd><p>Create user if it does not already exist</p>
<p>Default: <code class="docutils literal notranslate"><span class="pre">False</span></code></p>
</dd>
<dt><kbd>--rolename, -r</kbd></dt>
<dd><p>The role name which must exist in the database</p>
<p>Default: <code class="docutils literal notranslate"><span class="pre">'role_admin'</span></code></p>
</dd>
<dt><kbd>--email, -e</kbd></dt>
<dd><p>The user email</p>
</dd>
</dl>
</section>
</section>
<section id="external-application">
<h3>External application<a class="headerlink" href="#external-application" title="Link to this heading">¶</a></h3>
<p>Some service of GeoMapFish has some host restriction if you mix the domain.</p>
<section id="application-authentication">
<h4>Application authentication<a class="headerlink" href="#application-authentication" title="Link to this heading">¶</a></h4>
<p>To be considered as authenticated we should have the correct <code class="docutils literal notranslate"><span class="pre">Cookie</span></code> header,
we also check the <code class="docutils literal notranslate"><span class="pre">Referer</span></code> header to be sure that the user is coming from the same domain.
If he is equals to the <code class="docutils literal notranslate"><span class="pre">Host</span></code> header, we consider that the user is coming from the same domain.
If your server and client application are not on the same domain, to make the login working,
you should add the client application domain name (with port) in the vars in <code class="docutils literal notranslate"><span class="pre">vars/authorized_referers</span></code>.</p>
<p>This check is also done on the <code class="docutils literal notranslate"><span class="pre">came_from</span></code> parameter during the login process.</p>
</section>
<section id="shortener">
<h4>Shortener<a class="headerlink" href="#shortener" title="Link to this heading">¶</a></h4>
<p>If you use the shortener service to create link on application on another domain name, you should add
this domain name in the vars in <code class="docutils literal notranslate"><span class="pre">vars/shortener/allowed_hosts</span></code>.</p>
</section>
<section id="admin">
<h4>Admin<a class="headerlink" href="#admin" title="Link to this heading">¶</a></h4>
<p>We provide a view for the admin interface, to be able to clear the cache per OGC server.
If for an unknown reason you have not the same host in the <code class="docutils literal notranslate"><span class="pre">Host</span></code> header and <code class="docutils literal notranslate"><span class="pre">came_from</span></code> parameter, you should
add the domain of the <code class="docutils literal notranslate"><span class="pre">came_from</span></code> parameter in the vars in <code class="docutils literal notranslate"><span class="pre">vars/admin_interface/allowed_hosts</span></code>.</p>
</section>
<section id="openid-connect">
<span id="integrator-authentication-oidc"></span><h4>OpenID Connect<a class="headerlink" href="#openid-connect" title="Link to this heading">¶</a></h4>
<p>We can configure an OpenID connect service as an SSO (Single Sign-On) provider for our application. This allows users to log in to our application using their OpenID Connect credentials.</p>
<p>We use [OpenID Connect Discovery 1.0](<a class="reference external" href="https://openid.net/specs/openid-connect-discovery-1_0.html">https://openid.net/specs/openid-connect-discovery-1_0.html</a>) with an Authorization Code Flow from [OpenID Connect Core 1.0](<a class="reference external" href="https://openid.net/specs/openid-connect-core-1_0.html">https://openid.net/specs/openid-connect-core-1_0.html</a>), with PKCE (Proof Key for Code Exchange, RFC 7636).</p>
<div class="mermaid">
            sequenceDiagram
    actor User
    participant Browser
    participant Geoportal
    participant IAM
    Geoportal-&gt;&gt;IAM: discovery endpoint

    User-&gt;&gt;+Browser: Login
    Browser-&gt;&gt;+Geoportal: Login
    Geoportal-&gt;&gt;-Browser: redirect
    Browser-&gt;&gt;+IAM: authorization endpoint
    IAM-&gt;&gt;-Browser: redirect
    Browser-&gt;&gt;+Geoportal: callback endpoint
    Geoportal-&gt;&gt;IAM: token endpoint
    opt on using user info instead of jwt token
    Geoportal-&gt;&gt;IAM: userinfo endpoint
    end
    Geoportal-&gt;&gt;-Browser: authentication data in cookie
    Browser-&gt;&gt;-User: Reload

    Browser-&gt;&gt;+Geoportal: any auth endpoint
    opt on token expiry
    Geoportal-&gt;&gt;IAM: refresh token endpoint
    end
    Geoportal-&gt;&gt;-Browser: response
        </div></section>
</section>
<section id="authentication-provider">
<h3>Authentication provider<a class="headerlink" href="#authentication-provider" title="Link to this heading">¶</a></h3>
<p>If we want to use OpenID Connect as an authentication provider, we need to set the following configuration in our <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authentication</span><span class="p">:</span>
<span class="w">    </span><span class="nt">openid_connect</span><span class="p">:</span>
<span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;the service URL&gt;</span>
<span class="w">      </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;the client application ID&gt;</span>
<span class="w">      </span><span class="nt">user_info_fields</span><span class="p">:</span>
<span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sub</span><span class="w">  </span><span class="c1"># Default value</span>
<span class="w">        </span><span class="nt">display_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="w">  </span><span class="c1"># Default value</span>
<span class="w">        </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">email</span><span class="w">  </span><span class="c1"># Default value</span>
</pre></div>
</div>
<p>With that the user will be create in the database at the first login, and the access right will be set in the GeoMapFish database.
The user correspondence will be done on the email field.</p>
</section>
<section id="authorization-provider">
<h3>Authorization provider<a class="headerlink" href="#authorization-provider" title="Link to this heading">¶</a></h3>
<p>If we want to use OpenID Connect as an authorization provider, we need to set the following configuration in our <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authentication</span><span class="p">:</span>
<span class="w">    </span><span class="nt">openid_connect</span><span class="p">:</span>
<span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;the service URL&gt;</span>
<span class="w">      </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;the client application ID&gt;</span>
<span class="w">      </span><span class="nt">provide_roles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">user_info_fields</span><span class="p">:</span>
<span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="w">  </span><span class="c1"># Default value</span>
<span class="w">        </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">email</span><span class="w"> </span><span class="c1"># Default value</span>
<span class="w">        </span><span class="nt">settings_role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">settings_role</span>
<span class="w">        </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">roles</span>
</pre></div>
</div>
<p>With that the user will not be in the database only the roles will be set in the GeoMapFish database.</p>
</section>
<section id="other-options">
<h3>Other options<a class="headerlink" href="#other-options" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">client_secret</span></code>: The secret of the client.</p>
<p><code class="docutils literal notranslate"><span class="pre">trusted_audiences</span></code>: The list of trusted audiences, if the token audience is not in this list, the token will be rejected.</p>
<p><code class="docutils literal notranslate"><span class="pre">scopes</span></code>: The list of scopes to request, default is [<code class="docutils literal notranslate"><span class="pre">openid</span></code>, <code class="docutils literal notranslate"><span class="pre">profile</span></code>, <code class="docutils literal notranslate"><span class="pre">email</span></code>].</p>
<p><code class="docutils literal notranslate"><span class="pre">query_user_info</span></code>: If <code class="docutils literal notranslate"><span class="pre">true</span></code>, the user info will be requested instead if using the <code class="docutils literal notranslate"><span class="pre">id_token</span></code>, default is false.</p>
<section id="oauth2-with-qgis">
<span id="integrator-authentication-oauth2"></span><h4>OAuth2 with QGIS<a class="headerlink" href="#oauth2-with-qgis" title="Link to this heading">¶</a></h4>
<p>In the admin interface create an ‘OAuth2 Client’ with:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Client</span> <span class="pre">ID</span></code> as e.-g. ‘qgis’</p></li>
<li><p>fill the <code class="docutils literal notranslate"><span class="pre">Secret</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Redirect</span> <span class="pre">URI</span></code> as ‘<a class="reference external" href="http://127.0.0.1:7070/">http://127.0.0.1:7070/</a>’</p></li>
</ul>
<p>On QGIS:</p>
<ul class="simple">
<li><p>Add an <code class="docutils literal notranslate"><span class="pre">Authentication</span></code></p></li>
<li><p>Set a <code class="docutils literal notranslate"><span class="pre">Name</span></code></p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">Authentication</span></code> to <code class="docutils literal notranslate"><span class="pre">OAuth2</span></code></p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">Grant</span> <span class="pre">flow</span></code> to <code class="docutils literal notranslate"><span class="pre">Authentication</span> <span class="pre">code</span></code></p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">Request</span> <span class="pre">URL</span></code> to <code class="docutils literal notranslate"><span class="pre">&lt;geomapfish_base_url&gt;/oauth/login</span></code></p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">Token</span> <span class="pre">URL</span></code> to <code class="docutils literal notranslate"><span class="pre">&lt;geomapfish_base_url&gt;/oauth/token</span></code></p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">Client</span> <span class="pre">ID</span></code> to ‘qgis’</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">Client</span> <span class="pre">secret</span></code> to the secret</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For security reason a user can only have one active session per client.</p>
<p>If you need to have more than one active session you should provide more than one client.</p>
</div>
<section id="https">
<h5>HTTPS<a class="headerlink" href="#https" title="Link to this heading">¶</a></h5>
<p>If your application is accessed in HTTPS, you have to make sure that all URLs
generated by the application (CSS and JavaScript files, images, MapServer
requests, etc.) use the HTTPS scheme as well. Otherwise the browser will
prompt “insecure content” warnings.</p>
<p>There are two ways to manage this:</p>
<ul class="simple">
<li><p>application behind a proxy</p></li>
<li><p>application and SSL certificate on the same server</p></li>
</ul>
</section>
</section>
</section>
</section>
<section id="application-behind-a-proxy">
<h2>Application behind a proxy<a class="headerlink" href="#application-behind-a-proxy" title="Link to this heading">¶</a></h2>
<p>If the application is placed behind some proxy that removes the SSL encryption
(plain HTTP is used between the proxy and the server), then some specific
configuration is required both on the c2cgeoportal application and on the
proxy:</p>
<ul class="simple">
<li><p>The proxy should add a specific header to the requests. For example <code class="docutils literal notranslate"><span class="pre">X-Https</span>
<span class="pre">on</span></code> (<code class="docutils literal notranslate"><span class="pre">X-Https</span></code> is the header name, and <code class="docutils literal notranslate"><span class="pre">on</span></code> is the header value).</p></li>
</ul>
<p>In Mako templates, if you need to know what scheme is used, you may test the
value of <code class="docutils literal notranslate"><span class="pre">request.scheme</span></code>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">WMTS_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">%</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span><span class="p">:</span>
    <span class="n">url</span><span class="p">:</span> <span class="s1">&#39;https://my.wmts.server/&#39;</span>
<span class="o">%</span> <span class="k">else</span><span class="p">:</span>
    <span class="n">url</span><span class="p">:</span> <span class="s1">&#39;https://my.wmts.server/&#39;</span>
<span class="o">%</span> <span class="n">endif</span>
<span class="o">/*</span> <span class="o">...</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="application-and-ssl-certificate-on-the-same-server">
<h2>Application and SSL certificate on the same server<a class="headerlink" href="#application-and-ssl-certificate-on-the-same-server" title="Link to this heading">¶</a></h2>
<p>If the SSL certificate and the application are located on the same server, all
requests will be redirected to https. So you should change the scheme to https
for all url except for some cases that should always use http (typically,
all requests to localhost): see <em>url</em> parameter in tilegeneration configuration.</p>
<p>If you apply ssl encryption on your application, you should take care of the
tiles url to use https scheme to avoid mixing secure and insecure contents.</p>
<p>Finally, you should redirect all http requests to https. Depending on your
environment, you may need to request this via your infrastructure support.</p>
<p>In case you load http external resources into your application, you should use
the resourceproxy service as described below.</p>
</section>
<section id="loading-non-https-external-resources">
<h2>Loading non https external resources<a class="headerlink" href="#loading-non-https-external-resources" title="Link to this heading">¶</a></h2>
<p>If you want to load non https external resources in your https application, you
should use the <code class="docutils literal notranslate"><span class="pre">resourceproxy</span></code> service and add the list of hosts you want to access in your project
<cite>vars.yaml</cite> configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">resourceproxy</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># list of urls from which it is safe to load content</span>
<span class="w">    </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">      </span><span class="c1">#exampletargetname: https://www.camptocamp.com/?param1=%s&amp;param2=%s</span>
<span class="w">      </span><span class="nt">rfinfo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://www.rfinfo.vd.ch/rfinfo.php?no_commune=%s&amp;no_immeuble=%s</span>
</pre></div>
</div>
<p>Then you can access resources by building urls using the following schema:
<code class="docutils literal notranslate"><span class="pre">https://&lt;host&gt;/resourceproxy?target=&lt;targetname&gt;&amp;values=(&lt;valueparam1&gt;,...)</span></code>.</p>
<p>For example:</p>
<p><code class="docutils literal notranslate"><span class="pre">https://geoportail.camptocamp.com/main/resourceproxy?target=rfinfo&amp;values=(175,2633)</span></code></p>
</section>
<section id="local-certificate-checks">
<h2>Local certificate checks<a class="headerlink" href="#local-certificate-checks" title="Link to this heading">¶</a></h2>
<p>Certain c2cgeoportal features open a http session to your c2cgeoportal services,
for example the <code class="docutils literal notranslate"><span class="pre">checker</span></code> or the <code class="docutils literal notranslate"><span class="pre">lingva_extractor</span></code>.
If you are running your server in https and wish to disable certificate checks in these
connections, you can achieve this by adding the following configuration element to your <code class="docutils literal notranslate"><span class="pre">vars</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">http_options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
</pre></div>
</div>
<p>See other options in parameters of
<a class="reference external" href="https://docs.python-requests.org/en/latest/api.html#requests.Request">requests.Request</a></p>
</section>
<section id="reset-password">
<h2>Reset password<a class="headerlink" href="#reset-password" title="Link to this heading">¶</a></h2>
<p>When a user has forgotten his/her password, a new one may be sent by email if some additional
GeoMapFish configuration is provided.</p>
<p>To ensure such an e-mail can be generated, you should add the following configuration
in the <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># SMTP configuration could be already there if needed by other feature</span>
<span class="nt">smtp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">smtp.example.com:465</span>
<span class="w">    </span><span class="nt">ssl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;username&gt;</span>
<span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;password&gt;</span>
<span class="w">    </span><span class="nt">starttls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="nt">reset_password</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Used to send a confirmation email</span>
<span class="w">    </span><span class="nt">email_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">info@camptocamp.com</span>
<span class="w">    </span><span class="nt">email_subject</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">New password generated for GeoMapFish</span>
<span class="w">    </span><span class="nt">email_body</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">Hello {user},</span>

<span class="w">        </span><span class="no">You have asked for a new password,</span>
<span class="w">        </span><span class="no">the newly generated password is: {password}</span>

<span class="w">        </span><span class="no">Sincerely yours</span>
<span class="w">        </span><span class="no">The GeoMapFish team</span>
</pre></div>
</div>
<p>If the SMTP host ends with a colon (<cite>:</cite>) followed by a number, and
there is no port specified, that suffix will be stripped off and the
number interpreted as the port number to use.</p>
<p>Replace the <code class="docutils literal notranslate"><span class="pre">smtp.example.com</span></code> value by a working SMTP server name.</p>
</section>
<section id="security-update">
<h2>Security update<a class="headerlink" href="#security-update" title="Link to this heading">¶</a></h2>
<p>To be sure that we regularly get the security updates, every night the GeoMapFish Docker images are rebuild.
And every time we do a build we pull the new images to use them.</p>
<p>For project on Kubernetes we also deploy fresh built images every day.</p>
<p>This is good for security but with that we can’t guarantee that the result of a new build works exactly
as the previous one.</p>
<p>To avoid incidents on production service, Kubernetes will publish a service only if he start correctly.
For Project on Docker Compose we have to choose ourself. The best is to build the image only on
integration when the result is correct we push it on a repository, and on production we will use the
images from the repository. The other solution is to use fixed tag for the base image, this imply that we
should do a minor update of the application to get the security fix. To do that you should set
in the <code class="docutils literal notranslate"><span class="pre">project.yaml</span></code> file the template parameter <code class="docutils literal notranslate"><span class="pre">unsafe_long_version</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> in the
<code class="docutils literal notranslate"><span class="pre">template_vars</span></code> section.</p>
</section>
<section id="access-to-wms-getcapability">
<h2>Access to WMS GetCapability<a class="headerlink" href="#access-to-wms-getcapability" title="Link to this heading">¶</a></h2>
<p>Set <code class="docutils literal notranslate"><span class="pre">hide_capabilities</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in your <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> to disable
the WMS GetCapability when accessing the MapServer proxy (mapserverproxy).</p>
<p>Default: <code class="docutils literal notranslate"><span class="pre">false</span></code></p>
</section>
<section id="access-to-the-admin-interface">
<h2>Access to the admin interface<a class="headerlink" href="#access-to-the-admin-interface" title="Link to this heading">¶</a></h2>
<p>To disable the admin interface, set <code class="docutils literal notranslate"><span class="pre">enable_admin_interface</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> in your <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file.</p>
<p>Default: <code class="docutils literal notranslate"><span class="pre">true</span></code></p>
</section>
<section id="access-to-services-by-external-servers">
<h2>Access to services by external servers<a class="headerlink" href="#access-to-services-by-external-servers" title="Link to this heading">¶</a></h2>
<p>By default, only localhost can access c2cgeoportal’s services.
To permit access to a specific service by an external server, you must set CORS headers (<code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Origin</span></code>)
in your <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file.</p>
<p>Add or modify the structure as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">headers</span><span class="p">:</span>
<span class="w">    </span><span class="nt">&lt;service_name&gt;</span><span class="p">:</span>
<span class="w">        </span><span class="nt">access_control_allow_origin</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&lt;domain1&gt;&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;&lt;domain2&gt;&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">...</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">access_control_max_age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3600</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code> can be included in <code class="docutils literal notranslate"><span class="pre">access_control_allow_origin</span></code> to allow everybody to
access, but no credentials will be passed in this case.</p>
<p>Available services are:</p>
<p>Entry:</p>
<ul class="simple">
<li><p>index</p></li>
<li><p>config</p></li>
<li><p>api</p></li>
</ul>
<p>Services:</p>
<ul class="simple">
<li><p>themes</p></li>
<li><p>login</p></li>
<li><p>mapserver</p></li>
<li><p>print</p></li>
<li><p>profile</p></li>
<li><p>raster</p></li>
<li><p>layers</p></li>
<li><p>login</p></li>
<li><p>error</p></li>
</ul>
</section>
<section id="authorized-referrers">
<h2>Authorized referrers<a class="headerlink" href="#authorized-referrers" title="Link to this heading">¶</a></h2>
<p>To mitigate <a class="reference external" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a>
attacks, the server validates the referrer against a list of authorized referrers.</p>
<p>By default, only the requests coming from the server are allowed. You can change that list by adding an <code class="docutils literal notranslate"><span class="pre">vars.authorized_referers</span></code>
list in your <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file.</p>
<p>This solution is not the most secure (some people have browser extensions that reset the referrer),
but that is the most consistent approach with regard to the different JS frameworks.</p>
</section>
<section id="allowed-hosts">
<h2>Allowed hosts<a class="headerlink" href="#allowed-hosts" title="Link to this heading">¶</a></h2>
<p>For security reason we check the host of the request, to be sure that the request is coming from an authorized domain.</p>
<p>For that we have the following configurations in the <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file:</p>
<ul class="simple">
<li><p><cite>vars.authentication.allowed_hosts</cite>: List of hosts that are allowed to access the oauth2 authentication service (same host allowed).</p></li>
<li><p><cite>vars.shortener.allowed_hosts</cite>: List of hosts that are allowed to be shortened (same host allowed).</p></li>
<li><p><cite>vars.admin_interface.allowed_hosts</cite>: List of host that are allowed to be redirected by the ogc_server_clear_cache (same host allowed).</p></li>
<li><p><cite>vars.allowed_hosts</cite>: List of hosts that are allowed to access the application (theme and dynamic.json).</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo of c2cgeoportal"/>
            </a></p>
<h1 class="logo"><a href="../index.html">c2cgeoportal</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=camptocamp&repo=c2cgeoportal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../administrator/index.html">Administrator Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Integrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
      <li>Previous: <a href="customize.html" title="previous chapter">Customize the application</a></li>
      <li>Next: <a href="features.html" title="next chapter">Additional features</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2011-2024, Camptocamp.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/integrator/security.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>