
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>TileGeneration &#8212; c2cgeoportal  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/c2c.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Adding a new user interface" href="ngeo_new_interface.html" />
    <link rel="prev" title="Configure short URL" href="shortener.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="tilegeneration">
<span id="administrator-tilegeneration"></span><h1>TileGeneration<a class="headerlink" href="#tilegeneration" title="Permalink to this headline">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>With this solution, we solve the following issues:</p>
<ul class="simple">
<li><p>Managing millions of files on the file system is difficult.</p></li>
<li><p>We should be able to update all the generated tiles.</p></li>
<li><p>We should not have thousands of expired files.</p></li>
</ul>
<p>To do so, we need need a tool that can generate the tiles,
update some of them contained in given geometries and delete empty tiles.</p>
<p>On-the-fly tiles generation introduces some issues such as having a growing
number of tiles that may become unmanageable. For example, when updating the
data, it is not possible to figure out what tiles should be updated.</p>
<p>For high usage websites, we want to put the tiles on S3 with the same tool.</p>
<p>One issue we have if we want to generate all the tiles is that the generation time can grow to more than one
month, especially if we have a high resolution (low if in m/px) on the last zoom level.
Therefore for the last zoom level we should generate the tiles on the fly
with a low expiry (4 hours for example).
We should use metatiles to reduce the number of requests to postgres.
And the tiles should be deleted after the expiry time.</p>
<p>The chosen solution is a combination of two tools:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/camptocamp/tilecloud-chain">TileCloud-Chain</a> for the tile generation.</p></li>
</ul>
</section>
<section id="id1">
<h2>TileCloud-chain<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>TileCloud-chain is a TileCloud-based tool that offers a build chain for
generating tiles from WMS of Mapnik on a local storage or S3 using a
WMTS layout.</p>
<p>It supports the following AWS services for generating tiles:
EC2, SQS, SNS.</p>
<p>See the <a class="reference external" href="https://pypi.python.org/pypi/tilecloud-chain">readme</a>.</p>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>The configuration is done in the file <code class="docutils literal notranslate"><span class="pre">tilegeneration/config.yaml.tmpl</span></code>.</p>
<p>The main thing to do is to:</p>
<ul>
<li><p>Set the resolutions we want to generate in the <code class="docutils literal notranslate"><span class="pre">grids</span></code>.
If we want to generate different resolutions per layer, we should create different grids.
Sub-level of <code class="docutils literal notranslate"><span class="pre">grids</span></code> is the grid name.</p></li>
<li><p>Configure the <code class="docutils literal notranslate"><span class="pre">caches</span></code> and set the <code class="docutils literal notranslate"><span class="pre">generation</span></code>/<code class="docutils literal notranslate"><span class="pre">default_cache</span></code>.
Sub-level of <code class="docutils literal notranslate"><span class="pre">caches</span></code> is the cache name.</p></li>
<li><p>Configure the <code class="docutils literal notranslate"><span class="pre">layer_default</span></code>, the <code class="docutils literal notranslate"><span class="pre">layers</span></code>, and the <code class="docutils literal notranslate"><span class="pre">generation</span></code>/<code class="docutils literal notranslate"><span class="pre">default_layers</span></code>.
Sub-level of <code class="docutils literal notranslate"><span class="pre">layers</span></code> is the layer name.</p></li>
<li><p>We can drop the empty tiles with a hash comparison, tilecloud-chain has a tool to help us:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">docker-compose <span class="nb">exec</span> tilecloudchain generate_tiles <span class="si">${</span><span class="s1">&#39;\\&#39;</span><span class="si">}</span></span>
<span class="prompt1">   --get-hash &lt;max-zoom&gt;/0/0 --layer &lt;layer&gt;</span>
</pre></div></div><p>We consider that the first tile of the max zoom is empty.
Then copy-paste the result in the layer config.</p>
</li>
</ul>
<p>If you generate the tiles locally, you do not need all the configuration variables, because many of them
in the <code class="docutils literal notranslate"><span class="pre">generation</span></code> part are for AWS generation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Points to check with TileCloud chain:</p>
<ul class="simple">
<li><p>Disabling metatiles should be avoided.</p></li>
<li><p>Make sure that <code class="docutils literal notranslate"><span class="pre">empty_metatile_detection</span></code> and <code class="docutils literal notranslate"><span class="pre">empty_tile_detection</span></code> are configured correctly.</p></li>
<li><p>Make sure to not generate tiles with a resolution higher than the one in the raster sources.</p></li>
</ul>
</div>
</section>
<section id="tile-generation-and-management">
<h3>Tile Generation and management<a class="headerlink" href="#tile-generation-and-management" title="Permalink to this headline">¶</a></h3>
<p>This package offers two tools, one to generate the tiles locally, see help:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose <span class="nb">exec</span> tilecloudchain generate_tiles --help</span>
</pre></div></div><p>one to generate the tiles using AWS, see help:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose <span class="nb">exec</span> tilecloudchain generate_controller --help</span>
</pre></div></div><p>Before starting a tile generation on S3, measure the cost:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose <span class="nb">exec</span> tilecloudchain generate_controller --cost</span>
</pre></div></div><p>If you setup all the default options, you can generate the tiles by using the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose <span class="nb">exec</span> tilecloudchain generate_tiles</span>
</pre></div></div></section>
<section id="aws-credentials">
<h3>AWS credentials<a class="headerlink" href="#aws-credentials" title="Permalink to this headline">¶</a></h3>
<p>To be able to connect to the S3 service, you should define the following variables in the <code class="docutils literal notranslate"><span class="pre">env.project</span></code>
file:</p>
<p>code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AWS_ACCESS_KEY_ID</span><span class="o">=&lt;</span><span class="n">access_key_id</span><span class="o">&gt;</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span><span class="o">=&lt;</span><span class="n">secret_access_key</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>If you do not want to commit these credentials you can add them in your <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> file:</p>
<p>code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">AWS_ACCESS_KEY_ID</span><span class="o">=&lt;</span><span class="n">access_key_id</span><span class="o">&gt;</span>
<span class="n">export</span> <span class="n">AWS_SECRET_ACCESS_KEY</span><span class="o">=&lt;</span><span class="n">secret_access_key</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="web-interface">
<h3>Web Interface<a class="headerlink" href="#web-interface" title="Permalink to this headline">¶</a></h3>
<p>It is possible to run tile generation commands through a web interface located at URL
<code class="docutils literal notranslate"><span class="pre">&lt;application</span> <span class="pre">main</span> <span class="pre">URL&gt;/tiles/admin/</span></code>. This interface is protected by a password that
must be specified in the <code class="docutils literal notranslate"><span class="pre">C2C_SECRET</span></code> environment variable in the <code class="docutils literal notranslate"><span class="pre">env.project</span></code> file.</p>
<p>Predefined commands may be set in parameter <code class="docutils literal notranslate"><span class="pre">server</span> <span class="pre">&gt;</span> <span class="pre">predefined_commands</span></code> in the
<code class="docutils literal notranslate"><span class="pre">tilegeneration/config.yaml.tmpl</span></code> file.</p>
</section>
<section id="see-also">
<h3>See also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#integrator-api"><span class="std std-ref">JavaScript API</span></a></p></li>
<li><p><a class="reference internal" href="../administrator/mapfile.html#administrator-mapfile-perepare-raster"><span class="std std-ref">Prepare raster files</span></a></p></li>
</ul>
</section>
<section id="upstream-documentation">
<h3>Upstream documentation<a class="headerlink" href="#upstream-documentation" title="Permalink to this headline">¶</a></h3>
</section>
</section>
<section id="configure">
<h2>Configure<a class="headerlink" href="#configure" title="Permalink to this headline">¶</a></h2>
<section id="configure-grids">
<h3>Configure grids<a class="headerlink" href="#configure-grids" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">grid</span></code> describes how the tiles are arranged.</p>
<p>Especially on <code class="docutils literal notranslate"><span class="pre">s3</span></code> be careful to choose every of the grid settings before generating the tiles. If you
change one of them you must regenerate all the tiles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">resolutions</span></code> in [px/m] describes all the resolutions available for this layer. For a raster layer, have
a look to the maximum resolution of the source files. It is not needed to generate tiles at smaller
resolutions than the sources, it is preferable to use the OpenLayers client zoom. Note that you can add a
resolution in the end without regenerating all the tiles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bbox</span></code> should match the resolution of the extent. <strong>CAREFUL: you will have big issue if you use this
parameter to generate the tile on a restricted area</strong>: use the <code class="docutils literal notranslate"><span class="pre">bbox</span></code> on the layer instead.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">srs</span></code> specifies the code of the projection.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">unit</span></code> is the unit used by the projection.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tile_size</span></code> is the tile size in [px], defaults to 256.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">matrix_identifier</span></code> is <code class="docutils literal notranslate"><span class="pre">zoom</span></code> by default and can also be set to <code class="docutils literal notranslate"><span class="pre">resolution</span></code>. It specifies how the z
index is build to store the tiles, for example, for the resolutions <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">1,</span> <span class="pre">0.5]</span></code> the used values are
<code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1,</span> <span class="pre">2]</span></code> based on the zoom and <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">1,</span> <span class="pre">0_5]</span></code> based on the resolution. The second has the advantage of
allowing to add a new resolution without regenerating all the tiles, but it does not work with MapCache.</p>
</section>
<section id="configure-caches">
<h3>Configure caches<a class="headerlink" href="#configure-caches" title="Permalink to this headline">¶</a></h3>
<p>The available tile caches are: <code class="docutils literal notranslate"><span class="pre">s3</span></code>, <code class="docutils literal notranslate"><span class="pre">bsddb</span></code>, <code class="docutils literal notranslate"><span class="pre">mbtile</span></code> and <code class="docutils literal notranslate"><span class="pre">filesystem</span></code>.</p>
<p>The best solution to store the tiles, <code class="docutils literal notranslate"><span class="pre">s3</span></code>, <code class="docutils literal notranslate"><span class="pre">mbtiles</span></code> and <code class="docutils literal notranslate"><span class="pre">bsddb</span></code>, have the advantage of using only one
file per layer - style dimensions. To serve the <code class="docutils literal notranslate"><span class="pre">mbtile</span></code> and the <code class="docutils literal notranslate"><span class="pre">bsddb</span></code> see Distribute the tiles.</p>
<p><code class="docutils literal notranslate"><span class="pre">s3</span></code> needs a <code class="docutils literal notranslate"><span class="pre">bucket</span></code> and a <code class="docutils literal notranslate"><span class="pre">folder</span></code> (defaults to ‘’).</p>
<p><code class="docutils literal notranslate"><span class="pre">mbtiles</span></code>, <code class="docutils literal notranslate"><span class="pre">bsddb</span></code> and <code class="docutils literal notranslate"><span class="pre">filesystem</span></code> just need a <code class="docutils literal notranslate"><span class="pre">folder</span></code>.</p>
<p>On all the caches we can add some information to generate the URL where the tiles are available. This is
needed to generate the capabilities. We can specify:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">http_url</span></code> direct url to the tiles root.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">http_urls</span></code> (array) urls to the tiles root.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">http_url</span></code> and <code class="docutils literal notranslate"><span class="pre">hosts</span></code> (array), where each value of <code class="docutils literal notranslate"><span class="pre">hosts</span></code> is used to replace <code class="docutils literal notranslate"><span class="pre">%(host)s</span></code> in
<code class="docutils literal notranslate"><span class="pre">http_url</span></code>.</p></li>
</ul>
<p>In all case <code class="docutils literal notranslate"><span class="pre">http_url</span></code> or <code class="docutils literal notranslate"><span class="pre">http_urls</span></code> can include all attributes of this cache as <code class="docutils literal notranslate"><span class="pre">%(attribute)s</span></code>.</p>
<section id="mbtiles-vs-berkeley-db-bsddb">
<h4>MBTiles vs Berkeley DB (<code class="docutils literal notranslate"><span class="pre">bsddb</span></code>)<a class="headerlink" href="#mbtiles-vs-berkeley-db-bsddb" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Read performance: similar, eventually the MBTiles is 10% faster.</p></li>
<li><p>Write performance: The Berkeley DB is largely faster, about 10 times.</p></li>
<li><p>List the tiles: the MBTiles is largely faster, but we usually don’t need it.</p></li>
</ul>
</section>
</section>
<section id="configure-layers">
<h3>Configure layers<a class="headerlink" href="#configure-layers" title="Permalink to this headline">¶</a></h3>
<p>First, all the attributes in <code class="docutils literal notranslate"><span class="pre">layer_default</span></code> are copied in all the layers to define the default values.</p>
<p>We have two <code class="docutils literal notranslate"><span class="pre">type</span></code> of layer: <code class="docutils literal notranslate"><span class="pre">wms</span></code> or <code class="docutils literal notranslate"><span class="pre">mapnik</span></code>.</p>
<p>To start the common attributes are:</p>
<p><code class="docutils literal notranslate"><span class="pre">min_resolution_seed</span></code> the minimum resolution that is seeded, other resolutions are served by MapCache.</p>
<p><code class="docutils literal notranslate"><span class="pre">bbox</span></code> used to limit the tiles generation.</p>
<p><code class="docutils literal notranslate"><span class="pre">px_buffer</span></code> a buffer in px around the object area (geoms or extent).</p>
<section id="wmts-layout">
<h4>WMTS layout<a class="headerlink" href="#wmts-layout" title="Permalink to this headline">¶</a></h4>
<p>To generate the file paths and the WMTS capabilities we need additional information:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">mime_type</span></code> of the tiles, it’s also used by the WMS GetMap and to upload the tiles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">wmts_style</span></code> defaults to ‘default’.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">extension</span></code> is used to end the filename.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">dimensions</span></code> (defaults to []) is an array of objects that have a <code class="docutils literal notranslate"><span class="pre">name</span></code>, a <code class="docutils literal notranslate"><span class="pre">default</span></code> value specified
in the capabilities, a <code class="docutils literal notranslate"><span class="pre">value</span></code> to generate the tiles (it can be overwritten by an argument), and an array of
<code class="docutils literal notranslate"><span class="pre">values</span></code> that contains all the possible values available in the capabilities.</p>
<p>For example if you generate the tiles and capabilities with the following configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dimensions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span>   <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DATE</span>
        <span class="nt">default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2012</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2012</span>
        <span class="nt">values</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2012</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>then with the following configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dimensions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span>   <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DATE</span>
        <span class="nt">default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2012</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2013</span>
        <span class="nt">values</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2012</span><span class="p p-Indicator">,</span> <span class="nv">2013</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>We will have two set of tiles <code class="docutils literal notranslate"><span class="pre">2012</span></code> and <code class="docutils literal notranslate"><span class="pre">2013</span></code>, both accessible by the capabilities, and by default we
will see the first set of tiles.</p>
</section>
<section id="meta-tiles">
<h4>Meta tiles<a class="headerlink" href="#meta-tiles" title="Permalink to this headline">¶</a></h4>
<p>The meta tiles are activated by setting <code class="docutils literal notranslate"><span class="pre">meta</span></code> to <code class="docutils literal notranslate"><span class="pre">on</span></code> (by default it’s <code class="docutils literal notranslate"><span class="pre">off</span></code>).</p>
<p>The meta tiles are used for two things: first to generate multiple tiles with only one WMS query. By setting
<code class="docutils literal notranslate"><span class="pre">meta_size</span></code> to 8 we will generate a square of 8 by 8 tiles in one shot.</p>
<p>The second usage of meta tiles is prevent cut label names: this is solved by getting a bigger image and cutting
the borders. The <code class="docutils literal notranslate"><span class="pre">meta_buffer</span></code> should be set to a bigger value than half the size of the longest label.</p>
</section>
<section id="configure-hash">
<h4>Configure hash<a class="headerlink" href="#configure-hash" title="Permalink to this headline">¶</a></h4>
<p>We can filter tiles and meta tiles by using an hash.</p>
<p>The configuration of this hash is in the layer like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">empty_metatile_detection</span><span class="p">:</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">740</span>
    <span class="nt">hash</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3237839c217b51b8a9644d596982f342f8041546</span>
<span class="nt">empty_tile_detection</span><span class="p">:</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">921</span>
    <span class="nt">hash</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1e3da153be87a493c4c71198366485f290cad43c</span>
</pre></div>
</div>
<p>To easily generate this configuration we can use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">generate</span><span class="o">-</span><span class="n">tiles</span> <span class="o">--</span><span class="n">get</span><span class="o">-</span><span class="nb">hash</span> <span class="o">&lt;</span><span class="n">z</span><span class="o">/</span><span class="n">x</span><span class="o">/</span><span class="n">y</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">l</span> <span class="o">&lt;</span><span class="n">layer_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">&lt;z/x/y&gt;</span></code> should refer to an empty tile/metatile. Generally it’s a good idea to use z as the maximum
zoom, x and y as 0.</p>
</section>
<section id="configure-geom-sql">
<h4>Configure geom/sql<a class="headerlink" href="#configure-geom-sql" title="Permalink to this headline">¶</a></h4>
<p>We can generate the tiles only on some geometries stored in PostGis.</p>
<p>The configuration is in the layer like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">geoms</span><span class="p">:</span>
<span class="p p-Indicator">-</span>   <span class="nt">connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user=www-data password=www-data dbname=&lt;db&gt; host=localhost</span>
    <span class="nt">sql</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;column&gt; AS geom FROM &lt;table&gt;</span>
    <span class="nt">min_resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;resolution&gt;</span> <span class="c1"># included, optional, last win</span>
    <span class="nt">max_resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;resolution&gt;</span> <span class="c1"># included, optional, last win</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">geoms</span><span class="p">:</span>
<span class="p p-Indicator">-</span>   <span class="nt">connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user=postgres password=postgres dbname=tests host=localhost</span>
    <span class="nt">sql</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">the_geom AS geom FROM tests.polygon</span>
<span class="p p-Indicator">-</span>   <span class="nt">connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user=postgres password=postgres dbname=tests host=localhost</span>
    <span class="nt">sql</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">the_geom AS geom FROM tests.point</span>
    <span class="nt">min_resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="nt">max_resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span>
</pre></div>
</div>
<p>It’s preferable to use simple geometries, too complex geometries can slow down the generation.</p>
</section>
<section id="legends">
<h4>Legends<a class="headerlink" href="#legends" title="Permalink to this headline">¶</a></h4>
<p>To be able to generate legends with <code class="docutils literal notranslate"><span class="pre">generate-controller</span> <span class="pre">--generate-legend-images</span></code> you should have
<code class="docutils literal notranslate"><span class="pre">legend_mime</span></code> and <code class="docutils literal notranslate"><span class="pre">legend_extension</span></code> in the layer configuration.</p>
<p>for example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">legend_mime</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">image/png</span>
<span class="nt">legend_extension</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">png</span>
</pre></div>
</div>
<p>Then it will create a legend image per layer and per zoom level named
<code class="docutils literal notranslate"><span class="pre">.../1.0.0/{{layer}}/{{wmts_style}}/legend{{zoom}}.{{legend_extension}}</span></code> only if she is different from the
previous zoom level. If we have only one legend image it still stores in the file named
<code class="docutils literal notranslate"><span class="pre">legend0.{{legend_extension}}</span></code>.</p>
<p>When we do <code class="docutils literal notranslate"><span class="pre">generate-controller</span> <span class="pre">--generate-wmts-capabilities</span></code> we will at first parse the legend images to
generate a layer configuration like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">legends</span><span class="p">:</span>
<span class="p p-Indicator">-</span>   <span class="nt">mime_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">image/png</span>
    <span class="nt">href</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://host/tiles/layer/style/legend0.png</span>
    <span class="nt">min_resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">500</span> <span class="c1"># optional, [m/px]</span>
    <span class="nt">max_resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2000</span> <span class="c1"># optional, [m/px]</span>
    <span class="nt">min_scale</span><span class="p">:</span> <span class="c1"># if define overwrite the min_resolution [m/m]</span>
    <span class="nt">max_scale</span><span class="p">:</span> <span class="c1"># if define overwrite the max_resolution [m/m]</span>
</pre></div>
</div>
<p>If you define a legends array in the layer configuration it is directly used to generate the capabilities.</p>
</section>
<section id="wms-layers">
<h4>WMS layers<a class="headerlink" href="#wms-layers" title="Permalink to this headline">¶</a></h4>
<p>The additional value needed by the WMS is the URL of the server and the <code class="docutils literal notranslate"><span class="pre">layers</span></code>.</p>
<p>The previously defined <code class="docutils literal notranslate"><span class="pre">mime_type</span></code> is also used in the WMS requests.</p>
<p>To customize the request you also have the attributes <code class="docutils literal notranslate"><span class="pre">params</span></code>, <code class="docutils literal notranslate"><span class="pre">headers</span></code> and <code class="docutils literal notranslate"><span class="pre">generate_salt</span></code>. In
<code class="docutils literal notranslate"><span class="pre">params</span></code> you can specify additional parameter of the WMS request, in <code class="docutils literal notranslate"><span class="pre">headers</span></code> you can modify the request
headers. In <code class="docutils literal notranslate"><span class="pre">version</span></code>, you can change the WMS version. See the Proxy/cache issue for additional information.</p>
</section>
<section id="mapnik-layers">
<h4>Mapnik layers<a class="headerlink" href="#mapnik-layers" title="Permalink to this headline">¶</a></h4>
<p>We need to specify the <code class="docutils literal notranslate"><span class="pre">mapfile</span></code> path.</p>
<p>With Mapnik we have the possibility to specify a <code class="docutils literal notranslate"><span class="pre">data_buffer</span></code> then we should set the unneeded
<code class="docutils literal notranslate"><span class="pre">meta_buffer</span></code> to 0.</p>
<p>And the <code class="docutils literal notranslate"><span class="pre">output_format</span></code> used for the Mapnik renderer, can be <code class="docutils literal notranslate"><span class="pre">png</span></code>, <code class="docutils literal notranslate"><span class="pre">png256</span></code>, <code class="docutils literal notranslate"><span class="pre">jpeg</span></code>, <code class="docutils literal notranslate"><span class="pre">grid</span></code>
(grid_renderer).</p>
<section id="mapnik-grid-layers">
<h5>Mapnik grid layers<a class="headerlink" href="#mapnik-grid-layers" title="Permalink to this headline">¶</a></h5>
<p>With Mapnik we can generate UTFGrid tiles (JSON format that describes the tiles present on a corresponding
tile) by using the <code class="docutils literal notranslate"><span class="pre">output_format</span></code> ‘grid’, see also:
<a class="reference external" href="https://github.com/mapnik/mapnik/wiki/MapnikRenderers#grid_renderer">https://github.com/mapnik/mapnik/wiki/MapnikRenderers#grid_renderer</a>.</p>
<p>Specific configuration:</p>
<p>We have a specific way to <code class="docutils literal notranslate"><span class="pre">drop_empty_utfgrid</span></code> by using the <code class="docutils literal notranslate"><span class="pre">on</span></code> value.</p>
<p>We should specify the pseudo pixel size [px] with the <code class="docutils literal notranslate"><span class="pre">resolution</span></code>.</p>
<p>And the <code class="docutils literal notranslate"><span class="pre">layers_fields</span></code> that we want to get the attributes. Object with the layer name as key and the values
in an array as value.</p>
<p>In fact the Mapnik documentation says that’s working only for one layer.</p>
<p>And don’t forget to change the <code class="docutils literal notranslate"><span class="pre">extension</span></code> to <code class="docutils literal notranslate"><span class="pre">json</span></code>, and the <code class="docutils literal notranslate"><span class="pre">mime_type</span></code> to <code class="docutils literal notranslate"><span class="pre">application/utfgrid</span></code> and
the <code class="docutils literal notranslate"><span class="pre">meta</span></code> to <code class="docutils literal notranslate"><span class="pre">off</span></code> (not supported).</p>
<p>Configuration example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">grid</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mapnik</span>
    <span class="nt">mapfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">style.mapnik</span>
    <span class="nt">output_format</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">grid</span>
    <span class="nt">extension</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">json</span>
    <span class="nt">mime_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">application/utfgrid</span>
    <span class="nt">drop_empty_utfgrid</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">on</span>
    <span class="nt">resolution</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
    <span class="nt">meta</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">off</span>
    <span class="nt">data_buffer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">128</span>
    <span class="nt">layers_fields</span><span class="p">:</span>
        <span class="nt">buildings</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">name</span><span class="p p-Indicator">,</span> <span class="nv">street</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="process">
<h3>Process<a class="headerlink" href="#process" title="Permalink to this headline">¶</a></h3>
<p>We can configure some tile commands to process the tiles. They can be automatically be called in the tile
generation it we set the property <code class="docutils literal notranslate"><span class="pre">post_process</span></code> or <code class="docutils literal notranslate"><span class="pre">pre_hash_post_process</span></code> in the layer configuration.</p>
<p>The process is a set of names processes, and each one has a list of commands declared like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">process</span><span class="p">:</span>  <span class="c1"># root process config</span>
    <span class="nt">optipng</span><span class="p">:</span>  <span class="c1"># the process command</span>
    <span class="p p-Indicator">-</span>   <span class="nt">cmd</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">optipng %(args)s -q -zc9 -zm8 -zs3 -f5 -o %(out)s %(in)s</span>  <span class="c1"># the command line</span>
        <span class="nt">need_out</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>  <span class="c1"># if false the command rewrite the input file, default to false</span>
        <span class="nt">arg</span><span class="p">:</span>  <span class="c1"># argument used with the different log switches, all default to &#39;&#39;</span>
            <span class="nt">default</span><span class="p">:</span> <span class="s">&#39;-q&#39;</span> <span class="c1"># the argument used by default</span>
            <span class="nt">quiet</span><span class="p">:</span> <span class="s">&#39;-q&#39;</span> <span class="c1"># the argument used in quiet mode</span>
            <span class="nt">verbose</span><span class="p">:</span> <span class="s">&#39;-v&#39;</span> <span class="c1"># the argument used in verbose mode</span>
            <span class="nt">debug</span><span class="p">:</span> <span class="s">&#39;-log</span><span class="nv"> </span><span class="s">/tmp/optipng.log&#39;</span> <span class="c1"># the argument user in debug mode</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cmd</span></code> can have the following optional argument:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">args</span></code> the argument configured in the arg section.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">in</span></code>, <code class="docutils literal notranslate"><span class="pre">out</span></code> the input and output files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code> the tile coordinates.</p></li>
</ul>
</section>
<section id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h3>
<p>Tile logs can be saved to a PostgreSQL database with this configuration:</p>
<p>..code:: yaml</p>
<blockquote>
<div><dl class="simple">
<dt>logging:</dt><dd><dl class="simple">
<dt>database:</dt><dd><p>dbname: my_db
host: db
port: 5432
table: tilecloud_logs</p>
</dd>
</dl>
</dd>
</dl>
<p>PostgreSQL authentication can be specified with the <code class="docutils literal notranslate"><span class="pre">PGUSER</span></code> and <code class="docutils literal notranslate"><span class="pre">PGPASSWORD</span></code> environment variables.
If the database is not reachable, the process will wait until it is.</p>
</div></blockquote>
</section>
<section id="configure-apache-deprecated">
<h3>Configure Apache (deprecated)<a class="headerlink" href="#configure-apache-deprecated" title="Permalink to this headline">¶</a></h3>
<p>To generate the Apache configuration we use the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller --generate-apache-config</span>
</pre></div></div><p>The Apache configuration look like this (default values):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apache</span><span class="p">:</span>
    <span class="c1"># Generated file</span>
    <span class="nt">config_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apache/tiles.conf</span>
    <span class="c1"># Serve tiles location, default is /tiles</span>
    <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/${instanceid}/tiles</span>
    <span class="c1"># Expires header in hours</span>
    <span class="nt">expires</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>

    <span class="c1"># Headers added to the responses</span>
    <span class="nt">headers</span><span class="p">:</span>
        <span class="nt">Cache-Control</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">max-age=864000, public</span>
</pre></div>
</div>
<p>If we use a proxy to access to the tiles we can specify a different URL to access to the tiles by adding the
parameter <code class="docutils literal notranslate"><span class="pre">tiles_url</span></code> in the cache.</p>
</section>
<section id="configure-mapcache-deprecated">
<h3>Configure MapCache (deprecated)<a class="headerlink" href="#configure-mapcache-deprecated" title="Permalink to this headline">¶</a></h3>
<p>For the last zoom levels we can use MapCache.</p>
<p>To select the levels we switch from pre-generate the tiles to generate tiles on run-time by using MapCache
<code class="docutils literal notranslate"><span class="pre">min_resolution_seed</span></code> in the layer configuration.</p>
<p>The MapCache configuration look like this (default values):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mapcache</span><span class="p">:</span>
    <span class="c1"># The generated file</span>
    <span class="nt">config_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apache/mapcache.xml</span>
    <span class="c1"># The memcache host</span>
    <span class="nt">memcache_host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
    <span class="c1"># The memcache port</span>
    <span class="nt">memcache_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">11211</span>
    <span class="c1"># The mapcache location, default is /mapcache</span>
    <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/${instanceid}/mapcache</span>
</pre></div>
</div>
<p>To generate the MapCache configuration we use the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller --generate-mapcache-config</span>
</pre></div></div></section>
<section id="tiles-error-file">
<h3>Tiles error file<a class="headerlink" href="#tiles-error-file" title="Permalink to this headline">¶</a></h3>
<p>If we set a file path in configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">generation</span><span class="p">:</span>
    <span class="nt">error_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;path&gt;</span>
</pre></div>
</div>
<p>The tiles that’s in error will be append to the file, ant the tiles can be regenerated with
<code class="docutils literal notranslate"><span class="pre">generate-tiles</span> <span class="pre">--layer</span> <span class="pre">&lt;layer&gt;</span> <span class="pre">--tiles</span> <span class="pre">&lt;path&gt;</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;path&gt;</span></code> can be <code class="docutils literal notranslate"><span class="pre">/tmp/error_{layer}_{datetime:%Y-%m-%d_%H:%M:%S}</span></code> to have one file per layer and per
run.</p>
<p>The tiles file looks like:</p>
<p><code class="docutils literal notranslate"><span class="pre">{.sourceCode</span> <span class="pre">.}</span> <span class="pre">#</span> <span class="pre">[time]</span> <span class="pre">some</span> <span class="pre">comments</span> <span class="pre">z/x/y</span> <span class="pre">#</span> <span class="pre">[time]</span> <span class="pre">the</span> <span class="pre">error</span> <span class="pre">z/x/y:+m/+m</span> <span class="pre">#</span> <span class="pre">[time]</span> <span class="pre">the</span> <span class="pre">error</span></code></p>
<p>The first line is just a comment, the second, is for an error on a tile, and the third is for an error on a
meta tile.</p>
</section>
<section id="proxy-cache-issue">
<h3>Proxy/cache issue<a class="headerlink" href="#proxy-cache-issue" title="Permalink to this headline">¶</a></h3>
<p>In general we shouldn’t generate tiles throw a proxy, to do that you should configure the layers as this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">layers_name</span><span class="p">:</span>
    <span class="nt">url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://localhost/wms</span>
    <span class="nt">headers</span><span class="p">:</span>
        <span class="nt">Host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">the_host_name</span>
</pre></div>
</div>
<p>The idea is to get the WMS server on <code class="docutils literal notranslate"><span class="pre">localhost</span></code> and use the <code class="docutils literal notranslate"><span class="pre">Host</span></code> header to select the right Apache
VirtualHost.</p>
<p>To don’t have cache we use the as default the headers:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">headers</span><span class="p">:</span>
    <span class="nt">Cache-Control</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">no-cache, no-store</span>
    <span class="nt">Pragma</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">no-cache</span>
</pre></div>
</div>
<p>And if you steal have issue you can add a <code class="docutils literal notranslate"><span class="pre">SALT</span></code> random argument by setting the layer parameter
<code class="docutils literal notranslate"><span class="pre">generate_salt</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</section>
<section id="alternate-mime-type">
<h3>Alternate mime type<a class="headerlink" href="#alternate-mime-type" title="Permalink to this headline">¶</a></h3>
<p>By default TileCloud support only the <code class="docutils literal notranslate"><span class="pre">image/jpeg</span></code> and <code class="docutils literal notranslate"><span class="pre">image/png</span></code> mime type.</p>
</section>
</section>
<section id="amazon-services">
<h2>Amazon services<a class="headerlink" href="#amazon-services" title="Permalink to this headline">¶</a></h2>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h3>
<p>To be authenticated by Amazon you should set those environments variable before running a command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>...</span>
<span class="prompt1"><span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>...</span>
</pre></div></div></section>
<section id="configure-s3">
<h3>Configure S3<a class="headerlink" href="#configure-s3" title="Permalink to this headline">¶</a></h3>
<p>The cache configuration is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">s3</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
    <span class="c1"># the s3 bucket name</span>
    <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tiles</span>
    <span class="c1"># the used folder in the bucket [default to &#39;&#39;]</span>
    <span class="nt">folder</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
    <span class="c1"># for GetCapabilities</span>
    <span class="nt">http_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://%(host)s/%(bucket)s/%(folder)s/</span>
    <span class="nt">cache_control</span><span class="p">:</span> <span class="s">&#39;public,</span><span class="nv"> </span><span class="s">max-age=14400&#39;</span>
    <span class="nt">hosts</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">wmts0.&lt;host&gt;</span>
</pre></div>
</div>
<p>The bucket should already exists. If you don’t use Amazon’s S3, you must specify the <code class="docutils literal notranslate"><span class="pre">host</span></code> and the
<code class="docutils literal notranslate"><span class="pre">tiles_url</span></code> configuration parameter.</p>
</section>
<section id="configure-sqs">
<h3>Configure SQS<a class="headerlink" href="#configure-sqs" title="Permalink to this headline">¶</a></h3>
<p>The configuration in layer is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sqs</span><span class="p">:</span>
    <span class="c1"># The region where the SQS queue is</span>
    <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">eu-west-1</span>
    <span class="c1"># The SQS queue name, it should already exists</span>
    <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">the_name</span>
</pre></div>
</div>
<p>The queue should be used only by one layer.</p>
<p>To use the SQS queue we should first fill the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --role master --layer &lt;a_layer&gt;</span>
</pre></div></div><p>And then generate the tiles present in the SQS queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --role slave --layer &lt;a_layer&gt;</span>
</pre></div></div><p>For the slave to keep listening when the queue is empty and be able to support more than one layer, you must
enable the daemon mode and must not specify the layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --role slave --daemon</span>
</pre></div></div></section>
<section id="configure-sns">
<h3>Configure SNS<a class="headerlink" href="#configure-sns" title="Permalink to this headline">¶</a></h3>
<p>SNS can be used to send a message when the generation ends.</p>
<p>The configuration is like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sns</span><span class="p">:</span>
    <span class="nt">topic</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:sns:eu-west-1:your-account-id:tilecloud</span>
    <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">eu-west-1</span>
</pre></div>
</div>
<p>The topic should already exists.</p>
</section>
<section id="amazon-tool">
<h3>Amazon tool<a class="headerlink" href="#amazon-tool" title="Permalink to this headline">¶</a></h3>
<p>Amazon has a command line tool (<a class="reference external" href="http://aws.amazon.com/fr/cli/">homepage</a>).</p>
<p>To use it, add in the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">awscli</span></code> as an <code class="docutils literal notranslate"><span class="pre">install_requires</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'aws</span> <span class="pre">=</span> <span class="pre">awscli.clidriver:main',</span></code> in the <code class="docutils literal notranslate"><span class="pre">console_scripts</span></code>.</p></li>
</ul>
<p>Than install it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install awscli
</pre></div>
</div>
<p>And use it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws <span class="nb">help</span>
</pre></div>
</div>
<p>For example to delete many tiles do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws s3 rm --recursive s3://your_bucket_name/folder
</pre></div>
</div>
</section>
</section>
<section id="other-related-configuration">
<h2>Other related configuration<a class="headerlink" href="#other-related-configuration" title="Permalink to this headline">¶</a></h2>
<section id="openlayers-pink-tiles">
<h3>OpenLayers pink tiles<a class="headerlink" href="#openlayers-pink-tiles" title="Permalink to this headline">¶</a></h3>
<p>To avoid the OpenLayers red tiles on missing empty tiles we can add the following CSS rule:</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">olImageLoadError</span> <span class="p">{</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To completely hide the missing tiles, useful for a transparent layer, or for an opaque layer:</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">olImageLoadError</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="distribute-the-tiles">
<h2>Distribute the tiles<a class="headerlink" href="#distribute-the-tiles" title="Permalink to this headline">¶</a></h2>
<p>There two ways to serve the tiles, with Apache configuration, or with an internal server.</p>
<p>The advantage of the internal server are:</p>
<ul class="simple">
<li><p>Can distribute MBTiles or Berkeley DB.</p></li>
<li><p>Return <code class="docutils literal notranslate"><span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></code> HTTP code in place of <code class="docutils literal notranslate"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code> (or <code class="docutils literal notranslate"><span class="pre">403</span> <span class="pre">Forbidden</span></code> for s3).</p></li>
<li><p>Can be used in KVP mode.</p></li>
<li><p>Can have zone per layer where are the tiles, otherwise it redirect on mapcache.</p></li>
</ul>
<p>To generate the Apache configuration we use the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller --generate-apache-config</span>
</pre></div></div><p>The server can be configure as it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span>
    <span class="nt">layers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">a_layer</span> <span class="c1"># Restrict to serve an certain number of layers [default to all]</span>
    <span class="nt">cache</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mbtiles</span> <span class="c1"># The used cache [default use generation/default_cache]</span>
    <span class="c1"># the URL without location to MapCache, [default to http://localhost/]</span>
    <span class="nt">mapcache_base</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://localhost/</span>
    <span class="nt">mapcache_headers</span><span class="p">:</span> <span class="c1"># headers, can be used to access to an other Apache vhost [default to {}]</span>
        <span class="nt">Host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
    <span class="nt">geoms_redirect</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># use the geoms to redirect to MapCache [default to false]</span>
    <span class="c1"># allowed extension in the static path (default value), not used for s3.</span>
    <span class="nt">static_allow_extension</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">jpeg</span><span class="p p-Indicator">,</span> <span class="nv">png</span><span class="p p-Indicator">,</span> <span class="nv">xml</span><span class="p p-Indicator">,</span> <span class="nv">js</span><span class="p p-Indicator">,</span> <span class="nv">html</span><span class="p p-Indicator">,</span> <span class="nv">css</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>The minimal configuration is to enable it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>You should also configure the <code class="docutils literal notranslate"><span class="pre">http_url</span></code> of the used cache, to something like
<code class="docutils literal notranslate"><span class="pre">https://%(host)s/${instanceid}/tiles</span></code> or like <code class="docutils literal notranslate"><span class="pre">https://%(host)s/${instanceid}/wsgi/tiles</span></code> if you use the
Pyramid view.</p>
<section id="pyramid-view">
<h3>Pyramid view<a class="headerlink" href="#pyramid-view" title="Permalink to this headline">¶</a></h3>
<p>To use the pyramid view use the following configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;tilegeneration_configfile&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;the configuration file&gt;&#39;</span><span class="p">,</span>
<span class="p">})</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;tiles&#39;</span><span class="p">,</span> <span class="s1">&#39;/tiles/\*path&#39;</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="s1">&#39;tilecloud_chain.server:PyramidView&#39;</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;tiles&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="internal-wsgi-server">
<h3>Internal WSGI server<a class="headerlink" href="#internal-wsgi-server" title="Permalink to this headline">¶</a></h3>
<p>in <code class="docutils literal notranslate"><span class="pre">production.ini</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">app</span><span class="p">:</span><span class="n">tiles</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">tilecloud_chain</span><span class="c1">#server</span>
<span class="n">configfile</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">here</span><span class="p">)</span><span class="n">s</span><span class="o">/</span><span class="n">tilegeneration</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>with the Apache configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WSGIDaemonProcess tiles:${instanceid} display-name=%{GROUP} user=${modwsgi_user}
WSGIScriptAlias /${instanceid}/tiles ${directory}/apache/wmts.wsgi
&lt;Location /${instanceid}/tiles&gt;
    WSGIProcessGroup tiles:${instanceid}
    WSGIApplicationGroup %{GLOBAL}
&lt;/Location&gt;
</pre></div>
</div>
</section>
</section>
<section id="commands">
<h2>Commands<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h2>
<section id="available-commands">
<h3>Available commands<a class="headerlink" href="#available-commands" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">generate-controller</span></code> generate the annex files like capabilities, legend, OpenLayers test page, MapCache
configuration, Apache configuration.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-tiles</span></code> generate the tiles.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-copy</span></code> copy the tiles from a cache to an other.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-process</span></code> process the tiles using a configured process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate-cost</span></code> estimate the cost.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import_expiretiles</span></code> import the osm2pgsql expire-tiles file as geoms in the database.</p></li>
</ul>
<p>Each commands have a <code class="docutils literal notranslate"><span class="pre">--help</span></code> option to give a full arguments help.</p>
</section>
<section id="generate-tiles">
<h3>Generate tiles<a class="headerlink" href="#generate-tiles" title="Permalink to this headline">¶</a></h3>
<p>Generate all the tiles:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles</span>
</pre></div></div><p>Generate a specific layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --layer &lt;a_layer&gt;</span>
</pre></div></div><p>Generate a specific zoom:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --zoom <span class="m">5</span></span>
</pre></div></div><p>Generate a specific zoom range:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --zoom <span class="m">2</span>-8</span>
</pre></div></div><p>Generate a specific some zoom levels:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --zoom <span class="m">2</span>,4,7</span>
</pre></div></div><p>Generate tiles from an (error) tiles file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --layer &lt;a_layer&gt; --tiles &lt;z/x/y&gt;</span>
</pre></div></div><p>Generate tiles on a bbox:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --bbox &lt;MINX&gt; &lt;MINY&gt; &lt;MAXX&gt; &lt;MAXY&gt;</span>
</pre></div></div><p>Generate a tiles near a tile coordinate (useful for test):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --near &lt;X&gt; &lt;Y&gt;</span>
</pre></div></div><p>Generate a tiles in a different cache than the default one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-tiles --cache &lt;a_cache&gt;</span>
</pre></div></div><p>And don’t forget to generate the WMTS Capabilities:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller --capabilities</span>
</pre></div></div></section>
<section id="openlayers-test-page">
<h3>OpenLayers test page<a class="headerlink" href="#openlayers-test-page" title="Permalink to this headline">¶</a></h3>
<p>To generate a test page use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller --openlayers</span>
</pre></div></div></section>
</section>
<section id="explain-cost">
<h2>Explain cost<a class="headerlink" href="#explain-cost" title="Permalink to this headline">¶</a></h2>
<p>Configuration (default values):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cost</span><span class="p">:</span>
    <span class="c1"># [nb/month]</span>
    <span class="nt">request_per_layers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000000</span>
    <span class="nt">cloudfront</span><span class="p">:</span>
        <span class="nt">download</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.12,</span>
        <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.009</span>
    <span class="nt">request_per_layers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000000</span>
    <span class="nt">s3</span><span class="p">:</span>
        <span class="nt">download</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.12,</span>
        <span class="nt">get</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.01,</span>
        <span class="nt">put</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.01,</span>
        <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.125</span>
    <span class="nt">sqs</span><span class="p">:</span>
        <span class="nt">request</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.01</span>
</pre></div>
</div>
<p>Layer configuration (default values):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cost</span><span class="p">:</span>
    <span class="nt">metatile_generation_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30.0,</span>
    <span class="nt">tile_generation_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30.0,</span>
    <span class="nt">tile_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20.0,</span>
    <span class="nt">tileonly_generation_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60.0</span>
</pre></div>
</div>
<p>The following commands can be used to know the time and cost to do generation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">generate-controller --cost</span>
</pre></div></div><section id="useful-options">
<h3>Useful options<a class="headerlink" href="#useful-options" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">--quiet</span></code> or <code class="docutils literal notranslate"><span class="pre">-q</span></code>: used to display only errors.</p>
<p><code class="docutils literal notranslate"><span class="pre">--verbose</span></code> or <code class="docutils literal notranslate"><span class="pre">-v</span></code>: used to display info messages.</p>
<p><code class="docutils literal notranslate"><span class="pre">--debug</span></code> or <code class="docutils literal notranslate"><span class="pre">-d</span></code>: used to display debug message, please use this option to report issue. With the debug
mode we don’t catch exceptions, and we don’t log time messages.</p>
<p><code class="docutils literal notranslate"><span class="pre">--test</span> <span class="pre">&lt;n&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">&lt;n&gt;</span></code>: used to generate only <code class="docutils literal notranslate"><span class="pre">&lt;n&gt;</span></code> tiles, useful for test.</p>
<p>The logging format is configurable in the<code class="docutils literal notranslate"><span class="pre">config.yaml</span></code> - <code class="docutils literal notranslate"><span class="pre">generation/log_format</span></code>,
<a class="reference external" href="http://docs.python.org/2/library/logging.html#logrecord-attributes">See</a>.</p>
</section>
</section>
<section id="important-remarks">
<h2>Important remarks<a class="headerlink" href="#important-remarks" title="Permalink to this headline">¶</a></h2>
<p>Especially on S3 the grid name, the layer name, the dimensions, can’t be changed (understand if we want to
change them we should regenerate all the tiles).</p>
<p>By default we also can’t insert a zoom level, if you think that you need it we can set the grid property
<code class="docutils literal notranslate"><span class="pre">matrix_identifier:</span> <span class="pre">resolution</span></code>, bit it don’t work with MapCache.</p>
<p>Please use the <code class="docutils literal notranslate"><span class="pre">--debug</span></code> to report issue.</p>
</section>
<section id="environment-variables">
<h2>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_NB_THREAD</span></code>: Default is <code class="docutils literal notranslate"><span class="pre">2</span></code>, The number of thread used to generate the tiles (If we use meta tiles)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">METATILE_NB_THREAD</span></code>: Default is <code class="docutils literal notranslate"><span class="pre">25</span></code>, The number of thread used to generate the meta tiles (If we use
meta tiles, also to generate the tiles)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SERVER_NB_THREAD:</span> <span class="pre">Default</span> <span class="pre">to</span> <span class="pre">``10</span></code>, The number of thread used to generate the meta tiles in the server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_QUEUE_SIZE</span></code>: Default to <code class="docutils literal notranslate"><span class="pre">2</span></code>, The queue size just after the Redis queue</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TILE_CHUNK_SIZE</span></code>: Default is <code class="docutils literal notranslate"><span class="pre">1</span></code>, The chunk size to process the tiles after the meta tiles.</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">c2cgeoportal</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=camptocamp&repo=c2cgeoportal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../administrator/index.html">Administrator Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Integrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
  <li><a href="configuration.html">Configuration Guide for advanced settings</a><ul>
      <li>Previous: <a href="shortener.html" title="previous chapter">Configure short URL</a></li>
      <li>Next: <a href="ngeo_new_interface.html" title="next chapter">Adding a new user interface</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-2021, Camptocamp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/integrator/tilegeneration.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/camptocamp/c2cgeoportal" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>