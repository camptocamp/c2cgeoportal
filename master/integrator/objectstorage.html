<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Working with Object storage (like S3) &#8212; c2cgeoportal  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../_static/css/c2c.css?v=939896e0" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Headers" href="headers.html" />
    <link rel="prev" title="Configuring Windows tools required to connect to servers" href="windows_tools.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="working-with-object-storage-like-s3">
<span id="integrator-objectstorage"></span><h1>Working with Object storage (like S3)<a class="headerlink" href="#working-with-object-storage-like-s3" title="Link to this heading">¶</a></h1>
<section id="prepare-files">
<h2>Prepare files<a class="headerlink" href="#prepare-files" title="Link to this heading">¶</a></h2>
<p>We can prepare a GeoTIFF for the Cloud, see the <a class="reference external" href="https://www.cogeo.org/">COG file format</a>
and the <a class="reference external" href="https://gdal.org/drivers/raster/cog.html">GDAL output driver options</a>.</p>
</section>
<section id="generalities">
<h2>Generalities<a class="headerlink" href="#generalities" title="Link to this heading">¶</a></h2>
<p>In this section, we explain how to use the S3-like storage from Exoscale.</p>
<p>First of all, you should set the following variables
on the <code class="docutils literal notranslate"><span class="pre">geoportal</span></code>, <code class="docutils literal notranslate"><span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">qgisserver</span></code> services:</p>
<p>For Exoscale:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code>: The project access key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code>: The project secret key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_REGION=ch-dk-2</span></code>: The region used by Exoscale.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_S3_ENDPOINT=sos-ch-dk-2.exo.io</span></code>: The endpoint used by Exoscale.</p></li>
</ul>
<p>For Azure:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AZURE_STORAGE_CONNECTION_STRING</span></code>: The connection string.</p></li>
</ul>
<p>For better performance, you should furthermore set the following variables
on the <code class="docutils literal notranslate"><span class="pre">geoportal</span></code> and <code class="docutils literal notranslate"><span class="pre">qgisserver</span></code> services:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CPL_VSIL_CURL_USE_CACHE=TRUE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CPL_VSIL_CURL_CACHE_SIZE=128000000</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CPL_VSIL_CURL_USE_HEAD=FALSE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GDAL_DISABLE_READDIR_ON_OPEN=TRUE</span></code></p></li>
</ul>
<p>Exoscale:</p>
<p>Use the aws client to list the files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">aws<span class="w"> </span>--endpoint-url<span class="w"> </span>https://sos-ch-dk-2.exo.io/<span class="w"> </span>--region<span class="w"> </span>ch-dk-2<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>s3<span class="w"> </span>ls<span class="w"> </span>s3://&lt;bucket&gt;/&lt;folder&gt;</span>
</pre></div></div><p>Create the vrt file for a raster layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">     </span><span class="s1">&#39;gdalbuildvrt /vsis3/&lt;bucket&gt;/&lt;folder&gt;/index.vrt \</span>
<span class="s1">     $(list4vrt &lt;bucket&gt; &lt;folder&gt;/ .tif)&#39;</span></span>
</pre></div></div><p>Azure:</p>
<p>Use list the container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>azure<span class="w"> </span>--list-container</span>
</pre></div></div><p>Use list the files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>azure<span class="w"> </span>--container<span class="o">=</span>&lt;container&gt;<span class="w"> </span>--list<span class="w"> </span><span class="s1">&#39;&#39;</span></span>
</pre></div></div><p>Create the vrt file for a raster layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>azure<span class="w"> </span>--container<span class="o">=</span>&lt;container&gt;<span class="w"> </span>--vrt<span class="w"> </span>&lt;folder&gt;/<span class="w"> </span>.tiff</span>
</pre></div></div></section>
<section id="mapserver">
<h2>MapServer<a class="headerlink" href="#mapserver" title="Link to this heading">¶</a></h2>
<p>Create the shape index file for a raster layer:</p>
<p>Exoscale:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">     </span><span class="s1">&#39;gdaltindex mapserver/index.shp $( \</span>
<span class="s1">         aws --endpoint-url http://${AWS_S3_ENDPOINT} \</span>
<span class="s1">             --region ${AWS_DEFAULT_REGION} \</span>
<span class="s1">             s3 ls s3://&lt;bucket&gt;/&lt;folder&gt;/ | \</span>
<span class="s1">         grep tif$ | \</span>
<span class="s1">         awk &#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;{print &quot;/vsis3/&lt;bucket&gt;/&lt;folder&gt;/&quot;$4}&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39; \</span>
<span class="s1">     )&#39;</span></span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.shp<span class="w"> </span>mapserver/</span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.shx<span class="w"> </span>mapserver/</span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.dbf<span class="w"> </span>mapserver/</span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.prj<span class="w"> </span>mapserver/</span>
</pre></div></div><p>Azure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>rm<span class="w"> </span>index.shp</span>
<span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>rm<span class="w"> </span>index.shx</span>
<span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>rm<span class="w"> </span>index.dbf</span>
<span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>rm<span class="w"> </span>index.prj</span>
<span class="prompt1">docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>geoportal<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">     </span><span class="s1">&#39;gdaltindex mapserver/index.shp $( \</span>
<span class="s1">         azure --container=&lt;container&gt; --list &lt;folder&gt;/ | \</span>
<span class="s1">         grep tiff$ | \</span>
<span class="s1">         awk &#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;{print &quot;/vsiaz/&lt;container&gt;/&quot;$1}&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39; \</span>
<span class="s1">     )&#39;</span></span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.shp<span class="w"> </span>mapserver/&lt;set&gt;.shp</span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.shx<span class="w"> </span>mapserver/&lt;set&gt;.shx</span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.dbf<span class="w"> </span>mapserver/&lt;set&gt;.dbf</span>
<span class="prompt1"><span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>&lt;docker_compose_project_name&gt;_geoportal_1:/app/index.prj<span class="w"> </span>mapserver/&lt;set&gt;.prj</span>
</pre></div></div><p>Add the following config in the <code class="docutils literal notranslate"><span class="pre">mapserver/mapserver.map.tmpl</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONFIG</span> <span class="s2">&quot;CPL_VSIL_CURL_USE_CACHE&quot;</span> <span class="s2">&quot;TRUE&quot;</span>
<span class="n">CONFIG</span> <span class="s2">&quot;CPL_VSIL_CURL_CACHE_SIZE&quot;</span> <span class="s2">&quot;128000000&quot;</span>
<span class="n">CONFIG</span> <span class="s2">&quot;CPL_VSIL_CURL_USE_HEAD&quot;</span> <span class="s2">&quot;FALSE&quot;</span>
<span class="n">CONFIG</span> <span class="s2">&quot;GDAL_DISABLE_READDIR_ON_OPEN&quot;</span> <span class="s2">&quot;TRUE&quot;</span>
</pre></div>
</div>
<p>Exoscale:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONFIG</span> <span class="s2">&quot;AWS_ACCESS_KEY_ID&quot;</span> <span class="s2">&quot;$</span><span class="si">{AWS_ACCESS_KEY_ID}</span><span class="s2">&quot;</span>
<span class="n">CONFIG</span> <span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span> <span class="s2">&quot;$</span><span class="si">{AWS_SECRET_ACCESS_KEY}</span><span class="s2">&quot;</span>
<span class="n">CONFIG</span> <span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span> <span class="s2">&quot;$</span><span class="si">{AWS_DEFAULT_REGION}</span><span class="s2">&quot;</span>
<span class="n">CONFIG</span> <span class="s2">&quot;AWS_S3_ENDPOINT&quot;</span> <span class="s2">&quot;$</span><span class="si">{AWS_S3_ENDPOINT}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Azure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>${DISABLE_LOCAL} CONFIG &quot;AZURE_STORAGE_CONNECTION_STRING&quot; &quot;${AZURE_STORAGE_CONNECTION_STRING}&quot;
${DISABLE_MUTUALIZE} CONFIG &quot;AZURE_STORAGE_ACCOUNT&quot; &quot;${AZURE_STORAGE_ACCOUNT}&quot;
</pre></div>
</div>
<p>Use the shape index in the layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">RASTER</span>
<span class="n">STATUS</span> <span class="n">ON</span>
<span class="n">PROCESSING</span> <span class="s2">&quot;RESAMPLE=AVERAGE&quot;</span>
<span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
<span class="n">TILEINDEX</span> <span class="s2">&quot;index.shp&quot;</span>
<span class="n">TILEITEM</span> <span class="s2">&quot;LOCATION&quot;</span>
</pre></div>
</div>
<p>Add a vector layer for the object storage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
<span class="n">CONNECTION</span> <span class="s2">&quot;$</span><span class="si">{RASTER_BASE_PATH}</span><span class="s2">&lt;path&gt;/&lt;name&gt;.shp&quot;</span>
<span class="n">DATA</span> <span class="s2">&quot;&lt;name&gt;&quot;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/mapserver/mapserver/wiki/Render-images-straight-out-of-S3-with-the-vsicurl-driver">Some more information</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to use different buckets or containers in different environments
(such as integration / production), you should add an empty file named <code class="docutils literal notranslate"><span class="pre">&lt;tileindexbasename&gt;.raster</span></code>
(not <code class="docutils literal notranslate"><span class="pre">&lt;tileindexbasename&gt;.shp.raster</span></code>) and a <code class="docutils literal notranslate"><span class="pre">RASTER_BASE_PATH</span></code> environment variable in your
<cite>env.project</cite> file, then the base path will be replaced (same number of folders).
The empty raster files are here just to find the files that should be managed.</p>
<p>Example: <cite>RASTER_BASE_PATH=/vsiaz/&lt;container&gt;/</cite></p>
</div>
</section>
<section id="qgis">
<h2>QGIS<a class="headerlink" href="#qgis" title="Link to this heading">¶</a></h2>
<section id="client">
<h3>Client<a class="headerlink" href="#client" title="Link to this heading">¶</a></h3>
<p>The following environment variables should be defined (in the OS or in QGIS
(<code class="docutils literal notranslate"><span class="pre">Settings</span></code> / <code class="docutils literal notranslate"><span class="pre">Options...</span></code> / <code class="docutils literal notranslate"><span class="pre">System</span></code> / <code class="docutils literal notranslate"><span class="pre">Environment</span></code>)):</p>
<p>Exoscale:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code>: The project access key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code>: The project secret key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_REGION=ch-dk-2</span></code>: The region used by Exoscale.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_S3_ENDPOINT=sos-ch-dk-2.exo.io</span></code>: The endpoint used by Exoscale.</p></li>
</ul>
<p>Azure:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AZURE_STORAGE_CONNECTION_STRING</span></code>: The connection string.</p></li>
</ul>
<p>On Windows also add:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GDAL_HTTP_UNSAFESSL=YES</span></code></p></li>
</ul>
<p>Then you can add a raster layer with:</p>
<ul class="simple">
<li><p>Open from the menu <code class="docutils literal notranslate"><span class="pre">Layer</span></code> / <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Layer</span></code> / <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Raster</span> <span class="pre">Layer</span></code>.</p></li>
<li><p>Section: <code class="docutils literal notranslate"><span class="pre">Raster</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Source</span> <span class="pre">type</span></code>: <code class="docutils literal notranslate"><span class="pre">Protocole:</span> <span class="pre">HTTP(S),</span> <span class="pre">cloud,</span> <span class="pre">etc.</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Type</span></code>: <code class="docutils literal notranslate"><span class="pre">AWS</span> <span class="pre">S3</span></code> or <code class="docutils literal notranslate"><span class="pre">Microsoft</span> <span class="pre">Azure</span> <span class="pre">Blob</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Bucket</span> <span class="pre">or</span> <span class="pre">container</span></code>: &lt;bucket&gt; or &lt;container&gt;.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Object</span> <span class="pre">key</span></code>: &lt;folder&gt;/index.vrt.</p></li>
</ul>
<p>You can add a vector layer in an analogous manner.</p>
</section>
<section id="server">
<h3>Server<a class="headerlink" href="#server" title="Link to this heading">¶</a></h3>
<p>Fill the required environment variables.</p>
<p>Exoscale:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code>: The project access key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code>: The project secret key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_REGION=ch-dk-2</span></code>: Should already be in your env.project.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_S3_ENDPOINT=sos-ch-dk-2.exo.io</span></code>: Should already be in your env.project.</p></li>
</ul>
<p>Azure docker-compose:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AZURE_STORAGE_CONNECTION_STRING</span></code>: The connection string.</p></li>
</ul>
<p>For Azure AKS the access should be given by the AzureAssignedIdentity in Kubernetes,</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to use different buckets or containers in different environments
(such as integration / production), you should add an empty file names
<code class="docutils literal notranslate"><span class="pre">&lt;name&gt;.qgs.raster</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;.qgz.raster</span></code>
and a <code class="docutils literal notranslate"><span class="pre">RASTER_BASE_PATH</span></code> environment variable in your
config container, then the base path will be replaced (same number of folder).
The empty raster files are here just to find the files that should be managed.</p>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">c2cgeoportal</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=camptocamp&repo=c2cgeoportal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../administrator/index.html">Administrator Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Integrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
  <li><a href="configuration.html">Configuration Guide for advanced settings</a><ul>
      <li>Previous: <a href="windows_tools.html" title="previous chapter">Configuring Windows tools required to connect to servers</a></li>
      <li>Next: <a href="headers.html" title="next chapter">Headers</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-2023, Camptocamp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/integrator/objectstorage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>