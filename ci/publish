#!/bin/bash -eu

echo docker login ***
docker login --username ${DOCKER_USERNAME} --password ${DOCKER_PASSWORD}

set -x

GIT_TAG=""
if [[ "${GITHUB_REF}" =~ ^refs/tags/.* ]]
then
  GIT_TAG=$(echo "${GITHUB_REF}"|sed 's|^refs/tags/||g')
elif [[ "${GITHUB_REF}" =~ ^refs/heads/.* ]]
then
  GIT_BRANCH=$(echo "${GITHUB_REF}"|sed 's|^refs/heads/||g')
fi

TAG=${GIT_TAG}
COMMIT=FALSE
VERSION_QGIS=FALSE

if [[ ${TAG} =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
then
    VERSION_QGIS=${TAG}
    ci/changelog ${TAG}
    COMMIT=TRUE
    GIT_BRANCH=$(python3 -c "print(__import__('re').search(r'^([0-9]+\.[0-9]+)\.[0-9]+$', '${TAG}').group(1))")
else
    if [[ ${GIT_BRANCH} =~ ^[0-9]+\.[0-9]+$ ]]
    then
        VERSION_QGIS=${GIT_BRANCH}
        TAG=$(scripts/get-version --full)
        ci/changelog ${TAG}
        COMMIT=TRUE
    fi
fi

DEPLOY_PIP=FALSE
MAJOR_VERSION_TAG=${MAJOR_VERSION}
# Get the version to be published
if [ "${TAG}" ]
then
    VERSION=${TAG}
elif [ "${GIT_BRANCH}" != "${MAIN_BRANCH}" ]
then
    VERSION=${GIT_BRANCH//\//_}
    MAJOR_VERSION_TAG=${VERSION}
    DEPLOY_PIP=FALSE
else
    VERSION=${MAJOR_VERSION}
fi
export VERSION
if [ ${VERSION_QGIS} == FALSE ]
then
    VERSION_QGIS=${VERSION}
fi

if [ $1 == "--geoportal" ]
then
    if [ ${COMMIT} == TRUE ]
    then
        git add ci/ci.yaml ci/changelog.yaml CHANGELOG.md
        git commit -m "[skip ci] Update the minor version"
        git push https://${GITHUB_TOKEN}@github.com/camptocamp/c2cgeoportal.git HEAD:${GIT_BRANCH}
    fi

    # Publish the GeoMapFish tools and config images
    for IMAGE in geomapfish-tools geomapfish-config
    do
        docker tag camptocamp/${IMAGE} camptocamp/${IMAGE}:${VERSION}
        docker push camptocamp/${IMAGE}:${VERSION}
    done
    # Publish the GeoMapFish run
    docker tag camptocamp/geomapfish camptocamp/geomapfish:${MAJOR_VERSION_TAG}
    docker push camptocamp/geomapfish:${MAJOR_VERSION_TAG}

    # Publish the default geoportal images
    ci/create-new-project ${HOME}/workspace geomapfish
    (cd ${HOME}/workspace/geomapfish/; ./build)

    docker tag camptocamp/geomapfish-geoportal camptocamp/geomapfish-geoportal:${MAJOR_VERSION_TAG}
    docker push camptocamp/geomapfish-geoportal:${MAJOR_VERSION_TAG}

    if [ ${DEPLOY_PIP} == TRUE ]
    then
        # Publish the Python eggs
        for PKG in commons geoportal admin
        do
            export PKG
            ci/publish-pypi
        done
    fi
else
    # Publish the GeoMapFish QGIS server images
    docker tag camptocamp/geomapfish-qgisserver:gmf${MAJOR_VERSION}-qgis${2} \
        camptocamp/geomapfish-qgisserver:gmf${VERSION_QGIS}-qgis${2}
    docker push camptocamp/geomapfish-qgisserver:gmf${VERSION_QGIS}-qgis${2}
fi
