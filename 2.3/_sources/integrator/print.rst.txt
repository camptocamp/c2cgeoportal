.. _integrator_print:

Print
=====

Using MapFish Print v3
----------------------

Migration from the v2
~~~~~~~~~~~~~~~~~~~~~

Start the migration by instantiating the default template:

.. prompt:: bash

   cd <project_root>
   cp -r print ~
   git rm -r print
   SRID=-1 ./docker-run pcreate --interactive --scaffold=c2cgeoportal_create --package-name=<package> /tmp/<project>
   ./docker-run pcreate --interactive --scaffold=c2cgeoportal_update --package-name=<package> /tmp/<project>
   mv /tmp/<project>/print .
   rm -rf /tmp/<project>

Then in ``~/print`` you will have a backup of the old template, and in the ``print`` folder you will have the new print configuration.

In the ``<package>.mk`` you should remove the ``PRINT_VERSION = 2`` (it is ``3`` by default).

In the concerned viewer javascript files, in the ``cgxp_print`` plugin add the following lines:

.. code:: javascript

   version: 3,
   encodeLayer: {},
   encodeExternalLayer: {},
   additionalAttributes: []

Template configuration
~~~~~~~~~~~~~~~~~~~~~~

All print-related files are located in the ``print/`` folder, and the files related to the template in the
``print/print-apps/<package>`` folder.

The main configuration file is ``print/print-apps/<package>/config.yaml``.

* `MapFish print documentation <http://mapfish.github.io/mapfish-print-doc/>`_
* `Startup with Jasper Reports <http://mapfish.github.io/mapfish-print-doc/#/jasperReports>`_


Using a single print server in a set of sites
----------------------------------------------

For memory issues it is recommended to only use a single print server for a set of sites.

For that we need to have only one ``vars_<project>.yaml`` which can easily be
generated by the templating. Then we should do:

* Remove the print from the ``children`` projects by
  removing the ``print`` folder:

  .. prompt:: bash

    git rm print

* Deactivate the print compilation by adding the following lines
  in the ``<package>.mk`` file:

  .. code:: make

    PRINT_VERSION = NONE

* Point to the parent print server by editing the following lines
  in the ``vars_<package>.yaml`` file:

  .. code:: yaml

    vars:
        ...
        # For print proxy
        # This value means that we use the parent print server
        print_url: http://{host}:8080/print/pdf/

* If needed set the print templates used by anonymous users by adding the
  following in the application configuration (``vars_<package>.yaml``):

  .. code:: yaml

     vars:
       ...
       functionalities:
           anonymous:
               print_template:
               - 1 A4 child
               - 2 A3 child

.. note::

   This system works for print v2 but must be adapted for
   print v3 (although that is the same idea).

Having a dedicated print instance
---------------------------------

The goal is to be able to create a custom makefile with which one we make:

.. prompt:: bash

   make --makefile=<file>.mk

To have only the print.

For this, create a makefile with:

.. code:: yaml

   BUILD_RULES = test-packages print
   TEST_PACKAGES = main print
