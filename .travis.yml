---

dist: trusty
sudo: required

language: python
python:
  - "3.5"

service:
  - docker

addons:
  apt:
    update: true

cache:
  apt: true
  pip: false

env:
  global:
    - secure: "aZWcHZWV8lN2SNU2fcUsG8+fVQLOxwDUFYDvuftZALebRG2AHINTkbS31sKbeSwS19ZYpjcuVOKC9HxNAlnMxsdO1Nvv\
        FEbSJJD/yqq0V4EfTRqptZYsFCUou0eXIUWEnoFHD1nY3NhuPQjDoad995xU92z0BzwduxUAj28liu4="
    - secure: "SosPNhER7I5YnVZy7AoUjrs+P08S60fPje1sFgMdfRNRElI42oLgO6wk1nEFEGGjUevSLzpsDruy7z1m5ilzyMenO1hG\
        1lASf2BeeJC8rRz75MgRKnlf7Py6BA9GbNprzMdgxNPlUtrEkp9ExLvC7MZs7H0RvwxBgQmepQG5Mdg="
    - secure: "Vt9O18grAUS3cf4tzbqY1YuQyCJTsPNh5lA79/q8viAcrJg0fAeNQEBoUyCAzztlgL53PrzLWTYIuK6Fw1t+td8hmEST\
        l7fPSlVbGB6C/iG0d+cnIq31rjnliIdErXIAcB4JwE3yIRx+5aVEMBpAUhRuzBhGCt6iZwjhhFEr/D8="
    # GITHUB_TOKEN
    - secure: "NPvBo8Qbi/Idxv3XGnh6J5ui+z8YTpRvpGzResJyXcIrMvIWgBBDvldACUCaPuabOGlwciy+nSWWYn2JLVZ2peoMgr9n\
        KEhRfGCvZBD5K/E+C73+41Cwsk0K+zJx5YRPYy9bYa4iuIwXfABGyiTWGYjLq8o3xxcx4Dwlmaqj1j8="
    - MAIN_BRANCH=2.4
    - MAJOR_VERSION=2.4

install:
  - sudo service postgresql stop
  - git config --global user.email travis@camptocamp.com
  - git config --global user.name Travis
  - python3 -m pip install --requirement=travis/requirements.txt
  - travis/set-ngeo-version

before_script:
  - docker build --tag=camptocamp/geomapfish-build-dev:${MAJOR_VERSION} docker/build
  - ./docker-run make build

  ## FOR NON DOCKER TESTS
  - deactivate
  - sudo apt-get remove --assume-yes --force-yes python-zope.interface
  - "sudo aptitude install --assume-yes tree apache2 apache2-dev libapache2-mod-fcgid tomcat7 cgi-mapserver \
      python3-netifaces python3-pip python3-virtualenv libgdal-dev"
  # workaround: https://askubuntu.com/questions/569550/
  #    assertionerror-using-apache2-and-libapache2-mod-wsgi-py3-on-ubuntu-14-04-python
  - sudo python3 -m pip install mod_wsgi
  - sudo mod_wsgi-express install-module
  - "echo \"LoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi-py34.cpython-34m.so\" > \
      /tmp/wsgi_express.load"
  - echo "WSGIPythonHome /usr/" > /tmp/wsgi_express.conf
  - sudo mv /tmp/wsgi_express.load /tmp/wsgi_express.conf /etc/apache2/mods-available/
  - sudo a2enmod wsgi_express
  - sudo a2enmod proxy
  - sudo service apache2 restart
  - sudo chmod o+rx /var/log/apache2/
  - sudo chmod o+r /var/log/apache2/*.log
  # Database for the GeoMapFish application
  - ./docker-run make docker-build-testdb
  - >
    docker run --name testdb
    --env=POSTGRES_USER=www-data --env=POSTGRES_PASSWORD=www-data --env=POSTGRES_DB=geomapfish
    --publish=5432:5432 --detach camptocamp/geomapfish-test-db
  - docker build --tag=external-db docker/test-external-db
  - docker run --name externaldb --publish=5433:5432 --detach external-db
  - mkdir --parent /tmp/travis

script:
  - echo "We do not test non docker app in this branch"

notifications:
  email:
    recipients:
      - stephane.brunner@camptocamp.com
    if: branch = env(MAIN_BRANCH)
