<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Extend the application &#8212; c2cgeoportal  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../_static/css/c2c.css?v=939896e0" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Use Docker to deploy your application" href="docker.html" />
    <link rel="prev" title="Vector tiles" href="vector_tiles.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="extend-the-application">
<span id="extend-application"></span><h1>Extend the application<a class="headerlink" href="#extend-the-application" title="Link to this heading">¶</a></h1>
<p>To add an additional component in the project in simple mode we should:</p>
<ul class="simple">
<li><p>use an interface in canvas mode</p></li>
<li><p>add a custom docker compose service</p></li>
<li><p>add a custom JavaScript file</p></li>
</ul>
<p>In this tutorial, we will:</p>
<ul class="simple">
<li><p>Create a new Docker image for the new service</p></li>
<li><p>Integrate it to the project</p></li>
<li><p>Create the new interface based on canvas</p></li>
<li><p>Create a new WebComponent</p></li>
<li><p>Build it in the config image</p></li>
<li><p>Add it to the interface template</p></li>
<li><p>Debugging Custom JavaScript and service</p></li>
</ul>
<section id="create-a-new-docker-image-for-the-new-service">
<h2>Create a new Docker image for the new service<a class="headerlink" href="#create-a-new-docker-image-for-the-new-service" title="Link to this heading">¶</a></h2>
<p>In this chapter we will create a new Pyramid application that uses Cornice in a Docker image.</p>
<p>We will use the Pyramid Cookiecutter starter, we can use it directly
(by running <code class="docutils literal notranslate"><span class="pre">cookiecutter</span> <span class="pre">gh:Pylons/pyramid-cookiecutter-starter</span></code>) if you want to do your
image by your own, but in this tutorial we will get the files directly from the demo.
For that run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1"><span class="nb">cd</span><span class="w"> </span>/tmp</span>
<span class="prompt1">git<span class="w"> </span>clone<span class="w"> </span>git@github.com:camptocamp/demo_geomapfish.git</span>
<span class="prompt1"><span class="nb">cd</span><span class="w"> </span>-</span>
<span class="prompt1">cp<span class="w"> </span>--recursive<span class="w"> </span>/tmp/demo_geomapfish/custom<span class="w"> </span>/tmp/demo_geomapfish/haproxy<span class="w"> </span>.</span>
</pre></div></div><p>Add in <code class="docutils literal notranslate"><span class="pre">.prettierignore</span></code> the following line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">custom</span><span class="o">/</span><span class="n">Pipfile</span><span class="o">.</span><span class="n">lock</span>
</pre></div>
</div>
<p>Apply the following diff in the <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code>:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- known_first_party=c2cgeoportal_commons,c2cgeoportal_geoportal,c2cgeoportal_admin,geomapfish_geoportal</span>
<span class="gi">+ known_first_party=c2cgeoportal_commons,c2cgeoportal_geoportal,c2cgeoportal_admin,geomapfish_geoportal,custom</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The important files are:</p>
<ul class="simple">
<li><p>The Database model <a class="reference external" href="https://github.com/camptocamp/demo_geomapfish/blob/master/custom/custom/models/feedback.py">custom/custom/models/feedback.py</a></p></li>
<li><p>The view <a class="reference external" href="https://github.com/camptocamp/demo_geomapfish/blob/master/custom/custom/views/feedback.py">custom/custom/views/feedback.py</a></p></li>
</ul>
</div>
</section>
<section id="integrate-it-to-the-project">
<h2>Integrate it to the project<a class="headerlink" href="#integrate-it-to-the-project" title="Link to this heading">¶</a></h2>
<p>Add the following service in the <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code>, with that we will be able to build and run the image:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">custom</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${DOCKER_BASE}-custom:${DOCKER_TAG}</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">custom</span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span>
<span class="w">      </span><span class="nt">GIT_HASH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${GIT_HASH}</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VISIBLE_WEB_HOST</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GEOPORTAL_INTERNAL_URL</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PGSCHEMA</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_POOL_RECYCLE</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_POOL_SIZE</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_MAX_OVERFLOW</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_SLAVE_POOL_RECYCLE</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_SLAVE_POOL_SIZE</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_SLAVE_MAX_OVERFLOW</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_URL=postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_SLAVE_URL=postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST_SLAVE}:${PGPORT_SLAVE}/${PGDATABASE}?sslmode=${PGSSLMODE}</span>
</pre></div>
</div>
<p>Add the following service in the <code class="docutils literal notranslate"><span class="pre">docker-compose.override.sample.yaml</span></code>, To be able to run the service
in debugging mode with auto reloading:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">custom</span><span class="p">:</span>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/venv/bin/pserve</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--reload</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c2c://development.ini</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./custom/custom:/app/custom</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you need the user credentials, you can do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;http://geoportal:8080/loginuser&quot;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Cookie&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cookie&quot;</span><span class="p">),</span> <span class="s2">&quot;Referrer&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">},</span>
<span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="create-the-new-interface-based-on-canvas">
<span id="extend-application-canvas"></span><h2>Create the new interface based on canvas<a class="headerlink" href="#create-the-new-interface-based-on-canvas" title="Link to this heading">¶</a></h2>
<p>The canvas interface goal is to be used in simple mode and offers more flexibility.</p>
<p>Get the files from the <code class="docutils literal notranslate"><span class="pre">CONST_create_template</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">mkdir<span class="w"> </span>-p<span class="w"> </span>geoportal/interfaces/</span>
<span class="prompt1">cp<span class="w"> </span>CONST_create_template/geoportal/interfaces/desktop_alt.html.mako<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>geoportal/interfaces/desktop.html.mako</span>
<span class="prompt1">mkdir<span class="w"> </span>-p<span class="w"> </span>geoportal/&lt;package&gt;_geoportal/static/images/</span>
<span class="prompt1">cp<span class="w"> </span>CONST_create_template/geoportal/&lt;package&gt;_geoportal/static/images/background-layer-button.png<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>geoportal/&lt;package&gt;_geoportal/static/images/</span>
</pre></div></div><p>In the <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file your interface should be declared like that:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">interfaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">desktop</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">canvas</span>
<span class="w">    </span><span class="nt">layout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">desktop</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">interfaces_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">desktop</span><span class="p">:</span>
<span class="w">    </span><span class="nt">constants</span><span class="p">:</span>
<span class="w">      </span><span class="nt">gmfOptions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">cssVars</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Used by https://github.com/camptocamp/ngeo/pull/7527</span>
<span class="w">          </span><span class="nt">left-panel-width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20rem</span>
<span class="w">          </span><span class="nt">app-margin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.62rem</span>
<span class="w">          </span><span class="nt">icon-font-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.25rem</span>
<span class="w">          </span><span class="nt">border</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.06rem solid</span>
<span class="w">          </span><span class="nt">input-height-base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.88rem</span>
<span class="w">          </span><span class="nt">padding-base-vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.32rem</span>
<span class="w">          </span><span class="nt">padding-small-vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.36rem</span>
<span class="w">          </span><span class="nt">border-radius-base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">          </span><span class="nt">right-panel-width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">17.5rem</span>
<span class="w">          </span><span class="nt">grid-gutter-width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.88rem</span>
<span class="w">          </span><span class="nt">infobar-height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.52rem</span>
<span class="w">          </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.5rem</span>
</pre></div>
</div>
<p>in the <code class="docutils literal notranslate"><span class="pre">geoportal/geomapfish_geoportal/static/css/desktop.css</span></code> file you can add the following lines:</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">logo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mf">2.8</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin-left</span><span class="p">:</span><span class="w"> </span><span class="mf">0.62</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">background-repeat</span><span class="p">:</span><span class="w"> </span><span class="kc">no-repeat</span><span class="p">;</span>
<span class="w">  </span><span class="k">background-size</span><span class="p">:</span><span class="w"> </span><span class="kc">auto</span><span class="w"> </span><span class="mf">2.8</span><span class="kt">rem</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">logo-right</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mf">2.8</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">background-repeat</span><span class="p">:</span><span class="w"> </span><span class="kc">no-repeat</span><span class="p">;</span>
<span class="w">  </span><span class="k">background-size</span><span class="p">:</span><span class="w"> </span><span class="kc">auto</span><span class="w"> </span><span class="mf">2.8</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">absolute</span><span class="p">;</span>
<span class="w">  </span><span class="k">top</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">right</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">name</span></code> is the interface name as usual.
The <code class="docutils literal notranslate"><span class="pre">type</span></code> should be set to <code class="docutils literal notranslate"><span class="pre">canvas</span></code> to be able to get the canvas based interface present in the config image.
The <code class="docutils literal notranslate"><span class="pre">layout</span></code> is used to get the JavaScript and CSS files from ngeo, in simple mode it can be one of the following:
<code class="docutils literal notranslate"><span class="pre">desktop</span></code>, <code class="docutils literal notranslate"><span class="pre">mobile</span></code>, <code class="docutils literal notranslate"><span class="pre">mobile_alt</span></code>, <code class="docutils literal notranslate"><span class="pre">iframe_api</span></code> or <code class="docutils literal notranslate"><span class="pre">oeedit</span></code>, but usually we use <code class="docutils literal notranslate"><span class="pre">desktop</span></code>.
The <code class="docutils literal notranslate"><span class="pre">default</span></code> is used to set the default interface as usual.</p>
<p>In the file <code class="docutils literal notranslate"><span class="pre">geoportal/interfaces/desktop.html.mako</span></code> you will use the following variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">request</span></code> -&gt; the Pyramid request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">header</span></code> -&gt; the header additional part of the page, the <code class="docutils literal notranslate"><span class="pre">dynamicUrl</span></code> and <code class="docutils literal notranslate"><span class="pre">interface</span></code> meta, and the CSS inclusion.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spinner</span></code> -&gt; the spinner SVG image content.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">footer</span></code> -&gt; the footer additional part of the page, for the JavaScript inclusion.</p></li>
</ul>
<p>You can also see that there is some HTML tags that have an attribute slot.
The slot says where the component should be added:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">header</span></code> -&gt; in the header part of the page.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> -&gt; in the data panel on the left of the map.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tool-button</span></code> -&gt; in the tools on the right of the map.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tool-button-separate</span></code> -&gt; in the tools on the right of the map, for the shared button.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tool-&lt;panel-name&gt;</span></code> -&gt; in the tools panel on the right of the map, when the tool is activated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">footer-&lt;panel-name&gt;</span></code> -&gt; in the footer part of the page, when the panel is activated.</p></li>
</ul>
<p>Add the following lines in the <code class="docutils literal notranslate"><span class="pre">project.yaml</span></code> as <code class="docutils literal notranslate"><span class="pre">managed_files</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geoportal/interfaces/desktop_alt\.html\.mako</span>
</pre></div>
</div>
</section>
<section id="create-a-new-webcomponent">
<span id="extend-application-webcomponent"></span><h2>Create a new WebComponent<a class="headerlink" href="#create-a-new-webcomponent" title="Link to this heading">¶</a></h2>
<p>In this tutorial we will create a new WebComponent based on <a class="reference external" href="https://lit.dev/">Lit</a>,
and build by <a class="reference external" href="https://vitejs.dev/">Vite</a>.</p>
<p>We will add a button in the tools bar which opens a new tool panel and that can be used to send a feedback.</p>
<p>The tool button should be an instance of
<a class="extlink-ngeo_doc reference external" href="https://camptocamp.github.io/ngeo/2.9/apidoc/classes/srcapi_elements_ToolButtonElement.default.html">gmfapi.elements.ToolButtonElement</a>.</p>
<p>We will directly use
<a class="extlink-ngeo_doc reference external" href="https://camptocamp.github.io/ngeo/2.9/apidoc/classes/srcapi_elements_ToolButtonElement.ToolButtonDefault.html">gmf-tool-button</a>.</p>
<p>And panel should be an instance of:
<a class="extlink-ngeo_doc reference external" href="https://camptocamp.github.io/ngeo/2.9/apidoc/classes/srcapi_elements_ToolPanelElement.default.html">gmfapi.elements.ToolPanelElement</a>.</p>
<p>We will directly get the existing component from the demo.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nb">cd</span><span class="w"> </span>/tmp</span>
<span class="prompt1">git<span class="w"> </span>clone<span class="w"> </span>git@github.com:camptocamp/demo_geomapfish.git</span>
<span class="prompt1"><span class="nb">cd</span><span class="w"> </span>-</span>
<span class="prompt1">cp<span class="w"> </span>--recursive<span class="w"> </span>/tmp/demo_geomapfish/webcomponents<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>/tmp/demo_geomapfish/package.json<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>/tmp/demo_geomapfish/package-lock.json<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>/tmp/demo_geomapfish/tsconfig.json<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>/tmp/demo_geomapfish/vite.config.ts<span class="w"> </span>.</span>
</pre></div></div><p>Add the following lines in the <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">node_modules</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The web component file is <a class="reference external" href="https://github.com/camptocamp/demo_geomapfish/blob/master/custom/webcomponents/feedback.ts">custom/webcomponents/feedback.tspy</a>.</p>
</div>
</section>
<section id="build-it-in-the-config-image">
<h2>Build it in the config image<a class="headerlink" href="#build-it-in-the-config-image" title="Link to this heading">¶</a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> we will add two stages, one to build the WebComponent and an other just to add the
build artifacts to the config image.</p>
<p>Add the following lines at the end of <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">###############################################################################</span>

<span class="n">FROM</span> <span class="n">node</span><span class="p">:</span><span class="mi">16</span><span class="o">-</span><span class="n">slim</span> <span class="n">AS</span> <span class="n">custom</span><span class="o">-</span><span class="n">build</span>

<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">app</span>
<span class="n">COPY</span> <span class="n">package</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span>

<span class="n">RUN</span> <span class="n">npm</span> <span class="n">install</span>

<span class="n">COPY</span> <span class="n">tsconfig</span><span class="o">.</span><span class="n">json</span> <span class="n">vite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ts</span> <span class="o">./</span>
<span class="n">COPY</span> <span class="n">webcomponents</span><span class="o">/</span> <span class="o">./</span><span class="n">webcomponents</span><span class="o">/</span>
<span class="n">RUN</span> <span class="n">npm</span> <span class="n">run</span> <span class="n">build</span>

<span class="c1">###############################################################################</span>

<span class="n">FROM</span> <span class="n">gmf_config</span> <span class="n">AS</span> <span class="n">config</span>
<span class="n">COPY</span> <span class="o">--</span><span class="n">from</span><span class="o">=</span><span class="n">custom</span><span class="o">-</span><span class="n">build</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">dist</span><span class="o">/</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">geomapfish</span><span class="o">/</span><span class="n">static</span><span class="o">/</span><span class="n">custom</span><span class="o">/</span>
</pre></div>
</div>
<p>Add the following lines in the <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!webcomponents/
!package.json
!package-lock.json
!tsconfig.json
!vite.config.ts
</pre></div>
</div>
<p>Add the following lines in the <code class="docutils literal notranslate"><span class="pre">project.yaml</span></code> as <code class="docutils literal notranslate"><span class="pre">managed_files</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\.dockerignore</span>
</pre></div>
</div>
</section>
<section id="add-it-to-the-interface-template">
<h2>Add it to the interface template<a class="headerlink" href="#add-it-to-the-interface-template" title="Link to this heading">¶</a></h2>
<p>Then we will include the following HTML in the canvas element, in <code class="docutils literal notranslate"><span class="pre">geoportal/interfaces/desktop.html.mako</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">`html</span>
<span class="pre">&lt;gmf-tool-button</span> <span class="pre">slot=&quot;tool-button&quot;</span> <span class="pre">iconClasses=&quot;fas</span> <span class="pre">fa-file-signature&quot;</span> <span class="pre">panelName=&quot;feedback&quot;&gt;&lt;/gmf-tool-button&gt;</span>
<span class="pre">`</span></code></p>
<p>The panel will be included with the following HTML:</p>
<p><code class="docutils literal notranslate"><span class="pre">`html</span>
<span class="pre">&lt;proj-feedback</span> <span class="pre">slot=&quot;tool-panel-feedback&quot;&gt;&lt;/proj-feedback&gt;</span>
<span class="pre">`</span></code></p>
<p>The modifications in the <code class="docutils literal notranslate"><span class="pre">vars</span></code> file are:
- Add the JavaScript file as <code class="docutils literal notranslate"><span class="pre">gmfCustomJavascriptUrl</span></code>.
- Be sure that we have the CSS file as <code class="docutils literal notranslate"><span class="pre">gmfCustomStylesheetUrl</span></code>.
- Add in comment all the needed configuration to be able to debug.</p>
<p>Apply the following diff in the <code class="docutils literal notranslate"><span class="pre">geoportal/vars.yaml</span></code>:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> vars:
<span class="w"> </span>   interfaces_config:
<span class="w"> </span>     desktop:
<span class="w"> </span>       constants:
<span class="gi">+</span>
<span class="gi">+         # For dev, the corresponding values in static should also be commented.</span>
<span class="gi">+         # gmfCustomJavascriptUrl:</span>
<span class="gi">+         #   - https://localhost:3001/@vite/client</span>
<span class="gi">+         #   - https://localhost:3001/webcomponents/index.ts</span>
<span class="gi">+</span>
<span class="gi">+         # Used in the web component to get the service URL based on `gmfBase`.</span>
<span class="gi">+         sitnFeedbackPath: custom/feedback</span>
<span class="gi">+</span>
<span class="gi">+       static:</span>
<span class="gi">+         # Those two lines should be commented in dev mode.</span>
<span class="gi">+         gmfCustomJavascriptUrl:</span>
<span class="gi">+           name: &#39;/etc/geomapfish/static/custom/custom.es.js&#39;</span>
<span class="gi">+         gmfCustomStylesheetUrl:</span>
<span class="gi">+           name: /etc/geomapfish/static/css/desktop_alt.css</span>
<span class="gi">+</span>
<span class="gi">+       routes:</span>
<span class="gi">+         gmfBase:</span>
<span class="gi">+           name: base</span>

<span class="gi">+   # For dev this line is needed to allow the page to load the files from Vite dev server.</span>
<span class="gi">+   # content_security_policy_main_script_src_extra: &quot;http://localhost:3001&quot;</span>
</pre></div>
</div>
</section>
<section id="debugging-custom-javascript-and-service">
<h2>Debugging Custom JavaScript and service<a class="headerlink" href="#debugging-custom-javascript-and-service" title="Link to this heading">¶</a></h2>
<p>The usual build and run will also work for the custom JavaScript and service.
Build and run as usual:</p>
<p>To have a development environment with auto-reload mode, we will start the Vite dev server
locally on port <code class="docutils literal notranslate"><span class="pre">3001</span></code>.</p>
<p>We also need to get the file from the Vite dev server, for that we need to do the following modifications
in the <code class="docutils literal notranslate"><span class="pre">geoportal/vars.yaml</span></code> (don’t commit them):</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>          # For dev, the corresponding values in static should also be removed.
<span class="gd">-          # gmfCustomJavascriptUrl:</span>
<span class="gd">-          #   - https://localhost:3001/@vite/client</span>
<span class="gd">-          #   - https://localhost:3001/webcomponents/index.ts</span>
<span class="gi">+          gmfCustomJavascriptUrl:</span>
<span class="gi">+            - https://localhost:3001/@vite/client</span>
<span class="gi">+            - https://localhost:3001/webcomponents/index.ts</span>


<span class="w"> </span>          # Those two lines should be commented in dev mode.
<span class="gd">-          gmfCustomJavascriptUrl:</span>
<span class="gd">-            name: &#39;/etc/geomapfish/static/custom/custom.es.js&#39;</span>
<span class="gi">+          # gmfCustomJavascriptUrl:</span>
<span class="gi">+          #   name: &#39;/etc/geomapfish/static/custom/custom.es.js&#39;</span>


<span class="w"> </span>    # For dev this line is needed to allow the page to load the files from Vite dev server.
<span class="gd">-    # content_security_policy_main_script_src_extra: &quot;http://localhost:3001&quot;</span>
<span class="gi">+    content_security_policy_main_script_src_extra: &quot;http://localhost:3001&quot;</span>
</pre></div>
</div>
<p>Rename the <code class="docutils literal notranslate"><span class="pre">docker-compose.override.sample.yaml</span></code> file to <code class="docutils literal notranslate"><span class="pre">docker-compose.override.yaml</span></code>.</p>
<p>Build and run as usual.</p>
<p>Download and start the Vite dev server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">npm<span class="w"> </span>install</span>
<span class="prompt1">npm<span class="w"> </span>run<span class="w"> </span>dev</span>
</pre></div></div></section>
<section id="extend-the-geoportal-image">
<h2>Extend the geoportal image<a class="headerlink" href="#extend-the-geoportal-image" title="Link to this heading">¶</a></h2>
<p>If you need to configure your own authentication you will need to extend the <code class="docutils literal notranslate"><span class="pre">geoportal</span></code> Docker image.</p>
<p>For that you will need to create a new folder named <code class="docutils literal notranslate"><span class="pre">geoportal_custom</span></code>.</p>
<p>An this folder, add a file named <code class="docutils literal notranslate"><span class="pre">authentication.py</span></code> with the content you need, the original content is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>

<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
<span class="kn">from</span> <span class="nn">c2cgeoportal_geoportal.lib.authentication</span> <span class="kn">import</span> <span class="n">create_authentication</span>


<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Configurator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the authentication( for a Pyramid app.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">ACLAuthorizationPolicy</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">create_authentication</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()))</span>
</pre></div>
</div>
<p>Create a file named <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> with the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ARG GEOMAPFISH_MAIN_VERSION

FROM camptocamp/geomapfish:${GEOMAPFISH_MAIN_VERSION} as runner

COPY authentication.py /app/geomapfishapp_geoportal/
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> file do the following changes:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>   geoportal:
<span class="w"> </span>     extends:
<span class="w"> </span>       file: docker-compose-lib.yaml
<span class="w"> </span>       service: geoportal
<span class="gi">+     image: ${DOCKER_BASE}-geoportal:${DOCKER_TAG}</span>
<span class="gi">+     build:</span>
<span class="gi">+       context: geoportal_custom</span>
<span class="gi">+       args:</span>
<span class="gi">+         GIT_HASH: ${GIT_HASH}</span>
<span class="gi">+         GEOMAPFISH_VERSION: ${GEOMAPFISH_VERSION}</span>
<span class="gi">+         GEOMAPFISH_MAIN_VERSION: ${GEOMAPFISH_MAIN_VERSION}</span>
<span class="w"> </span>     volumes_from:
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>With these changes, you can add your own authentication logic, but be aware that this logic may need
to be adapted when migrating to future versions of GeoMapFish.</p>
</div>
</section>
<section id="interfaces">
<h2>Interfaces<a class="headerlink" href="#interfaces" title="Link to this heading">¶</a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">vars.yaml</span></code> file, you can add your own interface in the <code class="docutils literal notranslate"><span class="pre">interfaces</span></code> section.</p>
<p>The interface has the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: the name of the interface, used to build the interfaces routes end to get the html files names.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code>: if the interface is the default one, will be available on ‘/’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>: the type of the interface, can be <code class="docutils literal notranslate"><span class="pre">ngeo</span></code>, <code class="docutils literal notranslate"><span class="pre">canvas</span></code> or <code class="docutils literal notranslate"><span class="pre">custom</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">layout</span></code>: Used to get the JavaScript and CSS files in canvas mode.</p></li>
</ul>
<section id="ngeo">
<h3><code class="docutils literal notranslate"><span class="pre">ngeo</span></code><a class="headerlink" href="#ngeo" title="Link to this heading">¶</a></h3>
<p>The interface type <code class="docutils literal notranslate"><span class="pre">ngeo</span></code> is the older one, is used a standard ngeo application</p>
<p>In simple application mode the name can be one of the following:
<code class="docutils literal notranslate"><span class="pre">desktop</span></code>, <code class="docutils literal notranslate"><span class="pre">mobile</span></code>, <code class="docutils literal notranslate"><span class="pre">mobile_alt</span></code>, <code class="docutils literal notranslate"><span class="pre">iframe_api</span></code> or <code class="docutils literal notranslate"><span class="pre">oeedit</span></code>.</p>
</section>
<section id="canvas">
<h3><code class="docutils literal notranslate"><span class="pre">canvas</span></code><a class="headerlink" href="#canvas" title="Link to this heading">¶</a></h3>
<p>The interface type <code class="docutils literal notranslate"><span class="pre">canvas</span></code> is a layout based on a canvas, it offer more flexibility in simple application mode</p>
<p>See <a class="reference internal" href="#extend-application-canvas"><span class="std std-ref">Canvas section</span></a> for more information.</p>
</section>
<section id="custom">
<h3><code class="docutils literal notranslate"><span class="pre">custom</span></code><a class="headerlink" href="#custom" title="Link to this heading">¶</a></h3>
<p>The interface type <code class="docutils literal notranslate"><span class="pre">custom</span></code> is a custom interface, it can be used to create a new interface based on
another build tool like Vite. With this mode you are able to use an other interface like
<a class="reference external" href="https://gitlab.com/geogirafe/gg-viewer">GeoGirafe</a>.</p>
<p>This is working in simple application mode.</p>
<p>See <a class="reference internal" href="#extend-application-webcomponent"><span class="std std-ref">WebComponent section</span></a> for more information.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo of c2cgeoportal"/>
            </a></p>
<h1 class="logo"><a href="../index.html">c2cgeoportal</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=camptocamp&repo=c2cgeoportal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../administrator/index.html">Administrator Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Integrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
  <li><a href="features.html">Additional features</a><ul>
      <li>Previous: <a href="vector_tiles.html" title="previous chapter">Vector tiles</a></li>
      <li>Next: <a href="docker.html" title="next chapter">Use Docker to deploy your application</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2011-2025, Camptocamp.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/integrator/extend_application.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>