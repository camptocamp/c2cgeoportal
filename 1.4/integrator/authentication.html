

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Authentication &mdash; c2cgeoportal  documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="c2cgeoportal  documentation" href="../index.html" />
    <link rel="up" title="Integrator Guide" href="index.html" />
    <link rel="next" title="Mobile Applications" href="mobile.html" />
    <link rel="prev" title="Deploy the application" href="deploy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mobile.html" title="Mobile Applications"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="deploy.html" title="Deploy the application"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">c2cgeoportal  documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Integrator Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="authentication">
<span id="integrator-authentication"></span><h1>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-default-policy">
<h2>The default policy<a class="headerlink" href="#the-default-policy" title="Permalink to this headline">¶</a></h2>
<p>By default <tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> applications use an <em>auth ticket</em> authentication
policy (<tt class="docutils literal"><span class="pre">AuthTktAuthenticationPolicy</span></tt>). With this policy the user name is
obtained from the &#8220;auth ticket&#8221; cookie set in the request.</p>
<p>The policy is created, and added to the application&#8217;s configuration, in the
application&#8217;s main <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file.</p>
</div>
<div class="section" id="using-another-policy">
<h2>Using another policy<a class="headerlink" href="#using-another-policy" title="Permalink to this headline">¶</a></h2>
<p>When using <tt class="docutils literal"><span class="pre">AuthTktAuthenticationPolicy</span></tt> an &#8220;auth ticket&#8221; cookie should be
set in the request for the user to be identified. In some applications using
another identification mechanism may be needed.</p>
<div class="section" id="example-with-a-remote-user-policy">
<h3>Example with a &#8220;remote user&#8221; policy<a class="headerlink" href="#example-with-a-remote-user-policy" title="Permalink to this headline">¶</a></h3>
<p>For example, in a project of ours, the c2cgeoportal application needs to
integrate with the Nevis single sign-on environment. This SSO system is
composed of a central auth server, and a proxy running as an Apache module.
The proxy takes care of communicating with the auth server, and sets the
username in the <tt class="docutils literal"><span class="pre">REMOTE_USER</span></tt> environment variable when the user has been
identified. With this system an &#8220;auth ticket&#8221; policy cannot be used, obviously.
A <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/1.3-branch/api/authentication.html#pyramid.authentication.RemoteUserAuthenticationPolicy">&#8220;remote user&#8221; authentication policy</a>
should be used instead.</p>
<p>To use a &#8220;remote user&#8221; authentication policy edit the application&#8217;s
main <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file, and set <tt class="docutils literal"><span class="pre">authentication_policy</span></tt> to a
<tt class="docutils literal"><span class="pre">RemoteUserAuthenticationPolicy</span></tt> instance:</p>
<div class="highlight-python"><pre>from pyramid.config import Configurator
from pyramid.authentication import RemoteUserAuthenticationPolicy
from c2cgeoportal import locale_negotiator
from c2cgeoportal.resources import FAModels, defaultgroupsfinder
from ${package}.resources import Root

def main(global_config, **settings):
    """ This function returns a Pyramid WSGI application.
    """
    authentication_policy = RemoteUserAuthenticationPolicy(
            callback=defaultgroupsfinder)
    config = Configurator(root_factory=Root, settings=settings,
            locale_negotiator=locale_negotiator,
            authentication_policy=authentication_policy)
    # ...</pre>
</div>
<p><tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> provides an authentication policy callback, namely
<tt class="docutils literal"><span class="pre">defaultgroupsfinder</span></tt>, that is appropriate in most cases. This callback
assumes that <tt class="docutils literal"><span class="pre">request.user.role</span></tt> is a reference to the <tt class="docutils literal"><span class="pre">Role</span></tt> database
object (more information below). This callback is required for admin users to
be able to access to the admin interface.</p>
<p>It is important to note that when using a &#8220;remote user&#8221; authentication policy
the authentication process is delegated to an outside system. So calls to
<tt class="docutils literal"><span class="pre">pyramid.security.remember</span></tt> and <tt class="docutils literal"><span class="pre">pyramid.security.forget</span></tt>, as done in
c2cgeoportal&#8217;s <tt class="docutils literal"><span class="pre">login</span></tt> and <tt class="docutils literal"><span class="pre">logout</span></tt> views, have no effect.</p>
<p>With an authentication policy set in the application configuration the user
name can be obtained by calling <tt class="docutils literal"><span class="pre">pyramid.security.unauthenticated_userid</span></tt>.
(This function returns <tt class="docutils literal"><span class="pre">None</span></tt> if there&#8217;s currently no authenticated user.)
But c2cgeoportal applications need to also know about the user&#8217;s <em>role</em> to
work properly.</p>
<p>So when using an external authentication system this system should also provide
the c2cgeoportal application with the name of the user&#8217;s role. This can be done
in <tt class="docutils literal"><span class="pre">apache/wsgi.conf.in</span></tt> by relying on the <a class="reference external" href="http://httpd.apache.org/docs/2.2/mod/mod_setenvif.html">mod_setenvif</a> Apache module&#8217;s
<tt class="docutils literal"><span class="pre">SetEnvIf</span></tt> directive. For example:</p>
<div class="highlight-python"><pre>SetEnvIf isiwebsectoken &lt;role&gt;(.*)&lt;/role&gt; rolename=$1</pre>
</div>
<p>or:</p>
<div class="highlight-python"><pre>SetEnvIf isiwebsectoken '&lt;field name="roles"&gt;([a-zA-Z0-9,\.]*)&lt;/field&gt;' rolename=$1</pre>
</div>
<p>With this <tt class="docutils literal"><span class="pre">mod_setenvif</span></tt> extracts the role name from the <tt class="docutils literal"><span class="pre">isiwebsectoken</span></tt> header
and places it in the <tt class="docutils literal"><span class="pre">rolename</span></tt> environment variable. See the <tt class="docutils literal"><span class="pre">mod_setenvif</span></tt>
documentation for more details.</p>
<p>The connection between the nevisProxy and the application is established using
an Apache module called NINAP. The above Apache configuration may also contain
NINAP directives (see nevisProxy documentation). For instance to indicate what
field in the <tt class="docutils literal"><span class="pre">isiwebsectoken</span></tt> header contains the username:</p>
<div class="highlight-python"><pre>NINAP_UserPattern '&lt;field name="loginId"&gt;([a-zA-Z0-9\._-]*)&lt;/field&gt;'</pre>
</div>
<p>Eventually the following directives activate the access restriction to the
application:</p>
<div class="highlight-python"><pre>&lt;Location /&lt;instance_id&gt;/wsgi&gt;
  AuthType sectoken
  Require valid-user
&lt;/Location&gt;</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> code expects that the user data (user name, role name and
user functionalities) are available through the <tt class="docutils literal"><span class="pre">user</span></tt> property in the
<tt class="docutils literal"><span class="pre">request</span></tt> object. More specifically it expects <tt class="docutils literal"><span class="pre">request.user.role.id</span></tt> to
contain the role id, and <tt class="docutils literal"><span class="pre">request.user.role.name</span></tt> to contain the role name.
<tt class="docutils literal"><span class="pre">request.user.username</span></tt> and <tt class="docutils literal"><span class="pre">request.user.functionalities</span></tt> must be provided
as well.
Therefore the application should redefine the callback function that adds
a <tt class="docutils literal"><span class="pre">user</span></tt> property to the request. This is done by calling the
<tt class="docutils literal"><span class="pre">set_request_property</span></tt> function on the <tt class="docutils literal"><span class="pre">Configurator</span></tt> object.
You may for example add to <tt class="docutils literal"><span class="pre">__init__.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">unauthenticated_userid</span>

<span class="k">def</span> <span class="nf">get_user_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">c2cgeoportal.models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">Role</span>
    <span class="k">class</span> <span class="nc">O</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">unauthenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">O</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">rolename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rolename&#39;</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">DBSession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Role</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">rolename</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">functionalities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">user</span>
</pre></div>
</div>
<p>And then, in the application&#8217;s <tt class="docutils literal"><span class="pre">main</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">set_request_property</span><span class="p">(</span><span class="n">get_user_from_request</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span>
                            <span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">reify</span></tt> argument is to <tt class="docutils literal"><span class="pre">True</span></tt> to cache the function&#8217;s return value and
actually execute the function only once per request. In this example the user
name is obtained by calling <tt class="docutils literal"><span class="pre">unauthenticated_userid</span></tt>, itself relying on the
authentication policy set in the application. The role object is obtained from
the value of the <tt class="docutils literal"><span class="pre">rolename</span></tt> environment variable by querying the database.</p>
<p>Please note that <tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> expects the admin role to be <tt class="docutils literal"><span class="pre">role_admin</span></tt>.
If for some reason you need to use another name for this role, you may define
an alias in a project-specific callback and use it instead of the standard
<tt class="docutils literal"><span class="pre">defaultgroupsfinder</span></tt> as <tt class="docutils literal"><span class="pre">AuthenticationPolicy</span></tt> argument in <tt class="docutils literal"><span class="pre">__init__.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mygroupsfinder</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span>
    <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&lt;your_admin_rolename&gt;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;role_admin&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">role</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">authentication_policy</span> <span class="o">=</span> <span class="n">RemoteUserAuthenticationPolicy</span><span class="p">(</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">mygroupsfinder</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> registers its own request property callback for <tt class="docutils literal"><span class="pre">user</span></tt>.
The one registered by the application overwrites it.</p>
</div>
<p>You should be set at this point.</p>
</div>
</div>
<div class="section" id="custom-user-validation">
<h2>Custom user validation<a class="headerlink" href="#custom-user-validation" title="Permalink to this headline">¶</a></h2>
<p>For logging in <tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> validates the user credentials
(username/password) by reading the user information from the <tt class="docutils literal"><span class="pre">user</span></tt> database
table. If a c2cgeoportal application should work with another user information
source, like LDAP, another <em>client validation</em> mechanism should be set up.
<tt class="docutils literal"><span class="pre">c2cgeoportal</span></tt> provides a specific <tt class="docutils literal"><span class="pre">Configurator</span></tt> function for that, namely
<tt class="docutils literal"><span class="pre">set_user_validator</span></tt>. Here&#8217;s an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyramid_ldap</span> <span class="kn">import</span> <span class="n">get_ldap_connector</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">get_ldap_connector</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
<p>The validator function is passed three arguments: <tt class="docutils literal"><span class="pre">request</span></tt>, <tt class="docutils literal"><span class="pre">username</span></tt>,
and <tt class="docutils literal"><span class="pre">password</span></tt>. The function should return the user name if the credentials
are valid, and <tt class="docutils literal"><span class="pre">None</span></tt> otherwise.</p>
<p>In this example the <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid_ldap/en/latest/">pyramid_ldap package</a> is used as
the user information source.</p>
<p>User validators can obviously be chained. For example, a user validator
function that queries the <tt class="docutils literal"><span class="pre">user</span></tt> database table if the user does not exist in
LDAP would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">c2cgeoportal</span> <span class="kn">import</span> <span class="n">default_user_validator</span>
    <span class="kn">from</span> <span class="nn">pyramid_ldap</span> <span class="kn">import</span> <span class="n">get_ldap_connector</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">get_ldap_connector</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">default_user_validator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Authentication</a><ul>
<li><a class="reference internal" href="#the-default-policy">The default policy</a></li>
<li><a class="reference internal" href="#using-another-policy">Using another policy</a><ul>
<li><a class="reference internal" href="#example-with-a-remote-user-policy">Example with a &#8220;remote user&#8221; policy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-user-validation">Custom user validation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="deploy.html"
                        title="previous chapter">Deploy the application</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mobile.html"
                        title="next chapter">Mobile Applications</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/integrator/authentication.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="mobile.html" title="Mobile Applications"
             >next</a> |</li>
        <li class="right" >
          <a href="deploy.html" title="Deploy the application"
             >previous</a> |</li>
        <li><a href="../index.html">c2cgeoportal  documentation</a> &raquo;</li>
          <li><a href="index.html" >Integrator Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Camptocamp.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>