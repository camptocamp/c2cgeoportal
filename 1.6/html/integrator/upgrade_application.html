<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Upgrading a GeoMapFish application &mdash; c2cgeoportal  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="c2cgeoportal  documentation" href="../index.html" />
    <link rel="up" title="Integrator Guide" href="index.html" />
    <link rel="next" title="Configuring Windows tools required to connect to our servers" href="windows_tools.html" />
    <link rel="prev" title="Install an existing application" href="install_application.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="upgrading-a-geomapfish-application">
<span id="integrator-upgrade-application"></span><h1>Upgrading a GeoMapFish application<a class="headerlink" href="#upgrading-a-geomapfish-application" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">From version 1.6 we use Alembic instead of sqlachemy-migrate for database migration.
Then to upgrade to GeoMapFish 1.6, integrators must start from the very last release
of 1.5 since the upgrades to 1.5 are no longer available with the new tool.</p>
</div>
<div class="section" id="using-the-c2ctool-command">
<h2>Using the c2ctool command<a class="headerlink" href="#using-the-c2ctool-command" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">c2ctool</span></code> is a tool to facilitate the common operations around GeoMapFish.</p>
</div>
<div class="section" id="easy-updating-an-application-code">
<h2>Easy updating an application code<a class="headerlink" href="#easy-updating-an-application-code" title="Permalink to this headline">¶</a></h2>
<pre class="highlight"><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">make -f &lt;makefile&gt; update</span>
<span class="prompt1">make -f &lt;makefile&gt; build</span>
</pre><p>Where <code class="docutils literal"><span class="pre">&lt;makefile&gt;</span></code> is your user make file (<code class="docutils literal"><span class="pre">&lt;user&gt;.mk</span></code>).</p>
</div>
<div class="section" id="easy-upgrading-an-application">
<h2>Easy upgrading an application<a class="headerlink" href="#easy-upgrading-an-application" title="Permalink to this headline">¶</a></h2>
<p>Verify that your <code class="docutils literal"><span class="pre">project.yaml.mako</span></code> file is like the following:</p>
<div class="code yaml highlight-default"><div class="highlight"><pre><span></span>project_folder: &lt;project_folder&gt;
project_package: ${package}
host: &lt;host&gt;
checker_path: /${instanceid}/wsgi/check_collector?
template_vars:
    package: ${package}
    srid: ${srid}
    extent: &lt;application_extent&gt;
    mobile_application_title: &lt;mobile_application_title&gt;
    apache_vhost: &lt;apache_vhost&gt;
</pre></div>
</div>
<p>Where <code class="docutils literal"><span class="pre">&lt;project_folder&gt;</span></code> is the last element of the folder e.g. for
<code class="docutils literal"><span class="pre">/home/user/my_geomapfish</span></code> it will be <code class="docutils literal"><span class="pre">my_geomapfish</span></code>,</p>
<p>the <code class="docutils literal"><span class="pre">&lt;host&gt;</span></code> is the host to use for the Apache VirtualHost,</p>
<p>the <code class="docutils literal"><span class="pre">&lt;application_extent&gt;</span></code> is the application extent (e.g. 489246, 78873, 837119, 296543),</p>
<p>and the <code class="docutils literal"><span class="pre">&lt;apache_vhost&gt;</span></code> is the vhost folder name e.g. if your application is in
<code class="docutils literal"><span class="pre">/var/www/vhosts/geomapfish-demo/private/my_geomapfish</span></code> if will be <code class="docutils literal"><span class="pre">geomapfish-demo</span></code>.</p>
<p>In the <code class="docutils literal"><span class="pre">setup.py</span></code> be sure not to specify a <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> version,
because it will prevent the installation of the new <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> egg.</p>
<p>Then run (for Linux):</p>
<pre class="highlight"><span class="prompt1">.build/venv/bin/c2ctool upgrade &lt;makefile&gt; &lt;target_version&gt;</span>
</pre><p>Where <code class="docutils literal"><span class="pre">&lt;makefile&gt;</span></code> is your user make file (<code class="docutils literal"><span class="pre">&lt;user&gt;.mk</span></code>),
<code class="docutils literal"><span class="pre">&lt;target_version&gt;</span></code> is the version that you wish to upgrade to
(for the development version it should be &#8216;master&#8217;).</p>
<p>And follow the instructions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For Windows:</p>
<p>If you are using Windows, you will have to execute some steps prior
to the instructions hereunder:</p>
<ul>
<li><p class="first">Uninstall manually the old c2cgeoportal egg:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">.build/venv/Scripts/pip</span> <span class="pre">uninstall</span> <span class="pre">c2cgeoportal-win</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Clean / remove the generated files:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">make</span> <span class="pre">-f</span> <span class="pre">&lt;makefile&gt;</span> <span class="pre">clean</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Change the version in <code class="docutils literal"><span class="pre">setup.py</span></code> and <code class="docutils literal"><span class="pre">CONST_requirements_windows.txt</span></code>
to the version you wish to install.</p>
</li>
<li><p class="first">Build your application:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">make</span> <span class="pre">-f</span> <span class="pre">&lt;makefile&gt;</span> <span class="pre">build</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Put your modifications under git revision:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">setup.py</span></code></p>
<p><code class="docutils literal"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">CONST_requirements_windows.txt</span></code></p>
<p><code class="docutils literal"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-m</span> <span class="pre">&quot;Upgrade</span> <span class="pre">c2cgeoportal</span> <span class="pre">version&quot;</span></code></p>
<p><code class="docutils literal"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">&lt;remote&gt;</span> <span class="pre">&lt;branch&gt;</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Follow the Windows instructions hereunder, note that you will have to use
<code class="docutils literal"><span class="pre">.build\venv\Scripts\...</span></code> instead of <code class="docutils literal"><span class="pre">.build\venv\bin\...</span></code> in all given
commands</p>
</li>
</ul>
<p>And, run:</p>
<pre class="highlight"><span class="prompt1">.build/venv/Scripts/c2ctool upgrade --windows &lt;makefile&gt; <span class="se">\</span>
     &lt;target_version&gt;</span>
</pre></div>
</div>
<div class="section" id="easy-upgrading-an-application-from-1-5-to-1-6">
<h2>Easy upgrading an application from 1.5 to 1.6<a class="headerlink" href="#easy-upgrading-an-application-from-1-5-to-1-6" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure that your database uses PostGIS 2. To migrate
a PostGIS 1.5 database to PostGIS 2, please follow the
<a class="reference external" href="upgrade_application.html#migrating-database-to-postgis-2-x">instructions</a>.</p>
</div>
<p>Before upgrading your project, it is recommended to create a new
branch and to push it to the remote repository:</p>
<pre class="highlight"><span class="prompt1">git checkout -b 1.6</span>
<span class="prompt1">git push origin 1.6</span>
</pre><p>Create a <code class="docutils literal"><span class="pre">project.yaml.mako</span></code> file that contains:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span>project_folder: &lt;project_folder&gt;
project_package: ${package}
host: &lt;host&gt;
checker_path: /${instanceid}/wsgi/check_collector?
template_vars:
    package: ${package}
    srid: ${srid}
    extent: &lt;application_extent&gt;
    mobile_application_title: &lt;mobile_application_title&gt;
    apache_vhost: &lt;apache_vhost&gt;
</pre></div>
</div>
<p>Where <code class="docutils literal"><span class="pre">&lt;project_folder&gt;</span></code> is the last element of the folder e.g. for
<code class="docutils literal"><span class="pre">/home/user/my_geomapfish</span></code> it will be <code class="docutils literal"><span class="pre">my_geomapfish</span></code>,</p>
<p>the <code class="docutils literal"><span class="pre">&lt;host&gt;</span></code> is the host to use for the Apache VirtualHost,</p>
<p>the <code class="docutils literal"><span class="pre">&lt;application_extent&gt;</span></code> is the application extent (e.g. 489246, 78873, 837119, 296543),</p>
<p>and the <code class="docutils literal"><span class="pre">&lt;apache_vhost&gt;</span></code> is the vhost folder name e.g. if your application is in
<code class="docutils literal"><span class="pre">/var/www/vhosts/geomapfish-demo/private/my_geomapfish</span></code> if will be <code class="docutils literal"><span class="pre">geomapfish-demo</span></code>.</p>
<p>Add <code class="docutils literal"><span class="pre">/project.yaml</span></code> and <code class="docutils literal"><span class="pre">/.build</span></code> to the <code class="docutils literal"><span class="pre">.gitignore</span></code> file.</p>
<p>Get the right version of the egg:</p>
<pre class="highlight"><span class="prompt1">mkdir .build</span>
<span class="prompt1">virtualenv --setuptools --no-site-packages .build/venv</span>
<span class="prompt1">.build/venv/bin/pip install <span class="se">\</span>
     --index-url http://pypi.camptocamp.net/pypi <span class="se">\</span>
     <span class="s1">&#39;pip&gt;=7&#39;</span> <span class="s1">&#39;setuptools&gt;=12&#39;</span></span>
<span class="prompt1">.build/venv/bin/pip install <span class="se">\</span>
     --index-url http://pypi.camptocamp.net/pypi <span class="se">\</span>
     --trusted-host pypi.camptocamp.net <span class="se">\</span>
     --find-links http://pypi.camptocamp.net/internal-pypi/index/c2cgeoportal <span class="se">\</span>
     https://github.com/camptocamp/pyramid_closure/archive/819bc43420b3cd924d8698c5a9606592c19dbb15.zip#egg<span class="o">=</span>pyramid_closure <span class="se">\</span>
     https://github.com/Pylons/pyramid/archive/1e02bbfc0df09259bf207112acf019c8dba44a90.zip#egg<span class="o">=</span>pyramid <span class="se">\</span>
     <span class="nv">c2cgeoportal</span><span class="o">==</span>&lt;egg_version&gt;</span>
</pre><p>Where <code class="docutils literal"><span class="pre">&lt;egg_version&gt;</span></code> can be <em>1.6.0</em> for the first stable version.</p>
<p>Get the new required files from the c2cgeoportal templates:</p>
<pre class="highlight"><span class="prompt1">.build/venv/bin/pcreate --interactive -s c2cgeoportal_create <span class="se">\</span>
     /tmp/&lt;project&gt; <span class="nv">package</span><span class="o">=</span>&lt;package&gt; <span class="nv">srid</span><span class="o">=</span>21781</span>
<span class="prompt1">.build/venv/bin/pcreate --interactive -s c2cgeoportal_update <span class="se">\</span>
     /tmp/&lt;project&gt; <span class="nv">package</span><span class="o">=</span>&lt;package&gt;</span>
<span class="prompt1">cp /tmp/&lt;project&gt;/CONST_Makefile <span class="se">\</span>
     /tmp/&lt;project&gt;/CONST_requirements_windows.txt <span class="se">\</span>
     /tmp/&lt;project&gt;/CONST_dev-requirements.txt <span class="se">\</span>
     /tmp/&lt;project&gt;/CONST_requirements.txt <span class="se">\</span>
     /tmp/&lt;project&gt;/CONST_packages.yaml <span class="se">\</span>
     /tmp/&lt;project&gt;/CONST_versions.txt <span class="se">\</span>
     /tmp/&lt;project&gt;/CONST_vars.yaml <span class="se">\</span>
     /tmp/&lt;project&gt;/&lt;package&gt;.mk <span class="se">\</span>
     /tmp/&lt;project&gt;/vars_&lt;package&gt;.yaml .</span>
<span class="prompt1">mkdir -p print/WEB-INF/classes</span>
<span class="prompt1">cp /tmp/&lt;project&gt;/print/WEB-INF/classes/logback.xml.mako print/WEB-INF/classes</span>
<span class="prompt1">rm -rf /tmp/&lt;project&gt;</span>
</pre><p>Create your own <code class="docutils literal"><span class="pre">&lt;user&gt;.mk</span></code>:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">INSTANCE_ID</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">instanceid</span><span class="o">&gt;</span>
<span class="n">DEVELOPMENT</span> <span class="o">=</span> <span class="n">TRUE</span>

<span class="n">include</span> <span class="o">&lt;</span><span class="n">package</span><span class="o">&gt;.</span><span class="n">mk</span>
</pre></div>
</div>
<p>In the <code class="docutils literal"><span class="pre">setup.py</span></code> file make sure that <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> is listed in the <code class="docutils literal"><span class="pre">install_requires</span></code> parameter.</p>
<p>Add all your new files in git and commit them:</p>
<pre class="highlight"><span class="prompt1">git add project.yaml.mako CONST_* &lt;package&gt;.mk <span class="se">\</span>
     vars_&lt;package&gt;.yaml &lt;user&gt;.mk .gitignore</span>
<span class="prompt1">git rm project.yaml</span>
<span class="prompt1">git commit -m <span class="s2">&quot;Initialize the upgrade to 1.6&quot;</span></span>
</pre><p>Start the c2ctool upgrade:</p>
<pre class="highlight"><span class="prompt1">rm -rf .build/*</span>
<span class="prompt1">make -f &lt;makefile&gt; project.yaml .build/requirements.timestamp</span>
<span class="prompt1">.build/venv/bin/c2ctool upgrade &lt;makefile&gt; &lt;target_version&gt;</span>
</pre><p>Where <code class="docutils literal"><span class="pre">&lt;makefile&gt;</span></code> is your user make file (<code class="docutils literal"><span class="pre">&lt;user&gt;.mk</span></code>),
<code class="docutils literal"><span class="pre">&lt;target_version&gt;</span></code> is the version that you wish to upgrade to
(for the development version it should be &#8216;master&#8217;).</p>
<p>And follow the instructions.</p>
</div>
<div class="section" id="upgrading-cgxp-advanced-version">
<h2>Upgrading CGXP (advanced version)<a class="headerlink" href="#upgrading-cgxp-advanced-version" title="Permalink to this headline">¶</a></h2>
<p>To upgrade CGXP to a release tag (like 1.3.0) use the following:</p>
<pre class="highlight"><span class="prompt1"><span class="nb">cd</span> &lt;package&gt;/static/lib/cgxp</span>
<span class="prompt1">git fetch</span>
<span class="prompt1">git checkout &lt;tag&gt;</span>
<span class="prompt1">git submodule sync</span>
<span class="prompt1">git submodule update --init</span>
</pre><p><code class="docutils literal"><span class="pre">&lt;package&gt;</span></code> is to be replaced by the name of your application package name,
<code class="docutils literal"><span class="pre">&lt;tag&gt;</span></code> is the name of the release (in Git we use a tag),</p>
<p>To upgrade CGXP to a version branch (like 1.3) use the following:</p>
<pre class="highlight"><span class="prompt1"><span class="nb">cd</span> &lt;package&gt;/static/lib/cgxp</span>
<span class="prompt1">git fetch</span>
<span class="prompt1">git checkout &lt;branch&gt;</span>
<span class="prompt1">git pull origin &lt;branch&gt;</span>
<span class="prompt1">git submodule sync</span>
<span class="prompt1">git submodule update --init</span>
</pre><p><code class="docutils literal"><span class="pre">&lt;package&gt;</span></code> is to be replaced by the name of your application package name,
<code class="docutils literal"><span class="pre">&lt;branch&gt;</span></code> is the name of the version (in Git we use a branch).</p>
<p>If the application code is under Git you also need to update the application
to reference the new commit for the cgxp submodule:</p>
<pre class="highlight"><span class="prompt1"><span class="nb">cd</span> -</span>
<span class="prompt1">git add &lt;package&gt;/static/lib/cgxp</span>
</pre><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">We have a major issue here for applications under SVN. When SVN, as
opposed to Git, is used for the application the version of CGXP is
not fixed in the application. This means that each installation of
an application may work with a different version of CGXP.</p>
</div>
<p>Do manual migration steps based on what&#8217;s in the
<a class="reference external" href="https://github.com/camptocamp/cgxp/blob/master/CHANGELOG.rst">CHANGELOG</a>.</p>
</div>
<div class="section" id="upgrading-c2cgeoportal-advanced-version">
<h2>Upgrading c2cgeoportal (advanced version)<a class="headerlink" href="#upgrading-c2cgeoportal-advanced-version" title="Permalink to this headline">¶</a></h2>
<p>Upgrading an application to a new release of c2cgeoportal requires several
steps:</p>
<ol class="arabic">
<li><p class="first">It&#8217;s good to start an upgrade in a clean repository, then:</p>
<ul>
<li><p class="first">See what&#8217;s not commited:</p>
<pre class="highlight"><span class="prompt1">git status</span>
</pre></li>
<li><p class="first">Reset non commited changes:</p>
<pre class="highlight"><span class="prompt1">git reset --hard</span>
</pre></li>
<li><p class="first">Remove all untracked files and directories:</p>
<pre class="highlight"><span class="prompt1">git clean -f -d</span>
</pre></li>
</ul>
</li>
<li><p class="first">Now, to update the application&#8217;s other dependencies,
get the <code class="docutils literal"><span class="pre">versions</span></code> file:</p>
<pre class="highlight"><span class="prompt1">wget https://raw.github.com/camptocamp/c2cgeoportal/&lt;version&gt;/c2cgeoportal/scaffolds/update/CONST_versions.txt -O CONST_versions.txt</span>
<span class="prompt1">wget https://raw.github.com/camptocamp/c2cgeoportal/&lt;version&gt;/c2cgeoportal/scaffolds/update/CONST_requirements.txt -O CONST_requirements.txt</span>
</pre><p>Replace <code class="docutils literal"><span class="pre">&lt;version&gt;</span></code> by a version number (branch) or release number (tag).
To get the last dev version, replace <code class="docutils literal"><span class="pre">&lt;version&gt;</span></code> by <code class="docutils literal"><span class="pre">master</span></code>.</p>
<p>For example to get the <code class="docutils literal"><span class="pre">versions</span></code> file of version 1.6, type:</p>
<pre class="highlight"><span class="prompt1">wget https://raw.github.com/camptocamp/c2cgeoportal/1.6/c2cgeoportal/scaffolds/update/CONST_versions.txt -O CONST_versions.txt</span>
<span class="prompt1">wget https://raw.github.com/camptocamp/c2cgeoportal/1.6/c2cgeoportal/scaffolds/update/CONST_requirements.txt -O CONST_requirements.txt</span>
</pre></li>
<li><p class="first">Execute <code class="docutils literal"><span class="pre">make</span></code> to get the new <code class="docutils literal"><span class="pre">c2cgeoportal</span></code> version:</p>
<pre class="highlight"><span class="prompt1">make -f &lt;user&gt;.mk build</span>
</pre></li>
<li><p class="first">Apply the <code class="docutils literal"><span class="pre">c2cgeoportal_update</span></code> scaffold:</p>
<pre class="highlight"><span class="prompt1">.build/venv/bin/pcreate --interactive -s c2cgeoportal_update ../&lt;project&gt; <span class="nv">package</span><span class="o">=</span>&lt;package&gt;</span>
</pre><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Don&#8217;t add any &#8216;/&#8217; after the project name.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">&lt;package&gt;</span></code> is to be replaced by the name of the application module.
See above for more information.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For Windows:</p>
<p>The <code class="docutils literal"><span class="pre">$PROJECT/static/mobile/touch.tar.gz</span></code> archive must be uncompressed and then removed.</p>
<p>If it&#8217;s not present, proceed as follows:</p>
<ul class="last simple">
<li>Get Sencha Touch at <a class="reference external" href="http://cdn.sencha.io/touch/sencha-touch-2.3.1-gpl.zip">http://cdn.sencha.io/touch/sencha-touch-2.3.1-gpl.zip</a>.</li>
<li>Unzip it.</li>
<li>Open a terminal and go to the folder where you have unzipped Sencha Touch.</li>
<li>Run <code class="docutils literal"><span class="pre">sencha</span> <span class="pre">generate</span> <span class="pre">app</span> <span class="pre">TempApp</span> <span class="pre">C:/tmp/TempApp</span></code>.</li>
<li>Copy the <code class="docutils literal"><span class="pre">C:/tmp/TempApp/touch</span></code> to your project in the folder <code class="docutils literal"><span class="pre">&lt;package&gt;/static/mobile/touch</span></code>.</li>
<li>Remove the generated app (<code class="docutils literal"><span class="pre">C:/tmp/TempApp</span></code>).</li>
</ul>
</div>
</li>
<li><p class="first">Do manual migration steps based on what&#8217;s in the <code class="docutils literal"><span class="pre">CONST_CHANGELOG.txt</span></code>
file.</p>
</li>
<li><p class="first">Execute <code class="docutils literal"><span class="pre">make</span></code> to rebuild and install the application:</p>
<pre class="highlight"><span class="prompt1">make -f &lt;user&gt;.mk build</span>
</pre></li>
<li><p class="first">Upgrade the database using the <code class="docutils literal"><span class="pre">alembic</span></code> script:</p>
<pre class="highlight"><span class="prompt1">.build/venv/bin/alembic upgrade head</span>
<span class="prompt1">.build/venv/bin/alembic -c alembic_static.ini upgrade head</span>
</pre></li>
<li><p class="first">Add the new files in the repository:</p>
<blockquote>
<div><p>Get informations on the status of the repository:</p>
<pre class="highlight"><span class="prompt1">git status</span>
</pre><p>Add the new files:</p>
<pre class="highlight"><span class="prompt1">git add &lt;file1&gt; &lt;file2&gt; ...</span>
</pre></div></blockquote>
</li>
</ol>
</div>
<div class="section" id="migrating-database-to-postgis-2-x">
<h2>Migrating database to Postgis 2.x<a class="headerlink" href="#migrating-database-to-postgis-2-x" title="Permalink to this headline">¶</a></h2>
<p>When migrating the database from Postgis 1.x to 2.x using the postgis_restore.pl
script, the table <code class="docutils literal"><span class="pre">&lt;schema_name&gt;.layer</span></code> (and related index and foreign key)
will cause some problem because the name is conflicting with an existing table
with the same name in the Postgis topology schema.</p>
<p>The easiest workaroud is to rename the table, index and foreign key before
creating the Postgres dump and reimporting the data with postgis_restore.pl.
Then renaming them back after the restoration.</p>
<p>First rename all the conflicting items:</p>
<blockquote>
<div><div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">INDEX</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layer_pkey</span> <span class="n">RENAME</span> <span class="n">TO</span> <span class="n">layertmp_pkey</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layer</span> <span class="n">ADD</span> <span class="n">CONSTRAINT</span> <span class="n">layertmp_id_fkey</span> <span class="n">FOREIGN</span> <span class="n">KEY</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="n">REFERENCES</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">treeitem</span><span class="p">(</span><span class="nb">id</span><span class="p">);</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layer</span> <span class="n">DROP</span> <span class="n">CONSTRAINT</span> <span class="n">layer_id_fkey</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layer</span> <span class="n">RENAME</span> <span class="n">TO</span> <span class="n">layertmp</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We can&#8217;t rename a foreign key, we have to create a new one before removing the
old one.</p>
</div>
<p>Then you can create the database dump and run postgis_restore.pl to restore
it in your Postgis 2.x database (exemple using Postgres 9.1, Postgis 2.1):</p>
<blockquote>
<div><pre class="highlight"><span class="prompt1">sudo -u postgres createdb -T template_postgis &lt;database_name&gt;</span>
<span class="prompt1">perl /usr/share/Postgresql/9.1/contrib/Postgis-2.1/postgis_restore.pl -v &lt;dump_name&gt;.dump <span class="p">|</span> sudo -u postgres psql &lt;database_name&gt;</span>
</pre></div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you dont have a template_postgis database, you need to add Postgis support
manually, refer to <a class="reference internal" href="install_application.html#integrator-install-application-create-database"><span class="std std-ref">Create the database</span></a>.</p>
</div>
<p>Once restored, set the original names back:</p>
<blockquote>
<div><div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layertmp</span> <span class="n">RENAME</span> <span class="n">TO</span> <span class="n">layer</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">INDEX</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layertmp_pkey</span> <span class="n">RENAME</span> <span class="n">TO</span> <span class="n">layer_pkey</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layer</span> <span class="n">ADD</span> <span class="n">CONSTRAINT</span> <span class="n">layer_id_fkey</span> <span class="n">FOREIGN</span> <span class="n">KEY</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="n">REFERENCES</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">treeitem</span><span class="p">(</span><span class="nb">id</span><span class="p">);</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="o">&lt;</span><span class="n">schema_name</span><span class="o">&gt;.</span><span class="n">layer</span> <span class="n">DROP</span> <span class="n">CONSTRAINT</span> <span class="n">layertmp_id_fkey</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="edition">
<h3>Edition<a class="headerlink" href="#edition" title="Permalink to this headline">¶</a></h3>
<p>If you migrate editable tables, you need to modify the geometry data types to
match Postgis 2 new Typmod.</p>
<p>Example for a layer with <code class="docutils literal"><span class="pre">Point</span></code> geometries and a 21781 projection:</p>
<blockquote>
<div><div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">my_table</span> <span class="n">ALTER</span> <span class="n">COLUMN</span> <span class="n">geom</span> <span class="n">SET</span> <span class="n">DATA</span> <span class="n">TYPE</span> <span class="n">geometry</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="mi">21781</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>To help doing it on several tables at once, here is a function and an example
of usage:</p>
<blockquote>
<div><div class="code sql highlight-default"><div class="highlight"><pre><span></span>CREATE OR REPLACE FUNCTION migrategeomtopostgis2(_tablename text, _geomcolumn text, _geomtype text, _srid int) RETURNS void AS $$
DECLARE
_cleangeomtype text;
BEGIN
_cleangeomtype := initcap(lower(_geomtype));
EXECUTE &#39; ALTER TABLE &#39; || _tablename || &#39; ALTER COLUMN &#39; || _geomcolumn || &#39; SET DATA TYPE geometry(&#39; || _cleangeomtype || &#39;, &#39; || _srid || &#39;)&#39;;
EXECUTE &#39; ALTER TABLE &#39; || _tablename || &#39; DROP CONSTRAINT IF EXISTS enforce_dims_&#39; || _geomcolumn;
EXECUTE &#39; ALTER TABLE &#39; || _tablename || &#39; DROP CONSTRAINT IF EXISTS enforce_geotype_&#39; || _geomcolumn;
EXECUTE &#39; ALTER TABLE &#39; || _tablename || &#39; DROP CONSTRAINT IF EXISTS enforce_srid_&#39; || _geomcolumn;
END
$$
LANGUAGE PLPGSQL;

select migrategeomtopostgis2(f_table_schema || &#39;.&#39; || f_table_name, f_geometry_column, type, srid) from geometry_columns where f_table_schema IN (&#39;schema1&#39;,&#39;schema2&#39;,&#39;schema3&#39;);
</pre></div>
</div>
</div></blockquote>
<p>Where <code class="docutils literal"><span class="pre">schemaX</span></code> are the names of the schemas where the tables you want to
convert are.</p>
<p>You need to create the <code class="docutils literal"><span class="pre">migrategeomtopostgis2</span></code> function first (simply copy
and input the function definition above in your terminal), then execute the
<code class="docutils literal"><span class="pre">select</span></code> (adapted to your need).</p>
<p>If the following constraints do not exist, <code class="docutils literal"><span class="pre">enforce_dims_&lt;geometry_column&gt;</span></code>,
<code class="docutils literal"><span class="pre">enforce_geotype_&lt;geometry_column&gt;</span></code> or <code class="docutils literal"><span class="pre">enforce_srid_&lt;geometry_column&gt;</span></code>,
the query will output some <code class="docutils literal"><span class="pre">NOTICE</span></code>, which may mean you have used other
names for your constraints, so you should have a look at the corresponding
tables and remove the constraints manually.</p>
<p>If you have created views depending on the modified table, you need to drop
and recreate all the related views.</p>
<p>Here are some helper queries to generate .sql files containing the views DROP
and CREATE SQL queries:</p>
<blockquote>
<div><div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">copy</span> <span class="p">(</span> <span class="n">select</span> <span class="s1">&#39;CREATE OR REPLACE VIEW &#39;</span> <span class="o">||</span> <span class="n">schemaname</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="n">viewname</span> <span class="o">||</span> <span class="s1">&#39; AS &#39;</span> <span class="o">||</span> <span class="n">regexp_replace</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span><span class="n">E</span><span class="s1">&#39;[</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">r]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">pg_catalog.pg_views</span> <span class="n">where</span> <span class="n">schemaname</span> <span class="n">IN</span> <span class="p">(</span><span class="s1">&#39;schema1&#39;</span><span class="p">,</span><span class="s1">&#39;schema2&#39;</span><span class="p">,</span><span class="s1">&#39;schema3&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="n">to</span> <span class="s1">&#39;/tmp/view_create.sql&#39;</span><span class="p">;</span>
<span class="n">copy</span> <span class="p">(</span> <span class="n">select</span> <span class="s1">&#39;DROP VIEW &#39;</span> <span class="o">||</span> <span class="n">schemaname</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="n">viewname</span> <span class="o">||</span> <span class="s1">&#39; CASCADE;&#39;</span> <span class="kn">from</span> <span class="nn">pg_catalog.pg_views</span> <span class="n">where</span> <span class="n">schemaname</span> <span class="n">IN</span> <span class="p">(</span><span class="s1">&#39;schema1&#39;</span><span class="p">,</span><span class="s1">&#39;schema2&#39;</span><span class="p">,</span><span class="s1">&#39;schema3&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="n">to</span> <span class="s1">&#39;/tmp/view_drop.sql&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="test-and-commit">
<h2>Test and commit<a class="headerlink" href="#test-and-commit" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">After the upgrade process is done, do a final build of the application:</p>
<pre class="highlight"><span class="prompt1">make -f &lt;user&gt;.mk build</span>
</pre></li>
<li><p class="first">Test your application.</p>
</li>
<li><p class="first">Test the checker at <cite>http://&lt;application base&gt;/wsgi/check_collector?type=all</cite>.</p>
</li>
<li><p class="first">Commit your changes:</p>
<pre class="highlight"><span class="prompt1">git commit -am <span class="s2">&quot;Upgrade to GeoMapFish &lt;release&gt;&quot;</span></span>
</pre></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/camptocamp.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Upgrading a GeoMapFish application</a><ul>
<li><a class="reference internal" href="#using-the-c2ctool-command">Using the c2ctool command</a></li>
<li><a class="reference internal" href="#easy-updating-an-application-code">Easy updating an application code</a></li>
<li><a class="reference internal" href="#easy-upgrading-an-application">Easy upgrading an application</a></li>
<li><a class="reference internal" href="#easy-upgrading-an-application-from-1-5-to-1-6">Easy upgrading an application from 1.5 to 1.6</a></li>
<li><a class="reference internal" href="#upgrading-cgxp-advanced-version">Upgrading CGXP (advanced version)</a></li>
<li><a class="reference internal" href="#upgrading-c2cgeoportal-advanced-version">Upgrading c2cgeoportal (advanced version)</a></li>
<li><a class="reference internal" href="#migrating-database-to-postgis-2-x">Migrating database to Postgis 2.x</a><ul>
<li><a class="reference internal" href="#edition">Edition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-and-commit">Test and commit</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Integrator Guide</a><ul>
      <li>Previous: <a href="install_application.html" title="previous chapter">Install an existing application</a></li>
      <li>Next: <a href="windows_tools.html" title="next chapter">Configuring Windows tools required to connect to our servers</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/integrator/upgrade_application.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-2014, Camptocamp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="../_sources/integrator/upgrade_application.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/camptocamp/c2cgeoportal" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>