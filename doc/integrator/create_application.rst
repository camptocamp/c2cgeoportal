.. _integrator_create_application:

Create a new application
========================

Creating a c2cgeoportal application is done by applying two Paste skeletons
(a.k.a. templates). These skeletons are provided by the ``c2cgeoportal``
package. So to be able to create a c2cgeoportal application the
``c2cgeoportal`` package must be installed.

Install c2cgeoportal
--------------------

Installing c2cgeoportal is done using Buildout.

Clone c2cgeoportal::

    $ git clone git@github.com:camptocamp/c2cgeoportal.git
    $ git submodule update --init

Boostrap Buildout::

    $ python bootstrap.py --version 1.5.2 --distribute --download-base \
      http://pypi.camptocamp.net/ --setup-source \
      http://pypi.camptocamp.net/distribute_setup.py

Install c2cgeoportal::

    $ ./buildout/bin/buildout

The above command downloads the latest *final* ``c2cgeoportal`` package from
http://pypi.camptocamp.net/internal-pypi/index/.

.. note::

    To install a development package of c2cgeoportal you can edit buildout.cfg
    and set ``prefer-final`` to ``false``.

Create the new application
--------------------------

To create the application first apply the ``c2cgeoportal_create`` skeleton::

    $ buildout/bin/paster create --template=c2cgeoportal_create

You'll be asked to enter the project name and the SRID for this project. Just
ignore the ``IOError: No egg-info directory found (...)`` error message.

Now apply the ``c2cgeoportal_update`` skeleton::

    $ buildout/bin/paster create --template=c2cgeoportal_update

Enter the same projet name and SRID as before. And again, ignore the
``IOError: No egg-info directory found (...)`` error message.

.. note::

    The ``c2cgeoportal_update`` skeleton is also used to update the
    application. The files generated by this skeleton are prefixed with
    ``CONST_``, which means they are *constant* files that should not changed.
    Following this rule is important for easing updates.

At this point you no longer need the virtual env and the ``c2cgeoportal`` tree,
so you can deactivate the virtual env, and remove the ``c2cgeoportal`` and
``env`` directories::

    (env) $ deactivate
    $ rm -rf env c2cgeoportal

And remove the ``egg-info`` directory, as it shouldn't be added to the
source repository::

    $ rm -rf <project_name>/*.egg-info

If this application is not part of a parent/child architecture, or is
a ``child`` application, you can just remove the ``buildout_parent.cfg`` file::

    $ rm buildout_parent.cfg

If this application is a ``parent`` application make ``buildout_parent.cfg``
the main Buildout configuration file::

    $ rm buildout.cfg
    $ mv buildout_parent.cfg buildout.cfg

.. note::

    In a parent/child architecture one instance of the application is the
    parent, the others are children. Child instances display layers
    served by the parent instance. Parent and child instances share
    the same database, but use dedicated schemas within that database.

Now is a good time to put the application source code under revision
control (Git preferably).

Minimal setup of the application
--------------------------------

This section provides the minimal set of things to do to get a working
application.

Defining background layers
~~~~~~~~~~~~~~~~~~~~~~~~~~

A c2cgeoportal application has *background layers* and *overlays*. Background
layers, also known as base layers, sit at the bottom of the map. They're
typically cached layers. Overlays represent application-specific data. They're
displayed on top of background layers.

Background layers are created by the application integrator, while overlays are
created by the application administrator. This is why only background layers
are covered here in the Integrator Guide. Defining overlays is described in the
:ref:`administrator_guide`.

Create a WMTS layer (**To Be Changed**)

* Make sure that ``/var/sig/tilecache/`` exists and is writeable by the user ``www-data``.
* Add the matching layers definitions in the mapfile (``mapserver/c2cgeoportal.map.in``).
* Add a layer entry in ``tilecache/tilecache.cfg.in``. The ``layers`` attribute 
  must contain the list of mapserver layers defined above.
* Update the layers sources list (``viewer_layers`` block) in the 
  ``<package>/templates/viewer.js`` template. The ``layer`` parameter is the name 
  of the tilecache layer entry just added in ``tilecache/tilecache.cfg.in``.

**To Be Completed**

After creation and minimal setup the application is ready to be installed.
See the next section :ref:`integrator_install_application`.
