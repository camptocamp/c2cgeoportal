This file includes migration steps for each release of c2cgeoportal.


Version 1.6.2
=============

1. In the `{{project}}/models.py` add the following lines:

    from pyramid.security import DENY_ALL

    LayerInternalWMS.__acl__ = [DENY_ALL]
    LayerExternalWMS.__acl__ = [DENY_ALL]
    LayerWMTS.__acl__ = [DENY_ALL]
    WMTSDimension.__acl__ = [DENY_ALL]


Version 1.6
===========

1. Warning about .in and .mako files

   In c2cgeoportal 1.6, the .in are globally replaced by .mako

   .in STILL WORK!

   You can keep the .in, the system is backward compatible,
   or you can choose to replace your .in by .mako, to stick to c2cgeoportal
   evolution.

   .mako offer more flexibility, so it is advised to replace the .in
   by .mako

   Please note the following syntax change:

   a variable named ${vars:<varname>} in a .in will be written ${<varname>} in
   a .mako

   Also, in all the CHANGELOG points specifying both .in/.mako files, it means
   you need to modify the file you have (either the .in or the .mako), you MUST
   NOT have both files.

2. Follow the instructions explained in this documentation chapter:
    http://docs.camptocamp.net/c2cgeoportal/1.6/integrator/upgrade_application.html#easy-upgrading-an-application-from-1-5-to-1-6

3. Get the new and heavily modified files:

    at that point, the following folder should exist: /tmp/{{project}}/

    cp /tmp/{{project}}/.gitignore .
    cp /tmp/{{project}}/.jshintrc .
    cp /tmp/{{project}}/.travis.yml .
    cp /tmp/{{project}}/travis.mk .
    cp /tmp/{{project}}/{{package}}.mk .
    cp /tmp/{{project}}/README.rst .
    cp /tmp/{{project}}/alembic.ini.mako .
    cp /tmp/{{project}}/alembic_static.ini.mako .
    cp /tmp/{{project}}/build.json .
    cp /tmp/{{project}}/development.ini.mako .
    cp /tmp/{{project}}/lingua.cfg .
    cp /tmp/{{project}}/package.json .
    cp /tmp/{{project}}/production.ini.mako .
    cp /tmp/{{project}}/vars_{{package}}.yaml .
    cp /tmp/{{project}}/deploy/hooks/post-restore-code deploy/hooks
    cp /tmp/{{project}}/apache/application.wsgi.mako apache/
    chmod +x deploy/hooks/post-restore-code

4. Starting from version 1.6 we use a new build system based on Make that will change
   many of your habits, information are given at:
   http://docs.camptocamp.net/c2cgeoportal/1.6/integrator/make.html

   Main things to do:
   - Move your old `config.yaml` and your `vars` section of the old
     `buildout.cfg` file to the new `vars_{{package}}.yaml` file.
   - Move your special task from your old `buildout.cfg` file to your new
     `{{package}}.mk` file
   - The `README.rst`, `.gitignore` files will be overwritten.
     Please make sure to back your changes up before proceeding.
   - The `development.ini.in`, `production.ini.in` files will be replaced by
     the `development.ini.mako`, `production.ini.mako` files. If you lost
     something it should probably be moved in the `vars_{{package}}.yaml` file.
   - The `print/template/print.mako.in` file should be moved to
     `print/print.yaml.mako`.
   - The build environments (`<user>.mk` files) must be recreated.
     For multi project mode have a look at the documentation:
     http://docs.camptocamp.net/c2cgeoportal/master/integrator/create_application.html

5. In the `setup.cfg` file you should remove all the `[compile_catalog]`,
   `[extract_messages]`, `[init_catalog]`, `[update_catalog]` sections.

6. In the `setup.py` file you should remove the `message_extractors`
   argument.

7. In the {{package}}/__init__.py file do the following changes:

    -from c2cgeoportal import locale_negotiator
    +from c2cgeoportal import locale_negotiator, add_interface, INTERFACE_TYPE_SENCHA_TOUCH

    Replace all the mobile view configuration (all the `config.add_route ...`,
    `config.add_view ...` under the line "# mobile views and routes") by the
    following lines:
    + add_interface(config)
    + add_interface(config, 'edit')
    + add_interface(config, 'routing')
    + add_interface(config, 'mobile', INTERFACE_TYPE_SENCHA_TOUCH)

    Remove the activation of the static view (now done directly in c2cgeoportal):
    - # add the main static view
    - config.add_static_view(
    -     name='proj',
    -     path='{{package}}:static',
    -     cachebust=True,
    - )

    Remove the activation of the admin interface (now done directly in c2cgeoportal):
    - if asbool(config.get_settings().get('enable_admin_interface')):
    -   config.formalchemy_admin(
    -     'admin', package='{{package}}',
    -     view='fa.jquery.pyramid.ModelView', factory=FAModels
    -   )

    Remove the activation of the checkers (now done directly in c2cgeoportal):
    - config.add_route('checker_all', '/checker_all')

8. In the `{{package}}/templates/*.html` files you should do the following
   changes:

   - jsbuild_cfg = request.registry.settings.get('jsbuild_cfg')
   - jsbuild_root_dir = request.registry.settings.get('jsbuild_root_dir')
   + jsbuild_settings = request.registry.settings.get('jsbuild', {})
   + jsbuild_cfg = jsbuild_settings.get('config')
   + jsbuild_root_dir = jsbuild_settings.get('root_dir')

   Remove the no more needed `_query=url_params` argument of the
   `static_url` calls.

9. In the `{{package}}/templates/*.js` files do the following changes:

    - <% json_extent = user.role.json_extent if user else None %>
    - % if json_extent:
    -     var INITIAL_EXTENT = ${json_extent};
    + <% bounds = user.role.bounds if user else None %>
    + % if bounds:
    +     var INITIAL_EXTENT = ${dumps(bounds)};

    replace `url_role_params` by `version_role_params` in all the file.

    in the WMTS_OPTIONS add the following lines:

    + getURL: function() {
    +     var url = OpenLayers.Layer.WMTS.prototype.getURL.apply(this, arguments);
    +     return url + "?${"&".join(["%s=%s" % p for p in version_params.items()]) | }";
    + },

10. In the `{{package}}/templates/*.js`, `{{package}}/templates/api/*.js`,
    `{{package}}/static/mobile/config.js`, `{{package}}/static/mobile/index.html`
    files add ` | n` after all the `static_url` and `route_url` call, like:
    - "${request.static_url('...')}"
    + "${request.static_url('...') | n}"

11. In the `{{package}}/templates/edit.js` file
    add the following attribute to the `cgxp_editing` plugin:
    + metadataParams: ${dumps(version_role_params) | n}

12. In the mapfile add the following lines to all restricted layers:

    VALIDATION
        ${mapserver_layer_validation}
    END

13. Remove the deprecated versioning table:

    sudo -u postgres psql -c "DROP TABLE version_{{package}}" <database>

14. For non Apt/Dpkg based OS, disable the package checking:
    In the ``buildout.cfg`` section ``[buildout]`` add:

        parts -=
            test-packages
            test-packages-mobile
            test-packages-tilecloud-chain

15. In the `{{package}}/static/mobile/config.js` add the following line at the top of the file:

    +OpenLayers.ImgPath = "${request.static_url('{{package}}:static/lib/cgxp/core/src/theme/img/ol/') | n}";

16. Move the `jsbuild/app.cfg` file to `jsbuild/app.cfg.mako`.

    Add the following lines in the start of the file:
        <%
        root = [
            "{{package}}/static/lib/cgxp/core/src/script",
            "{{package}}/static/lib/cgxp/ext",
            "{{package}}/static/lib/cgxp/geoext/lib",
            "{{package}}/static/lib/cgxp/openlayers/lib",
            "{{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthView/lib",
            "{{package}}/static/lib/cgxp/openlayers.addins/Spherical/lib",
            "{{package}}/static/lib/cgxp/openlayers.addins/URLCompressed/lib",
            "{{package}}/static/lib/cgxp/openlayers.addins/DynamicMeasure/lib",
            "{{package}}/static/lib/cgxp/openlayers.addins/AddViaPoint/lib",
            "{{package}}/static/lib/cgxp/openlayers.addins/AutoProjection/lib",
            "{{package}}/static/lib/cgxp/gxp/src/script",
            "{{package}}/static/lib/cgxp/proj4js",
            "{{package}}/static/lib/cgxp/geoext.ux/ux/Measure/lib",
            "{{package}}/static/lib/cgxp/geoext.ux/ux/SimplePrint/lib",
            "{{package}}/static/lib/cgxp/geoext.ux/ux/FeatureEditing/lib",
            "{{package}}/static/lib/cgxp/geoext.ux/ux/FeatureSelectionModel/lib",
            "{{package}}/static/lib/cgxp/geoext.ux/ux/WMSBrowser/lib",
            "{{package}}/static/lib/cgxp/geoext.ux/ux/StreetViewPanel",
            "{{package}}/static/lib/cgxp/sandbox",
            "{{package}}/static/lib/cgxp/styler/lib",
            "{{package}}/static/lib/cgxp/ext.ux/TwinTriggerComboBox",
            "{{package}}/static/lib/cgxp/ext.ux/GroupComboBox",
            "{{package}}/static/lib/cgxp/ext.ux/ColorPicker",
            "{{package}}/static/lib/cgxp/ext.ux/base64",
            "{{package}}/static/lib/cgxp/ext.overrides",
            "{{package}}/static/lib/cgxp/dygraphs",
            "{{package}}/static/js",
        ]
        %>

    Replace all the root section by:

        root =
            ${"\n    ".join(root)}

17. Remove your Apache configuration file, probably in
    `/var/www/vhost/{{project}}/conf`. Now it will be automatically created.

    To define a customized path, set the variables APACHE_VHOST and/or
    APACHE_CONF_DIR in your `<user>.mk` file.

18. Notes on database changes:
    * In prevision of GeoMapFish 2.0 some tables were added and some fields updated.
    * Table ``user`` has been moved to schema ``main_static`` in order to store all
      data modified by the web application in the same schema.
      As a result the passwords no longer need to be synchronised among the various instances
      of the application and the password replication tool has been removed.

19. Add at the end of the `deploy/hooks/post-restore-database.mako` or
    `deploy/hooks/post-restore-database.in` file the following line:

    + .build/venv/bin/alembic -c alembic_static.ini upgrade head

20. In your `apache/wsgi.conf.mako` or `apache/wsgi.conf.in` file replace all the
    `apache-entry-point` by `apache_entry_point`

21. In your `apache/frontend.conf.mako` or `apache/frontend.conf.in` file in the
    `<LocationMatch /${instanceid}/wsgi/>` section,
    add the following  mimetypes to the existing list:

    ... application/vnd.ogc.wms_xml application/vnd.ogc.gml application/vnd.ogc.se_xml

    and in the `<LocationMatch /${instanceid}/tiles/>` section,
    add the following lines:

    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/x-javascript text/javascript application/javascript application/xml
    Header add Access-Control-Allow-Headers "X-Requested-With, Content-Type"

22. In the `{{package}}/subscribers.py`, `{{package}}/models.py`, `{{package}}/forms.py` files do the following changes:

    -... = TranslationStringFactory('{{package}}')
    +... = TranslationStringFactory("{{package}}-server")

23. In the `{{package}}/subscribers.py` file do the following change:

    - return localizer.translate(tsf2(localizer.translate(tsf1(string))))
    + result = localizer.translate(tsf1(string))
    + return localizer.translate(tsf2(string)) if result == string else result

24. Add the `print_spec` in the `checker` config `vars_{{package}}.yaml` file:

    checker:
        ...
        print_spec:
            layout: "A4 portrait"
            outputFormat: "pdf"
            attributes:
                title: ""
                comments: ""
                datasource: []
                map:
                    projection: "EPSG:21781"
                    dpi: 254
                    rotation: 0
                    center: [600000, 200000]
                    scale: 100000
                    longitudeFirst: true
                    layers: []
                legend: {}

25. Remove the deprecated files:

    git rm -r {{package}}/CONST_migration
    git rm -r {{package}}/static/build
    git rm config.yaml.in
    git rm bootstrap.py
    git rm -r *buildout*
    git rm development.ini.in production.ini.in
    git rm versions.cfg

26. In your `apache/wsgi.conf.in` or `apache/wsgi.conf.mako` file, do the
    following change:

    - WSGIScriptAlias /${vars:instanceid}/wsgi ${buildout:directory/buildout/parts/modwsgi/wsgi}
    + WSGIScriptAlias /${instanceid}/wsgi ${directory}/apache/application.wsgi


Version 1.5.4
=============

1. By default the authentication cookie expires after 86400 seconds (1 day).
   You may override this value by adding an `authtkt_timeout` parameter
   in your `buildout.cfg` file. For instance:

    # One week
    authtkt_timeout: 604800

   Also edit `production.ini.in` and `development.ini.in` like this:

     authtkt_secret = ${authtkt_secret}
    -authtkt_cookie_name = auth_tkt_${instanceid}
    +authtkt_cookie_name = ${authtkt_cookie_name}
    +authtkt_timeout = ${authtkt_timeout}

2. In the `{{package}}/templates/viewer.js` file, in the `cgxp_querier` plugin add the following attribute:

    describeFeatureTypeParams: ${dumps(url_role_params) | n}


Version 1.5.3
=============

1. At the end of the file `apache/frontend.conf.in` add:

    <LocationMatch /${vars:instanceid}/tiles/>
        Header add Access-Control-Allow-Origin "*"
        Header merge Cache-Control "public"
    </LocationMatch>


Version 1.5.2
=============

1. In the ``{{package}}/static/mobile/config.js`` file do the following change:

   -    App.WFSTypes = '${wfs_types | n}'.split(',');
   +    App.WFSTypes = jsonFormat.read('${dumps(wfs_types) | n}');

2. In the ``{{package}}/templates/viewer.js`` and ``{{package}}/templates/edit.js`` files,
   for plugins ``cgxp_layertree`` and ``cgxp_login``,
   add the ``events`` parameter:

        ...
        ptype: "cgxp_layertree",
        id: "layertree",
    +   events: EVENTS,
        ...
        ...
        ptype: 'cgxp_login',
        actionTarget: 'center.tbar',
    +   events: EVENTS,
        ...

    this allows to use the new ``showRestrictedContentWarning`` parameter
    in plugin ``cgxp_layertree`` to warn the user that some content in the
    permalink he has loaded is only available if logged in.

Version 1.5.1
=============

1. Remove in ``production.ini.in`` and ``development.ini.in`` in the ``[app:app]`` section:

   cache_version = ${cache_version}

2. In the ``{{package}}/templates/viewer.js`` you should add the following configuration in the
   ``cgxp_permalink`` plugin:

    shortenerCreateURL: "${request.route_url('shortener_create', path='')}",


Version 1.5
===========

Full git hub diff: https://github.com/camptocamp/c2cgeoportal/compare/1.4...1.5#diff-24
(Every files started with `c2cgeoportal/scaffolds/create/`)

1. In the `{{package}}/__init__.py` file:

   * Use a cache header in the static view:

        - config.add_static_view('proj', '{{package}}:static')
        + config.add_static_view('proj', '{{package}}:static',
        +     cache_max_age=int(config.get_settings()["default_max_age"])
        + )

2. Update the mobile application:

    * In the `{{package}}/static/mobile/config.js` file do the following changes:

        - // App.info includes information that is needed by internal
        - // components, such as the Login view component.
        - App.info = '${info | n}';
        -
        - App.themes = '${themes | n}';
        - App.theme = '${theme | n}';
        -
        - App.WFSTypes = '${wfs_types | n}';
        -
        - // Query mode. Can be either 'click' or 'longpress'
        - App.queryMode = 'longpress';
        -
          var dummy = "<% from json import dumps %>";
          jsonFormat = new OpenLayers.Format.JSON();
          try {
        +     // App.info includes information that is needed by internal
        +     // components, such as the Login view component.
        +     App.info = jsonFormat.read('${dumps(info) | n}');
        +
        +     App.themes = jsonFormat.read('${dumps(themes) | n}');
        +     App.theme = '${theme | n}';
        +
        +     App.WFSTypes = '${wfs_types | n}'.split(',');
        +
        +     // Query mode. Can be either 'click' or 'longpress'
        +     App.queryMode = 'longpress';

              App.tilesURL = jsonFormat.read('${dumps(request.registry.settings["tiles_url"]) | n}');
          }
          catch (e) {
              // For the Sencha build ...
        -     App.tilesURL = "";
          }
        +
        + App.featureNS = 'http://mapserver.gis.umn.edu/mapserver';

3. Update the templates:

  * In the `{{package}}/templates/viewer.js`:

    * Import the json dumps.
    * Add some print argument (printProviderConfig).
    * Add a reference to the `LayerTree` plugin in the `MapOpacitySlider` config.
    * Set stateful false of collapsible panels

    Then:

      ...
        id: "featuresgrid-container",
      ...
        collapseMode: "mini",
      + stateful: false,
      ...
        id: "left-panel",
      ...
        collapseMode: "mini",
      + stateful: false,
      ...
        <%
      + from json import dumps
        wfs_settings = request.registry.settings.get('wfs', {})
        %>
      ...
            printURL: "${request.route_url('printproxy', path='')}",
            mapserverURL: "${request.route_url('mapserverproxy', path='')}",
      +     printProviderConfig: ${dumps(url_role_params)|n},
            options: {
      ...
        {
            ptype: "cgxp_mapopacityslider",
      +     layerTreeId: "layertree",
            defaultBaseLayerRef: "${functionality['default_basemap'][0] | n}"
        }

4. Do the following changes in the ``apache/frontend.conf.in`` file:

  - AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/x-javascript application/javascript application/json
  + AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/x-javascript text/javascript application/javascript application/json

  - <LocationMatch /${instanceid}/wsgi/(app|build|lib)>
  -     # Remove etags to enable better client-side caching
  -     # (potential proxy problems)
  -     # Also instruct proxys that these files are cacheable.
  -     Header unset ETag
  -     FileETag None
  -     Header merge Cache-Control "public"
  -
  -     # Short term cache, before OpenLayers images (and others) are "CSS-Sprited"
  -     ExpiresActive On
  -     ExpiresDefault "access plus 1 hour"
  + <LocationMatch /${instanceid}/wsgi/(proj|static)>
  +     # Instruct proxys that these files are cacheable.
  +     Header merge Cache-Control "public"

5. Add the following line in the ``apache/wsgi.conf.in`` file:

    RewriteRule ^${apache-entry-point}search$ /${instanceid}/wsgi/fulltextsearch [PT]
    RewriteRule ^${apache-entry-point}s/(.*)$ /${instanceid}/wsgi/short/$1 [PT]

6. In the `config.yaml.in` file:

   * Update the `main` `checkers` by removing `checker_apiloader` (no longer exists),
     and adding `checker_api`, `checker_xapi`, `checker_fts`, `checker_wmscapabilities`
     and `checker_wfscapabilities`::

        -  - name: checker_apiloader
        -    display: API loader
        +  - name: checker_api
        +    display: API
        +  - name: checker_xapi
        +    display: Extended API
        +  - name: checker_fts
        +    display: FullTextSearch
        +  - name: checker_wmscapabilities
        +    display: WMS capabilities
        +  - name: checker_wfscapabilities
        +    display: WFS capabilities

    * Add (or update) the following configuration

        # The shortner base configuration
        shortener:
          # The base of created URL
          base_url:  http://${host}${apache-entry-point}s/

7. Some changes in the Deploy:

    In the ``deploy/hooks/post-restore-database.in`` file do the following changes:

    - #!/bin/sh
    + #!/bin/sh -e

    ...

    - psql -c 'CREATE SCHEMA IF NOT EXISTS ${schema}_static;' ${db}
    - psql -c 'CREATE TABLE ${schema}_static.shorturl IF NOT EXISTS (
    + # The following line works only with Postgres 9.3 and upper.
    + # otherwise the schema should be create manually
    + # psql -c 'CREATE SCHEMA IF NOT EXISTS ${schema}_static;' ${db}
    +
    + # The workaround is to ignore the error
    + psql -c 'CREATE SCHEMA ${schema}_static;' ${db} 2> /dev/null || true
    + psql -c 'CREATE TABLE IF NOT EXISTS ${schema}_static.shorturl (

    ...

8. Update the `production.ini.in` and `development.ini.in` files:

  * Add the new default_max_age to 10 days:

        default_max_age = 864000

9. Update the `jsbuild/app.cfg` file.

    * In the language sections [lang-fr.js], [lang-de.js] add the following
      localisation files (in `include`) respectively:

        ux/locale/StreetViewPanel-fr.js
        ux/locale/StreetViewPanel-de.js

    * To make sure that custom translations always have priority, also
      do the following changes in [lang-fr.js], [lang-de.js]:

        + last =
        +     Proj/Lang/<lang>.js
        +     Proj/Lang/GeoExt-<lang>.js
          include =
              ...
        -     Proj/Lang/<lang>.js
        -     Proj/Lang/GeoExt-<lang>.js

10. Remove old files:

   We now use the mapfish print 2.1, than remove the 2.0 war:

        git rm print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war

11. Some important notices:

  * If using Mapserver 6.4 you have to move the substitution variables default
    values and validation patterns from the METADATA section to a VALIDATION
    section. See ``Variable Substitution`` in the Mapfile chapter of the
    administrator manual.

  * All references of tilecache are removed.


Version 1.4.5
=============

1. In the `{{package}}/__init__.py` replace 'testing' by 'production':

         config.add_route('mobile_index_prod', '/mobile/')
         config.add_view('c2cgeoportal.views.entry.Entry',
                         attr='mobile',
    -                    renderer='{{package}}:static/mobile/build/testing/App/index.html',
    +                    renderer='{{package}}:static/mobile/build/production/App/index.html',
                         route_name='mobile_index_prod')
         config.add_route('mobile_config_prod', '/mobile/config.js')
         config.add_view('c2cgeoportal.views.entry.Entry',
                         attr='mobileconfig',
    -                    renderer='{{package}}:static/mobile/build/testing/App/config.js',
    +                    renderer='{{package}}:static/mobile/build/production/App/config.js',
                         route_name='mobile_config_prod')
    -    config.add_static_view('mobile', '{{package}}:static/mobile/build/testing/App')
    +    config.add_static_view('mobile', '{{package}}:static/mobile/build/production/App')

2. To add the cache version parameter to the JS/CSS URLs:

   * Add to ``production.ini.in`` and ``development.ini.in`` in the ``[app:app]`` section:

   cache_version = ${cache_version}

   * In ``{{package}}/templates/index.html`` do the following changes:

   - <link rel="stylesheet" type="text/css" href="${request.static_url('{{package}}:static/build/app.css')}" />
   + <link rel="stylesheet" type="text/css" href="${request.static_url('{{package}}:static/build/app.css', _query=url_params)}" />

   - <script type="text/javascript" src="${request.static_url('{{package}}:static/build/app.js')}"></script>
   - <script type="text/javascript" src="${request.static_url('{{package}}:static/build/lang-%s.js' % lang)}"></script>
   + <script type="text/javascript" src="${request.static_url('{{package}}:static/build/app.js', _query=url_params)}"></script>
   + <script type="text/javascript" src="${request.static_url('{{package}}:static/build/lang-%s.js' % lang, _query=url_params)}"></script>

   - <script type="text/javascript" src="${request.route_url('viewer')}${extra_params}"></script>
   + <script type="text/javascript" src="${request.route_url('viewer', _query=extra_params)}"></script>

   The same changes must be done in ``{{package}}/templates/edit.html`` and ``{{package}}/templates/routing.html``.

   In ``{{package}}/templates/api/api.js`` do the following changes:

     document.write('<scr' + 'ipt type="text/javascript" src="'
   -     + "${request.static_url('{{package}}:static/build/api.js')}" + '"></scr' + 'ipt>');
   +     + "${request.static_url('{{package}}:static/build/api.js', _query=url_params)}" + '"></scr' + 'ipt>');
     document.write('<scr' + 'ipt type="text/javascript" src="'
   -     + "${request.static_url('{{package}}:static/build/api-lang-%s.js' % lang)}" + '"></scr' + 'ipt>');
   +     + "${request.static_url('{{package}}:static/build/api-lang-%s.js' % lang, _query=url_params)}" + '"></scr' + 'ipt>');
     document.write('<link rel="stylesheet" type="text/css" href="'
   -     + "${request.static_url('{{package}}:static/build/api.css')}" + '" />');
   +     + "${request.static_url('{{package}}:static/build/api.css', _query=url_params)}" + '" />');

   Similar changes are needed in ``{{package}}/templates/api/xapi.js`` as well.

11. In the `{{package}}/__init__.py` file:

   * Use the multiauthpolicy:


        from pyramid.config import Configurator
        -from pyramid.authentication import AuthTktAuthenticationPolicy
        from pyramid.settings import asbool
        from c2cgeoportal import locale_negotiator
        -from c2cgeoportal.resources import FAModels, defaultgroupsfinder
        +from c2cgeoportal.resources import FAModels
        +from c2cgeoportal.lib.authentication import create_authentication
        from {{package}}.resources import Root

        def main(global_config, **settings):
            """ This function returns a Pyramid WSGI application.
            """
        -   authentication_policy = AuthTktAuthenticationPolicy(
        -            settings.get('authtkt_secret'),
        -            callback=defaultgroupsfinder,
        -            cookie_name=settings.get('authtkt_cookie_name'))
            config = Configurator(root_factory=Root, settings=settings,
                     locale_negotiator=locale_negotiator,
        -            authentication_policy=authentication_policy)
        +            authentication_policy=create_authentication(settings))


Version 1.4.3
=============

1. MapserverProxy by default limits the number of features returned by a WFS
   GetFeature request to 200 because Mapserver used to not support correctly
   the ``maxFeatures`` parameter. This issue is fixed with Mapserver 6.4.

   It is possible to disable or customize this limit by adding to the
   ``config.yaml.in`` file the following configuration:

    wfs:
        enable_limit_featurecollection: True
        maxfeatures: 200

   This configuration may also be used in the templates (for instance
   ``viewer.js``) by adding the following code:

    <%
    wfs_settings = request.registry.settings.get('wfs', {})
    %>
    maxFeatures: ${wfs_settings.get('maxfeatures')}

2. In ``deploy/deploy.cfg.in`` replace

    restore_tmp = sudo -u postgres pg_restore --no-owner -Fc -d

   by

    restore_tmp = sudo -u postgres pg_restore -Fc -d

   You may also remove the GRANT instructions in ``deploy/hooks/post-restore-database.in``:

    psql -c 'GRANT USAGE ON SCHEMA "${schema}" TO "${dbuser}";' ${db}
    psql -c 'GRANT SELECT ON ALL TABLES IN SCHEMA "${schema}" TO "${dbuser}";' ${db}


Version 1.4
===========

1. Get the new files:

    git add versions.cfg

    ./buildout/bin/pcreate -s c2cgeoportal_create /tmp/{{project}} package={{package}}

    cp /tmp/{{project}}/README.rst .
    git add README.rst
    cp /tmp/{{project}}/{{package}}/templates/routing.{js,html} {{package}}/templates/
    git add {{package}}/templates/routing.{js,html}

    rm -rf /tmp/{{project}}

2. Remove the deprecated files:

    git rm CONST_TIPS.txt.in # replaced by README.rst

      * Tileforge has been removed from c2cgeoportal and replaced by a combination
        of TileCloud and MapCache.

        The main documentation is available at:
        http://docs.camptocamp.net/c2cgeoportal/integrator/tilegeneration.html.

            git rm apache/tilecache.conf.in
            git rm -r tilecache

3. Update the `jsbuild/app.cfg` file.

  * Set all the `root` sections to:

        {{package}}/static/lib/cgxp/core/src/script
        {{package}}/static/lib/cgxp/ext
        {{package}}/static/lib/cgxp/geoext/lib
        {{package}}/static/lib/cgxp/openlayers/lib
        {{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthView/lib
        {{package}}/static/lib/cgxp/openlayers.addins/Spherical/lib
        {{package}}/static/lib/cgxp/openlayers.addins/URLCompressed/lib
        {{package}}/static/lib/cgxp/openlayers.addins/DynamicMeasure/lib
        {{package}}/static/lib/cgxp/openlayers.addins/AddViaPoint/lib
        {{package}}/static/lib/cgxp/gxp/src/script
        {{package}}/static/lib/cgxp/proj4js
        {{package}}/static/lib/cgxp/geoext.ux/ux/Measure/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/SimplePrint/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureEditing/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureSelectionModel/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/WMSBrowser/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/StreetViewPanel
        {{package}}/static/lib/cgxp/sandbox
        {{package}}/static/lib/cgxp/styler/lib
        {{package}}/static/lib/cgxp/ext.ux/TwinTriggerComboBox
        {{package}}/static/lib/cgxp/ext.ux/GroupComboBox
        {{package}}/static/lib/cgxp/ext.ux/ColorPicker
        {{package}}/static/lib/cgxp/ext.ux/base64
        {{package}}/static/lib/cgxp/ext.overrides
        {{package}}/static/lib/cgxp/dygraphs
        {{package}}/static/js

  * Use the ext debug files (3x):

        - Ext/adapter/ext/ext-base.js
        - Ext/ext-all.js
        + Ext/adapter/ext/ext-base-debug.js
        + Ext/ext-all-debug.js

  * Remove from all the `include` section the line:

        DragTracker.js #ext.overrides

  * In the `include` section of the `[edit.js]` add the missing line:

        CGXP/tools/tools.js

  * And add a new routing section (replace <<srid>> by the right value):

        [routing.js]
        root =
            {{package}}/static/lib/cgxp/core/src/script
            {{package}}/static/lib/cgxp/ext
            {{package}}/static/lib/cgxp/geoext/lib
            {{package}}/static/lib/cgxp/openlayers/lib
            {{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthView/lib
            {{package}}/static/lib/cgxp/openlayers.addins/Spherical/lib
            {{package}}/static/lib/cgxp/openlayers.addins/URLCompressed/lib
            {{package}}/static/lib/cgxp/openlayers.addins/DynamicMeasure/lib
            {{package}}/static/lib/cgxp/openlayers.addins/AddViaPoint/lib
            {{package}}/static/lib/cgxp/gxp/src/script
            {{package}}/static/lib/cgxp/proj4js
            {{package}}/static/lib/cgxp/geoext.ux/ux/Measure/lib
            {{package}}/static/lib/cgxp/geoext.ux/ux/SimplePrint/lib
            {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureEditing/lib
            {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureSelectionModel/lib
            {{package}}/static/lib/cgxp/geoext.ux/ux/WMSBrowser/lib
            {{package}}/static/lib/cgxp/geoext.ux/ux/StreetViewPanel
            {{package}}/static/lib/cgxp/sandbox
            {{package}}/static/lib/cgxp/styler/lib
            {{package}}/static/lib/cgxp/ext.ux/TwinTriggerComboBox
            {{package}}/static/lib/cgxp/ext.ux/GroupComboBox
            {{package}}/static/lib/cgxp/ext.ux/ColorPicker
            {{package}}/static/lib/cgxp/ext.ux/base64
            {{package}}/static/lib/cgxp/ext.overrides
            {{package}}/static/lib/cgxp/dygraphs
            {{package}}/static/js
        first =
            Ext/adapter/ext/ext-base-debug.js
            Ext/ext-all-debug.js
            OpenLayers/SingleFile.js
            OpenLayers/Console.js
            OpenLayers/BaseTypes.js
            OpenLayers/BaseTypes/Class.js
            OpenLayers/BaseTypes/Pixel.js
            OpenLayers/BaseTypes/Bounds.js
            OpenLayers/BaseTypes/LonLat.js
            OpenLayers/BaseTypes/Element.js
            OpenLayers/BaseTypes/Size.js
            OpenLayers/Util.js
            OpenLayers/Lang.js
            proj4js/lib/proj4js.js
            proj4js/lib/projCode/merc.js
        exclude =
            GeoExt.js
            GeoExt/SingleFile.js
        include =
            EPSG<<srid>>.js #proj4js
            util.js #GXP
            widgets/Viewer.js #GXP
            plugins/OLSource.js #GXP
            CGXP/cgxp.js
            CGXP/plugins/MapOpacitySlider.js
            CGXP/plugins/Routing.js
            CGXP/data/OSRM.js
            CGXP/widgets/MapPanel.js
            CGXP/tools/tools.js
            OpenLayers/Control/Navigation.js
            OpenLayers/Control/KeyboardDefaults.js
            OpenLayers/Control/PanZoomBar.js
            OpenLayers/Control/ArgParser.js
            OpenLayers/Control/Attribution.js
            OpenLayers/Control/ScaleLine.js
            OpenLayers/Control/MousePosition.js
            OpenLayers/Control/OverviewMap.js
            OpenLayers/Control/NavigationHistory.js
            OpenLayers/Layer/WMTS.js
            OpenLayers/Renderer/SVG.js
            OpenLayers/Renderer/VML.js

  * Adaptations for generic backend usage require the following change.

    In the ``jsbuild/app.cfg`` file, make sure to have ``CGXP/cgxp.js`` in
    ``[app.js]``, ``[edit.js]``, ``[routing.js]`` and ``[xapi.js]``
    in the ``include =`` block, before any other CGXP/* entries.

    For example:

         include =
             EPSG21781.js #proj4js
             util.js #GXP
             widgets/Viewer.js #GXP
        +    CGXP/cgxp.js
             CGXP/plugins/ThemeSelector.js
             ...

4. Update the `config.yaml.in` file:

  * Add sub domain support for pyramid views.
    You can add the following configuration:

       # The URL template used to generate the sub domain URL
       # %(sub)s will be replaced by the sub domain value.
       subdomain_url_template: http://%(sub)s.${host}
       # The used sub domain for the static resources
       subdomains: [s1, s2, s3, s4]

   For the documentation see:
   http://docs.camptocamp.net/c2cgeoportal/integrator/customize_ui.html#sub-domain
   http://docs.camptocamp.net/c2cgeoportal/integrator/tilegeneration.html#internal-service

  * Transform `tilecache_url` into an array, and name it `tiles_url`.

  * In this version we call mapserver and the MapFish print directly on localhost
    with the given `Host` header.

    Set `mapserver_url` and `print_url` using localhost as follows:

        # For mapserver proxy
        mapserv_url: http://localhost/${instanceid}/mapserv

        # For print proxy
        print_url: http://localhost:8080/print-c2cgeoportal-${instanceid}/pdf/

  * Set mobile_default_theme as a functionality:

         functionalities:
            anonymous:
        +        mobile_default_theme:

        -mobile_default_theme:

  * If the FullTextSearch has a configuration, do the following changes::

        - fulltextsearch_maxlimit: 200
        - fulltextsearch_defaultlimit: 30
        + fulltextsearch:
        +     maxlimit: 200
        +     defaultlimit: 30

5. Update the templates:

  * In the `{{package}}/templates/viewer.js`

      - The LayerTree defaultThemes parameter has been separated in two to allow to handle separately
        the default theme and the themes loaded from url, then replace:

            % if permalink_themes:
              defaultThemes: ${permalink_themes | n},
            % else:
              defaultThemes: ["lieu_interet_thm"],
            % endif

        by:

            % if permalink_themes:
                permalinkThemes: ${permalink_themes | n},
            % endif
            defaultThemes: ["to_be_defined"],

  * In all the `{{package}}/templates/*.js` files (including in `{{package}}/templates/api/`):

      - Remove the `getMatrix` method from the `WMTS_OPTIONS`.

      - Remove the following line:

        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 2;

  * Add the new configuration to the ``cgxp_querier`` plugin in the
    ``{{package}}/templates/viewer.js`` file:

        attributeURLs: ${queryer_attribute_urls | n}

  * In `{{package}}/templates/viewer.js`, `{{package}}/templates/api/mapconfig.js`,
    `{{package}}/templates/edit.js` replace
    `url: '${tilecache_url}',` by `url: ${tiles_url | n},` (no quotes).

  * Change the `X-UA-Compatible` meta in the HTML templates, and other little
    things to do: in `{{package}}/templates/index.html`:

    - <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9">
    + <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9; IE=EmulateIE10">

    in `{{package}}/templates/edit.html`:

    - <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
    + <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9; IE=EmulateIE10">
      <title>{{package}} Geoportal Editor</title>
    - <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    + <link rel="shortcut icon" type="image/x-icon" href="${request.static_url('{{package}}:static/images/favicon.ico')}">

    in `{{package}}/templates/routing.html`:

    - <meta name="keywords" content="{{package}}, mapfish, editor, geoportal">
    - <meta name="description" content="{{package}} Geoportal Editor.">
    - <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
    + <meta name="keywords" content="{{package}}, mapfish, routing, geoportal">
    + <meta name="description" content="{{package}} Routing.">
    + <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9; IE=EmulateIE10">
      <title>{{package}} Routing</title>
    - <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    + <link rel="shortcut icon" type="image/x-icon" href="${request.static_url('{{package}}:static/images/favicon.ico')}">

    in `{{package}}/templates/edit.js`:

    - var THEMES = {
      var THEMES = {

  * Password modification UI has been implemented.

    It is now possible to allow the user to change his password, and optionally to remind him to change it.

      - In the `{{package}}/templates/viewer.js` and `{{package}}/templates/edit.js` files:
        You need to add some configuration parameters in the `cgxp_login` plugin:

            {
                ptype: "cgxp_login",
                actionTarget: "center.tbar",
                toggleGroup: "maptools",
            % if user:
                username: "${user.username}",
                isPasswordChanged: ${"true" if user.is_password_changed else "false"},
            % endif
                loginURL: "${request.route_url('login', path='')}",
                loginChangeURL: "${request.route_url('loginchange', path='')}",
                logoutURL: "${request.route_url('logout', path='')}",
                enablePasswordChange: true,
                forcePasswordChange: true,
                permalinkId: "permalink"
            },

        ``enablePasswordChange`` enables the password modification UI,
        ``isPasswordChanged`` is required if you enable ``forcePasswordChange``
        to remind the user he should change his password.

        If you need it see the documentation about password replication:
        http://docs.camptocamp.net/c2cgeoportal/integrator/password_replication.html

      - The form in {{package}}/templates/index.html and {{package}}/templates/edit.html must be updated:

              <form method="POST" id="loginForm" style="display: none">
                  <input id="login" name="login" type="text" autocomplete="on"/>
                  <input id="password" name="password" type="password" autocomplete="on"/>
            +     <input id="newPassword" name="newPassword" type="password" />
            +     <input id="confirmNewPassword" name="confirmNewPassword" type="password" />
              </form>

  * In the XAPI we don't anymore reset all default CSS attributes.
    Than the XAPI should not anymore break the CSS of the page.

    In the `{{package}}/templates/api/viewer.js` file in the `portalConfig`,
    you should add the line:

                ctCls: 'x-map',

    In the file `{{package}}/templates/api/xapi.js`, replace:

        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/ext-all.css')}" + '" />');

   By:

        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/core/src/theme/reset.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/editor.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/pivotgrid.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/menu.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/panel.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/grid.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/debug.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/qtips.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/dd.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/form.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/resizable.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/toolbar.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/slider.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/combo.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/layout.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/dialog.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/core.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/button.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/progress.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/tabs.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/box.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/borders.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/date-picker.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/tree.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/window.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/visual/list-view.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/editor.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/pivotgrid.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/menu.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/panel.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/grid.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/debug.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/qtips.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/dd.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/form.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/resizable.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/toolbar.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/panel-reset.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/slider.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/combo.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/layout.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/dialog.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/core.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/button.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/progress.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/tabs.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/box.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/borders.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/date-picker.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/tree.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/window.css')}" + '" />');
        document.write('<link rel="stylesheet" type="text/css" href="'
                + "${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/resources/css/structure/list-view.css')}" + '" />');


  * Because of a bug in Chrome on Windows highlighted by changes in OpenLayers,
    parts of the user may turn gray on large screens.  We advice you do the
    following changes in `{{package}}/templates/viewer.js`:

        -       wmsURL: "${request.route_url('mapserverproxy', path='')}"
        +       wmsURL: "${request.route_url('mapserverproxy', path='')}",
        +       wmsOptions: {
        +           ratio: (Ext.isChrome && Ext.isWindows) ? 1 : 1.5
        +       }

6. In the `production.ini.in`and `development.ini.in`:

    You must add the following lines in the `[app:app]` section:

        auth_replication_enabled = ${enable_auth_replication}
        sqlalchemy_replication.url = postgresql://${dbuser_replication}:${dbpassword_replication}@${dbhost_replication}:${dbport_replication}/${db_replication}

    Remove the parameter `tilecache.cfg`.

7. In the `buildout.cfg` file:

      - Remove all the `[versions]` section from your `buildout.cfg` file,
        from now it's managed in the `versions.cfg` file.

      - In the `[buildout]` section remove the line:

            find-links += http://pypi.camptocamp.net/internal-pypi/index/tileforge

      - Now the mobile is built by default than remove the line:

            parts += jsbuild-mobile mobile

8. Update the print configuration:

  * In the print config template `print/templates/print.mako.in`
    you should add the following config:

        localHostForward:
            from:
                - ${host}
            https2http: True

  * Remove print config file (changed and required only for Windows):

        git rm print/WEB-INF/classes/spring-application-context.xml

    For Windows user redo the change done in http://docs.camptocamp.net/c2cgeoportal/integrator/create_application.html?highlight=windows#configure-the-application

  * Add to git the new print file name:

        mv print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war.new
        git mv print/print-servlet-1.2-SNAPSHOT.war print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war
        mv print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war.new print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war
        git add print/print-servlet-2.0-SNAPSHOT-IMG-MAGICK.war

  * With Mapfish-Print 2.0 some legend parameters have been added or renamed.
    In the printing configuration, change the ``legends`` blocks as follows:

       -maxIconHeight: 0
       +iconMaxHeight: 0
       -maxIconWidth: 0
       +iconMaxWidth: 0
       +horizontalAlignment: left

9. Update the mobile application:

  * Sencha Touch upgrade:

      - Sencha Cmd 4.0.1.45 needs to be installed. Ensure that it's the case by
        typing `sencha` in your terminal console. It should return the following
        response::

            $ sencha
            Sencha Cmd v4.0.1.45
            Sencha Cmd provides several categories [...]

        At Camptocamp we provide a Debian package for that.

      - Some files can be removed from the mobile application directory since they
        are not used anymore. You can launch the following command::

            $ git rm -r {{package}}/static/mobile/.senchasdk \
                     {{package}}/static/mobile/app/view/GeolocateControl.js \
                     {{package}}/static/mobile/app/view/MobileMeasure.js \
                     {{package}}/static/mobile/sdk

      - In the ``{{package}}/__init__.py`` the following modifications of the
        routes to mobile built application are required::

         config.add_route('mobile_index_prod', '/mobile/')
         config.add_view('c2cgeoportal.views.entry.Entry',
                         attr='mobile',
    -                    renderer='{{package}}:static/mobile/build/production/index.html',
    +                    renderer='{{package}}:static/mobile/build/testing/App/index.html',
                         route_name='mobile_index_prod')
         config.add_route('mobile_config_prod', '/mobile/config.js')
         config.add_view('c2cgeoportal.views.entry.Entry',
                         attr='mobileconfig',
    -                    renderer='{{package}}:static/mobile/build/production/config.js',
    +                    renderer='{{package}}:static/mobile/build/testing/App/config.js',
                         route_name='mobile_config_prod')
    -    config.add_static_view('mobile', '{{package}}:static/mobile/build/production')
    +    config.add_static_view('mobile', '{{package}}:static/mobile/build/testing/App')


  * In the `{{package}}/static/mobile/config.js` file:

      - Move the 'rasterTpl' and all other mobile specific localisation
        in the `{{package}}/static/js/Proj/Lang/<lang>.js` files.

      - Remove any lines for translations:

            - OpenLayers.Lang.en = {
            -   ...
            - }
            - OpenLayers.Lang.fr = {
            -   ...
            - }
            - OpenLayers.Lang.de = {
            -   ...
            - }

      - The mobile application now has a built-in theme chooser, do the following changes:

            + App.themes = '${themes | n}';
            + App.theme = '${theme | n}';
            + App.WFSTypes = '${wfs_types | n}';

        Both themes and layers can now be configured to be visible on desktop or
        mobile, both or none.

      - The Overlay (`Openlayers.Layer.WMS`) layer should be removed.  Only the
        background layers should now be listed in the map config.


  * In the `{{package}}/static/mobile/app/view/Settings.js` file:

      - Currently the view is not scrollable, add the following in the config object:

        scrollable: 'vertical',

      - Change the 'Home' button with text. It's more coherent with the application's panels:

             }, {
                 xtype: 'button',
        -        iconCls: 'home',
        -        iconMask: true,
        +        text: OpenLayers.i18n('close'),
                 action: 'home'
             }]

  * Manage all translations in one place. Translations for the mobile
    application (layer names for example) are managed in the same place as for
    the desktop application.
    The following modifications are required.
    Change the `jsbuild/mobile.cfg` file as follows:

    @@ -8,6 +8,7 @@
     root =
         {{package}}/static/lib/cgxp/openlayers/lib
         {{package}}/static/lib/cgxp/proj4js
    +    {{package}}/static/js
    +    {{package}}/static/mobile
     first =
         OpenLayers/SingleFile.js
         OpenLayers/Console.js
    @@ -20,6 +21,9 @@ first =
         OpenLayers/BaseTypes/Size.js
         OpenLayers/Util.js
         OpenLayers/Lang.js
    +    OpenLayers/Lang/fr.js
    +    OpenLayers/Lang/en.js
    +    OpenLayers/Lang/de.js
    +    app/locale/fr.js
    +    app/locale/en.js
    +    app/locale/de.js
         proj4js/lib/proj4js.js
     exclude =
     include =
    @@ -45,3 +49,6 @@ include =
         OpenLayers/Format/GML.js
         OpenLayers/Strategy/Fixed.js
         OpenLayers/Control/Zoom.js
    +    Proj/Lang/fr.js
    +    Proj/Lang/en.js
    +    Proj/Lang/de.js

  * Add missing ``{{package}}/static/mobile/resources/css/app.css`` line in the ``.gitignore`` file,
    and remove the related file:

       git rm -f {{package}}/static/mobile/resources/css/app.css

  * Add new lines to your application's ``.gitignore`` file:

       {{package}}/static/mobile/bootstrap.js
       {{package}}/static/mobile/bootstrap.json

    Also remove the corresponding files from your repository:

        git rm -f {{package}}/static/mobile/bootstrap.js
        git rm -f {{package}}/static/mobile/bootstrap.json

10. In the `apache/wsgi.conf.in` do the following changes:

  * Make the end slash optional:

        -RewriteRule ^${apache-entry-point}$ /${instanceid}/wsgi/ [PT]
        +RewriteRule ^${apache-entry-point}?$ /${instanceid}/wsgi/ [PT]

  * Add the following line:

        RewriteRule ^${apache-entry-point}routing/?$ /${instanceid}/wsgi/routing [PT]

11. In the file `{{package}}/__init__.py` remove the following code::

    from c2cgeoportal.views.tilecache import load_tilecache_config

    # add a TileCache view
    load_tilecache_config(config.get_settings())
    config.add_route('tilecache', '/tilecache{path:.*?}')
    config.add_view(
        view='c2cgeoportal.views.tilecache:tilecache',
        route_name='tilecache')

12. Some important notices:

  * Public layers can no longer be edited (feature creation/update/deletion) by anonymous users.

  * Adds support for WMSTime layer which requires the isodate library
    for parsing dates from the mapfile.

    Note: The default time value specified in the map file ("wms_timedefault") is
    not currently taken into account due to a limitation in the OWSLib, see:
    https://github.com/geopython/OWSLib/pull/92

  * Mobile permalink field

      - On mobile, the page URL is now synchronized with the application state.
        Browsers native sharing function can be used to share a permalink.

      - Baselayers definition needs to be updated with a `ref` property, as
        it’s already on the desktop version:

        new OpenLayers.Layer.WMTS(OpenLayers.Util.applyDefaults({
            name: OpenLayers.i18n('plan'),
            layer: 'plan',
        +   ref: 'plan'
        }, WMTS_OPTIONS),

      - But if a permalink field is needed, just add the following component in the
        Settings view:

            { xtype: 'map_permalink' }

  * A new static schema is needed:

        sudo -u postgres psql -c 'CREATE SCHEMA <schema>_static;' <database>
        sudo -u postgres psql -c 'GRANT ALL ON SCHEMA <schema>_static TO "www-data";' <database>

  * Add the following lines at the end of the `deploy/hooks/post-restore-database.in` file:

        psql -c 'CREATE SCHEMA IF NOT EXISTS ${schema}_static;' ${db}
        psql -c 'CREATE TABLE ${schema}_static.shorturl (
            id serial PRIMARY KEY,
            url character varying(1000),
            ref character varying(20) NOT NULL UNIQUE,
            creator_email character varying(200),
            creation timestamp without time zone,
            last_hit timestamp without time zone,
            nb_hits integer
        );' ${db}

        psql -c 'GRANT USAGE ON SCHEMA "${schema}_static" TO "${dbuser}";' ${db}
        psql -c 'GRANT SELECT ON ALL TABLES IN SCHEMA "${schema}_static" TO "${dbuser}";' ${db}

  * The ShortURL table has been moved to a dedicated schema. The change
    will be automatically done in the dev database only. Before deploying
    the application in production, the "prod" database must be updated by
    running the following SQL statements::

        CREATE SCHEMA <schema>_static;
        GRANT ALL ON SCHEMA <schema>_static TO "www-data";
        ALTER TABLE <schema>.shorturl SET SCHEMA <schema>_static;
        ALTER TABLE <schema>_static.shorturl ALTER COLUMN ref SET NOT NULL;


Version 1.3.2
=============

1. Correct the mobile apache rewrite rules, in the 'apache/wsgi.conf.in' file
   do the following changes:

-RewriteRule ^${apache-entry-point}mobile/?$ /${instanceid}/wsgi/mobile/ [PT]
+RewriteRule ^${apache-entry-point}mobile$ ${apache-entry-point}mobile/ [R]
+RewriteRule ^${apache-entry-point}mobile/(.*)$ /${instanceid}/wsgi/mobile/$1 [PT]

2. Camptocamp pypi repository is now public. As a result the `.httpauth` file
   may be removed:

    git rm .httpauth

3. Remove all the `[versions]` section from your `buildout.cfg` file,
   from now it's managed in the `versions.cfg` file.

   Add the new `versions.cfg`file to Git:

        git add versions.cfg


Version 1.3.1
=============

1. One can now define a "default mobile theme" in the config.yaml configuration
   file. The default theme is the theme loaded when no theme is specified in
   the query string of the mobile app URL (/mobile). For example:

       mobile_default_theme: my_main_mobile_theme

   Not setting the mobile_default_theme in config.yaml is perfectly valid. In
   that case there's no "default mobile theme", and no theme information will
   be passed to the config.js template.

   Even if you don't need a "default mobile theme" it is recommended to set
   mobile_default_theme to "None" in config.yaml, with an appropriate text
   describing the role of this setting. For example:

       # The name of the theme to use as the default theme for the
       # mobile app. The default theme is the theme loaded when no
       # theme name is specified in the mobile app URL. If unset
       # then there's no default theme, and no theme information
       # will be passed to the config.js template.
       mobile_default_theme:

2. To make the `X-UA-Compatible` work again in the
   `{{package}}/templates/index.html` file the following block should be moved
   below all the <meta> tags:

        % if not no_redirect and mobile_url is not None:
                <script>
                    if(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {
                        window.location = "${mobile_url}";
                    }
                </script>
        % endif

3. The default value for `fallThrough` changed in OpenLayers. This has caused
   a major regression in the mobile app, where longpress queries no longer
   work.

   To fix it edit {{package}}/static/mobile/config.js and add `fallThrough: true`
   to the map config, before `theme: null` for example:


        App.map = new OpenLayers.Map({
            fallThrough: true, // required for longpress queries
            theme: null,
            ...
        });

4. Be sure that you don't use the ``SQLAlchemy`` 0.8 by having those dependencies
   in the ``[versions]`` section of ``buildout.cfg`` file::

        sqlalchemy = 0.7.9
        sqlalchemy-migrate = 0.7.2


Version 1.3
===========

1. The c2cgeoportal mobile application now supports authentication, and dynamic
   theme/layer configuration based on the database configuration. This requires
   a few changes to existing applications.

   The c2cgeoportal mobile functions to be configured as view callables in the
   application are now part of the c2cgeoportal entry.py view module. This
   change requires changing the way mobile views should be defined in the
   application. Edit {{package}}/__init__.py and replace the entire "# mobile
   views and routes" block by the one provided in the "mobile" chapter of the
   integrator doc [*]. Do not forget to replace "<package_name>" by
   "{{package}}" in the new route and view definitions.

   [*] <http://docs.camptocamp.net/c2cgeoportal/integrator/mobile.html#adding-mobile-routes-and-views>

   To use the "Login" view component as documented in the mobile chapter of the
   documentation you need to have the following line in
   {{package}}/static/mobile/config.js:

   App.info = '${info | n}';

   You should add this line even if you don't use the "Login" component.

2. Adding the following entries to all the ``root`` lists in
   ``jsbuild/app.cfg`` is recommended:

        {{package}}/static/lib/cgxp/geoext.ux/ux/WMSBrowser/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/StreetViewPanel

3. Adding the following entry at the end of the ``first`` sections
   of all files (except the language ones) in ``jsbuild/app.cfg`` is recommended:

        proj4js/lib/projCode/merc.js

4. Adding the following entry to the ``include`` section
   of ``[lang-fr.js]`` in ``jsbuild/app.cfg`` recommended:

        GeoExt.ux/locale/WMSBrowser-fr.js

   Same for ``[lang-de.js]``.

5. Auto redirection to mobile application has been added.

   Add the following in the ``{{package}}/templates/index.html`` for the main
   application just after the ``<head>`` opening tag:

        % if not no_redirect and mobile_url is not None:
                <script>
                    if(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {
                        window.location = "${mobile_url}";
                    }
                </script>
        % endif

   You'll also need to add the following translations for the mobile
   application in ``config.js``:

           // redirect to standard application
           'redirect_msg': "Vous utilisez la version mobile. Vous pouvez aussi" +
               " consulter la <a href='${'${url}'}'>version standard</a>.",
           'close': "Fermer"

   Once redirected to the mobile version, tablet users can go back to standard
   application. In order for them to navigate in the map comfortably, it's
   recommended to add the support for pinch zoom. You'll need to add the
   following to the [app.js] section of ``jsbuild/app.cfg`` right below the
   include for ``Navigation.js``:

       OpenLayers/Control/PinchZoom.js

6. Adding ``geodesic: true`` to the ``OpenLayers.Control.ScaleLine`` configuration
   in ``viewer.js``, ``edit.js`` (as well as other templates or Javascript files
   using that kind of control) might solve incorrect scalelines with mercator
   projections.

7. The geolocate functionality of the mobile application has been refactored.
   It is required to add the following line to the list of includes in
   ``jsbuild/mobile.cfg``:

        OpenLayers/Control/Zoom.js

8. In the file `apache/wsgi.conf.in` remove the trailing '/' in the `edit`
   `RewriteRule`.

-RewriteRule ^${apache-entry-point}edit/?$ /${instanceid}/wsgi/edit/ [PT]
+RewriteRule ^${apache-entry-point}edit/?$ /${instanceid}/wsgi/edit [PT]

9. On the API help we have some issue with IE7 and IE8, to fix them you
   should apply the same modification as in the following commit:
   https://github.com/camptocamp/c2cgeoportal/commit/3a8f0e4d87ab4199d474c0e8ed6cc33038e2e795
   or regenerate the API help:

        ./buildout/bin/pcreate -s c2cgeoportal_create /tmp/{{project}} package={{package}}
        cp -r /tmp/{{project}}/{{package}}/templates/api/apihelp.html {{package}}/templates/api
        cp -r /tmp/{{project}}/{{package}}/templates/api/xapihelp.html {{package}}/templates/api
        rm -rf /tmp/{{project}}

10. c2cgeoportal 1.3 requires papyrus 0.10dev1. If papyrus is set to 0.9 or
    lower in the [versions] section of buildout.cfg, change it to 0.10dev1.

11. In the file `{{package}}/templates/edit.html` you should add
    the `${extra_params}` value:

-        <script type="text/javascript" src="${request.route_url('edit.js')}"></script>
+        <script type="text/javascript" src="${request.route_url('edit.js')}${extra_params}"></script>

12. Don't need anymore to specify the queryableLayers in th API.
    Than you should do on your `{{package}}/templates/api/api.js`
    and in `{{package}}/templates/api/xapi.js` do this replacement:

-    this.queryableLayers = [<...>];
+    this.queryableLayers = ${queryable_layers|n};


Version 1.2
===========

1. A new ``Settings`` view has been added to the mobile application as well as a
   ``custom.scss`` stylesheet file. Both are intended to be customized by the
   integrator.
   Check out documentation to find information about how to upgrade an existing
   c2cgeoportail project or how the settings view can be customized.

   As minimal you should get the new files:

        ./buildout/bin/pcreate -s c2cgeoportal_create \
                /tmp/{{project}} package={{package}}
        cp -r /tmp/{{project}}/{{package}}/static/mobile/custom.scss {{package}}/static/mobile/
        cp -r /tmp/{{project}}/{{package}}/static/mobile/app/ {{package}}/static/mobile/
        rm -rf /tmp/{{project}}

2. CGXP plugin WFSGetFeature now requires that the themes are explicitly passed
   in its configuration in {{package}}/templates/viewer.js using the following
   parameter:

    themes: THEMES

3. In the mobile application, the buttons' text in the picker for the layer
   switcher (on phones) can now be translated.

   Add the following in the OpenLayers.Lang.xx section of your `config.js` file:

    // picker
    'layer_switcher.cancel': 'Annuler',
    'layer_switcher.done': 'OK'

4. A new caching system has been introduced and it has to be configured in the
   config.yaml file. So you have to edit ``config.yaml.in`` and
   ``config_child.yaml.in`` files to add the following configuration:

    # The dogpile.cache configuration.
    #
    # Do not touch if unsure.
    #
    # The cache section below takes three properties:
    #
    # - backend: the name of the cache backend (ex: dogpile.cache.memory,
    #   dogpile.cache.memcached, etc.). Mandatory.
    # - expiration_time: the cache expiration time. Optional (infinite if not
    #   specified).
    # - arguments: backend-specific arguments. Optional.
    #
    # Here is a dogpile.cache configuration example for the memcached backend
    # (equivalent of http://dogpilecache.readthedocs.org/en/latest/api.html#dogpile.cache.backends.memcached.MemcachedBackend)
    # cache:
    #   backend: dogpile.cache.memcached
    #   expiration_time: 3600
    #   arguments:
    #     url: 127.0.0.1:11211
    cache:
      backend: dogpile.cache.memory

   The caching system also refactored the way errors are handled: all errors
   are now stored in ``serverError``, while ``themesError`` is not used
   anymore.  So you have to edit all template files (``templates/viewer.js``,
   ``templates/edit.js``, ``templates/apiviewer.js``) to remove the following
   line:

    /* errors (if any): ${themesError | n} */

5. Some updates will be do in the `edit.js` and in the `viewer.js`, the actual code
   will still work, it your interested in have a look at:
   https://github.com/camptocamp/c2cgeoportal/pull/354

6. CGXP now uses the GeOrchestra styler, which includes its own en, fr,
   and de translations. Edit jsbuild/app.cfg, and in the [lang-en.js],
   [lang-fr.js], and [lang-de.js] sections replace

   - Styler/resources/lang/en.js by Styler/lang/en.js
   - Styler/resources/lang/fr.js by Styler/lang/fr.js
   - Styler/resources/lang/de.js by Styler/lang/de.js

   The Styler/resources/lang/en.js, Styler/resources/lang/fr.js, and
   Styler/resources/lang/de.js files no longer exist, so you will get
   an error during the execution of the jsbuild part if you do not
   do these replacements.

7. It is now possible to disable the administration interface, for example on
   productive instances of the application. To do so:

   a. Edit the main() function in {{package}}/__init__.py and use

       from pyramid.settings import asbool
       if asbool(config.get_settings().get('enable_admin_interface')):
           config.formalchemy_admin('admin', package='{{package}}',
                   view='fa.jquery.pyramid.ModelView', factory=FAModels)

      instead of

       config.formalchemy_admin('admin', package='{{package}}',
               view='fa.jquery.pyramid.ModelView', factory=FAModels)

   b. Add the following parameter in the ``[app:app]`` section of
      production.ini.in/developement.ini.in:

       enable_admin_interface = ${enable_admin_interface}

   c. Add the following parameter in the ``[vars]`` section of buildout.cfg:

       enable_admin_interface = true

   d. Adapt the latter parameter value in the buildout_*.cfg files.

8. CGXP's FullTextSearch's plugin now allows to group results by their
   corresponding type.

   a. We recommend you add the following to the root list in the app.js section
      of ``app.cfg``:

       {{package}}/static/lib/cgxp/ext.ux/GroupComboBox

   b. If you want the results to be grouped, add a ``grouping`` option to the
      FullTextSearch plugin in ``viewer.js`` as well as the following line in
      the include list in the app.js section of ``app.cfg``:

       Ext/ux/form/GroupComboBox.js

9. A new parameter, layerManagerUrl, has been added to the cgxp_redlining plugin,
   to fix a problem with the base url used to access various resources used in
   the related layerManager widget:

        {
            ptype: "cgxp_redlining",
            toggleGroup: "maptools",
            actionTarget: "center.tbar",
            layerManagerUrl: "${request.static_url('{{package}}:static/lib/cgxp/sandbox/LayerManager/ux/')}"
        },

10. The ``functionality`` variable available in Mako templates (e.g. ``viewer.js``)
    used to be a string. It is now a dict.
    See https://github.com/camptocamp/c2cgeoportal/pull/400. To accomodate
    this change in your project you need to

    - Remove the FUNCTIONALITY JavaScript variable from viewer.js and
      edit.js. This line:

          var FUNCTIONALITY = ${functionality | n};

    - Change the value for the ``defaultBaseLayerRef`` config option of the
      MapOpacitySlider plugin from ``FUNCTIONALITY.default_basemap[0]`` to:

          defaultBaseLayerRef: "${functionality['default_basemap'][0] | n}"

    Also, if you used ``c2cgeoportal.lib.functionality.get_functionality``
    in your templates you no longer need to, use ``functionality`` directly.

11. checker_pdf requires that the central coordinates and scale of the map to
    print when checking the printing service are provided in ``config.yaml.in``.
    Add the following after the ``tilecache_url``:

        # Checker configuration
        checker:
            print_template: 1 A4 portrait
            print_center_lon: to be defined
            print_center_lat: to be defined
            print_scale: 10000
            fulltextsearch: text to search

12. c2cgeoportal applications created with the c2cgeoportal 1.2 scaffolds
    include two JavaScript APIs : Simple API and Extended API. This has
    a few implications on existing applications, whether you want your
    applications to expose the JavaScript APIs or not.

    Project Lang Files ({{package}}/static/js/Lang)

        You need to split each lang file into two files. For example,
        {{package}}/static/js/Proj/Lang/fr.js should be splitted into
        {{package}}/static/js/Proj/Lang/fr.js and
        {{package}}/static/js/Proj/Lang/GeoExt-fr.js. The former should include
        OpenLayers-based translations only, and the latter should include
        GeoExt-based translations only. If your application does not have
        GeoExt-based translations (which is a good thing), you will need to
        create an empty {{package}}/static/js/Proj/Lang/GeoExt-fr.js file. And you
        obviously need to repeat this GeoExt-en.js and GeoExt-de.js.

    JavaScript Build Config (jsbuild/app.cfg)

        The {{package}}/static/js/Proj/Lang/GeoExt-<code>.js files should now be
        listed in the ``include`` list of ``[lang-<code>.js]`` sections. For
        example:

            [lang-fr.js]
            root =
                ...
            first =
                OpenLayers/Lang/fr.js
            include =
                Ext/src/locale/ext-lang-fr.js
                GeoExt/locale/GeoExt-fr.js
            # FeatureEditing/resources/lang/en.js
                FeatureEditing/resources/lang/fr.js
                Styler/lang/fr.js
                locale/fr.js
                CGXP/locale/fr.js
                Proj/Lang/fr.js
                Proj/Lang/GeoExt-fr.js
            exclude =
                OpenLayers/Lang.js

        And if you do want your application to expose the APIs you need to edit
        jsbuild/app.cfg, remove the previous ``[api.js]`` section and add new
        sections ``[api.js]``, ``[api-lang-en.js]``, ``[api-lang-fr.js]``,
        ``[api-lang-de.js]``, and ``[xapi.js]``. See
        https://github.com/camptocamp/c2cgeoportal/blob/master/c2cgeoportal/scaffolds/create/jsbuild/app.cfg_tmpl
        for the actual content of these new sections.

    Application-level CSS

        The {{package}}/static/css/proj.css include the application-level CSS.
        This file should be splitted into three files:

        - {{package}}/static/css/proj.css
        - {{package}}/static/css/proj-map.css
        - {{package}}/static/css/proj-widgets.css

        proj-map.css is used by the main application viewers (viewer.js and
        edit.js), the Simple API, and the Extended API. It shouldn't include
        any Ext-related CSS.

        proj-widgets.css is used by the main application viewers and the Extended
        API. It should include CSS that for the CGXP plugins.

        proj.css is used by the main application viewers only. It should there
        include CSS that is relative to the application layout.

        If you don't care about the APIs and do not want to split your proj.css
        file into three files as explained above you will still need to create
        empty files for proj-map.css and proj-widgets.css, otherwise the cssmin
        buildout part will fail, and your application pages will cause 404s
        in debug mode.

    Make index.html and edit.html load the new CSS files in debug mode.

        You need to edit index.html and edit.html to make these pages load
        the new proj-map.css and proj-widgets.css files when in debug mode.
        This is done by adding the following <link> tags below that for
        proj.css:

            <link rel="stylesheet" type="text/css" href="${request.static_url('{{package}}:static/css/proj-map.css')}" />
            <link rel="stylesheet" type="text/css" href="${request.static_url('{{package}}:static/css/proj-widgets.css')}" />

    Adding the APIs to your application

        The easiest is to apply the ``c2cgeoportal_create`` template to
        create a temporary project and copy the API files from this
        temporary project to yours::

        $ cd {{project}}
        $ ./buildout/bin/pcreate -s c2cgeoportal_create \
                /tmp/{{project}} package={{package}}
        $ cp -r /tmp/{{project}}/{{package}}/templates/api {{package}}/templates/
        $ cp -r /tmp/{{project}}/{{package}}/static/apihelp {{package}}/static/
        $ rm -rf /tmp/{{project}}

    Clean up (remove old API-related files)

        $ cd {{project}}
        $ rm -f {{package}}/static/js/api/Map.js
        $ rm -f {{package}}/templates/apihelp.html
        $ rm -f {{package}}/templates/apiloader.js
        $ rm -f {{package}}/templates/apiviewer.js

    Add RewriteRule's to Apache config

        The apache/wsgi.conf.in file defines RewriteRule's for shorter
        URLs to the application's entry points.

        Add the following API-related RewriteRule's:

        RewriteRule ^${apache-entry-point}api.js$ /${instanceid}/wsgi/api.js [PT]
        RewriteRule ^${apache-entry-point}xapi.js$ /${instanceid}/wsgi/xapi.js [PT]
        RewriteRule ^${apache-entry-point}xapihelp.html$ /${instanceid}/wsgi/xapihelp.html [PT]

        And remove this one:

        RewriteRule ^${apache-entry-point}apiloader.js$ /${instanceid}/wsgi/apiloader.js [PT]

13. Add the following lines in `apache/wsgi.conf.in` to enable short URLs
    for the editing, mobile and admin pages:

    RewriteRule ^${apache-entry-point}edit/?$ /${instanceid}/wsgi/edit/ [PT]
    RewriteRule ^${apache-entry-point}mobile/?$ /${instanceid}/wsgi/mobile/ [PT]
    RewriteRule ^${apache-entry-point}admin/?$ /${instanceid}/wsgi/admin/ [PT]

14. Redlining is now supported in CGXP's Permalink.
    The following path should be added in all root sections
    of `jsbuild/app.cfg`:

    {{package}}/static/lib/cgxp/openlayers.addins/URLCompressed/lib

15. CGXP's Redlining plugin (drawing tools) has been enhanced. It requires the
    following updates:

    - In ``app.cfg`` you need to replace the lines with:

        CGXP/widgets/RedliningColorPicker.js

    by:

        CGXP/plugins/Redlining.js

    - In the ``index.html`` template, in the section where the css files are
      loaded in debug mode, you'll have to add the following code right above
      the one for ``proj.css``:

        <link rel="stylesheet" type="text/css" href="${request.static_url('{{package}}:static/lib/cgxp/ext/Ext/examples/ux/css/Spinner.css')}" />

16. Update the checker for the new api, in the section `check_collector` the
    `checker_apiloader` doesn't exists anymore,
    it's replaced by `checker_api`, and `checker_xapi`.

17. The fulltextsearch web service supports a new parameter in the query
    string, "partitionlimit". If "partitionlimit" is set to a positive number
    the fulltextsearch web service limits the search results by layer
    (layer_name field in the tsearch table). For example, if "partitionlimit"
    is set to 10 and "limit" is set to 40, the response will include at most
    10 results per layer, and at 40 results total. For this to take effect
    in the viewer CGXP commit [*] or more recent should be used.

    [*] https://github.com/camptocamp/cgxp/commit/b620dd154b55c6f14eee8fdc09abb5583615d78b

18. In the file `jsbuild/app.cfg`, for file `[lang-en.js]`, in section `include`:
    remove the line `CGXP/locale/en.js`, and add the localisation in the files:

    `{{package}}/static/js/Proj/Lang/en.js`:
    "layertree": "Themes"

    `{{package}}/static/js/Proj/Lang/fr.js`:
    "layertree": "Thèmes"

    `{{package}}/static/js/Proj/Lang/de.js`:
    "layertree": "Themen"


Version 1.1
===========

1. Add the following line to the jsbuild/mobile.cfg file in the include section:

    OpenLayers/Control/Geolocate.js

2. For the FeaturesWindow CGXP plugin we need to add the following line to the
   jsbuild/app.cfg file in the root sections:

    {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureSelectionModel/lib

3. The admin interface relies on the js.jqueryui_selectmenu Python package,
   which does not work with js.jquery > 1.7.1 (the Jump to... dropdown does not
   work). c2cgeoportal 1.1 will refuse to work with/be installed alongside
   js.jquery > 1.7.1. Just make sure js.jquery is not set to a version > 1.7.1
   in your project's buildout config (buildout.cfg.). If it is then change that
   to "js.jquery = 1.7.1", and execute buildout again.

4. Currently there are authentication-related issues when multiple instances of
   a c2cgeoportal application are running on the same machine. Indeed, loging
   into one instance would log you out of from the instance you're currently
   loged into. See <https://github.com/camptocamp/c2cgeoportal/issues/196>.

   Fixing the issue requires manual changes to development.ini.in,
   production.ini.in, and {{package}}/__init__.py.

   Edit development.ini.in and production.ini.in and add the following
   variable definition to the [app:app] section:

       authtkt_cookie_name = auth_tkt_${instanceid}

   (It is probably a good idea to group the definitions of authtkt_secret and
   authtkt_cookie_name together, as they're both related to authentication.)

   Now edit {{package}}/__init__.py to pass a `cookie_name` to the
   `AuthTktAuthenticationPolicy` constructor:

        authentication_policy = AuthTktAuthenticationPolicy(
                settings.get('authtkt_secret'),
                callback=defaultgroupsfinder,
                cookie_name=settings.get('authtkt_cookie_name'))


Version 1.0
===========

1. We create a configuration file, config.yaml includes the static
   configuration of the application. buildout.cfg includes the execution
   environment configuration, where environment variables are defined.

   To create an initial configuration from your current configurations you
   should:

   - Rollback the CONST_buildout.cfg:
       git checkout CONST_buildout.cfg

   - If you are a child make sure that you have a variable
       ``parent_instanceid`` defined in the ``[vars]`` section
       of the ``buildout.cfg`` file.

   - Create a file named 'config.yaml.in' that contains, for a parent:

# ------------------------------------------------------------------------
# The application's default language. This is the language
# used if no language is specific by the application user.
# This also defines the language used for the text search.
default_locale_name: ${default_language}

# The set of languages supported by the applications.
TODO fix the array (comma is missing)
available_locale_names: [${available_languages}]

admin_interface:
# Default values for the admin interface's maps.
    map_x: ${formalchemy_default_lon}
    map_y: ${formalchemy_default_lat}
    map_zoom: ${formalchemy_default_zoom}

# The list of functionalities that can be configured
# through the admin interface.
TODO fix the array (comma is missing)
    available_functionalities: [${formalchemy_available_functionalities}]

functionalities:
# Functionalities that are accessible to anonymous
# users.
    anonymous: ${anonymous_functionalities}

# Functionalities that are accessible to authenticated
# users with no associated functionalities in the
# database.
    registered: ${registered_functionalities}

# Functionalities that are made available to Mako templates.
TODO fix the array (comma is missing)
    available_in_templates: [${webclient_string_functionalities}, ${webclient_array_functionalities}]

# Define URLs to the parent application. Only useful is
# this application is a child application in a parent/child
# architecture.
external_themes_url:
external_mapserv_url:

# The "raster web services" configuration. See the "raster"
# chapter in the integrator documentation.
raster:

# For mapserver proxy
mapserv_url: http://$${host}/$${instanceid}/mapserv

# For print proxy
print_url: http://$${host}:8080/print-c2cgeoportal-$${instanceid}/pdf/

# For base layers
# Nothing => gets the URL using the pyramid routes
tilecache_url:
# ------------------------------------------------------------------------

        for a child:
# ------------------------------------------------------------------------
# The application's default language. This is the language
# used if no language is specific by the application user.
# This also defines the language used for the text search.
default_locale_name: ${default_language}

# The set of languages supported by the applications.
TODO fix the array (comma is missing)
available_locale_names: [${available_languages}]

admin_interface:
# Default values for the admin interface's maps.
    map_x: ${formalchemy_default_lon}
    map_y: ${formalchemy_default_lat}
    map_zoom: ${formalchemy_default_zoom}

# The list of functionalities that can be configured
# through the admin interface.
TODO fix the array (comma is missing)
    available_functionalities: [${formalchemy_available_functionalities}]

functionalities:
# Functionalities that are accessible to anonymous
# users.
    anonymous: ${anonymous_functionalities}

# Functionalities that are accessible to authenticated
# users with no associated functionalities in the
# database.
    registered: ${registered_functionalities}

TODO fix the array (comma is missing)
    available_in_templates: [${webclient_string_functionalities}, ${webclient_array_functionalities}]

# Define URLs to the parent application. Only useful is
# this application is a child application in a parent/child
# architecture:
external_themes_url: http://$${host}/$${parent_instanceid}/wsgi/themes
external_mapserv_url: http://$${host}/$${parent_instanceid}/mapserv

# The "raster web services" configuration. See the "raster"
# chapter in the integrator documentation.
raster:

# For mapserver proxy
mapserv_url: http://$${host}/$${instanceid}/mapserv

# For print proxy
# This value mean that we use the parent print server
print_url: http://$${host}:8080/print-c2cgeoportal-$${parent_instanceid}/pdf/

# For base layers
# This value mean that we use the parent tiles
tilecache_url: http://$${host}/$${parent_instanceid}/wsgi/tilecache
# ------------------------------------------------------------------------

    - Then interpretate it by running:
        ./buildout/bin/buildout install template

    - Rename the generated file as the source file:
        mv config.yaml config.yaml.in

    - In this file (config.yaml.in) there are some lines that contain
        « TODO fix the array (comma is missing) ». This indicates that the
        array is not correctly formatted. Fix the formatting by adding the
        missing comma and remove the TODO lines.

    - Add the config in the repository
        git add config.yaml.in

    - Add config.yaml in the .gitignore file

    - In the file tilecache/tilecache.cfg.in replace:

        url = ${mapserv_url}
        by:
        url = http://${host}/${instanceid}/mapserv

        and

        wmts_gettile = ${wmts_url}
        by
        wmts_gettile = http://${host}/${instanceid}/tilecache

    - In the file mapserver/c2cgeoportal.map.in replace:

        "wms_onlineresource" "http://${wsgi_host}/${instanceid}/wsgi/mapserv_proxy"
        by
        "wms_onlineresource" "http://${host}/${instanceid}/wsgi/mapserv_proxy"

    - Add the following line in the [app:{{package}}] of the production.ini.in
            and the developement.ini.in:
        app.cfg = %(here)s/config.yaml

    - Remove the following attributes from the production.ini.in
            developement.ini.in, an buildout.cfg files:
        default_locale_name
        available_languages
        default_language
        mapserv.url
        print.url
        formalchemy_default_zoom
        formalchemy_default_lon
        formalchemy_default_lat
        formalchemy_available_functionalities
        raster
        anonymous_functionalities
        registered_functionalities
        webclient_string_functionalities
        webclient_array_functionalities
        external_themes_url
        external_mapserv_url
        tilecache_url

    - Re apply the update scaffold to regenerate the CONST_buildout file:
        ./buildout/bin/pcreate --interactive -s c2cgeoportal_update ../{{project}} package={{package}}

    - In the file ``print/templates/print.mako.in`` replace
        ``${mapserv_host}`` and ``${wsgi_host}`` by ``${host}``.

    - In the file ``./apache/mapserver.conf.in`` remove the line
        Allow from ${mapserv_host}
        we will use only ${mapserv_allow}

    - Edit ``{{package}}/templates/viewer.js`` and ``{{package}}/templates/edit.js`` and change

          % if len(tilecache_url) == 0

          to

          % if not tilecache_url or len(tilecache_url) == 0:

2. Theme loading with Friendly Url

   It is now possible to load themes directly from a Friendly Url of the type:
   http://www.example.com/theme/themename1/themename2[/themenamex]

   The following modifications are needed:

   - In viewer.js in the cgxp_layertree plugin configuration, replace:
       defaultThemes: ["xyz"],
     by:
       % if permalink_themes:
         defaultThemes: ${permalink_themes | n},
       % else:
         defaultThemes: ["xyz"],
       % endif

   - In index.html, replace:
       <script type="text/javascript" src="${request.route_url('viewer')}"></script>
     by:
       <script type="text/javascript" src="${request.route_url('viewer')}${extra_params}"></script>

   - In wsgi.conf.in, add a new RewriteRule:
     RewriteRule ^${apache-entry-point}theme/(.+)$ /${instanceid}/wsgi/theme/$1 [PT]

3. To add the support of WMTS layers the database should be updated by
   standard procedure, CGXP also. We also need the ogcproxy, and to
   use is we need to add the following line in the file
   {{package}}/templates/viewer.js:

        OpenLayers.ProxyHost = "${request.route_url('ogcproxy')}?url=";

4. CGXP helper tools

   Some javascript helpers have been added to cgxp, allowing to open internal
   message or external html into an Ext Windows popup.

   The following modification is needed:

   - add "CGXP/tools/tools.js" to the 'include' list in the '[app.js]' section of
     the 'jsbuild/app.cfg' file

   If your project already used this Ext Windows popup system but with the
   functions called from the viewer.js with the app. namespace, you can remove
   the function from that template but you need to replace the "app." by
   "cgxp.tools." in all the javascript calls, ie:
   <a href="javascript:app.openInfoWindow('http://www.test.com', 'Popup title', 600, 500);">Link text</a>
   become
   <a href="javascript:cgxp.tools.openInfoWindow('http://www.test.com', 'Popup title', 600, 500);">Link text</a>

5. Add new deploy hooks to set the databases rights.
   cd {{project}}
   ./buildout/bin/pcreate --overwrite -s c2cgeoportal_create /tmp/{{project}} package={{package}}
   cp /tmp/{{project}}/deploy/hooks/post-restore-database.in deploy/hooks/
   chmod +x deploy/hooks/post-restore-database.in
   rm -rf /tmp/{{project}}

6. HTTPS detection

   If your application is accessed in HTTPS but is behind some proxies that remove the SSL encryption,
   you can make sure that all generated URLs (CSS and Javascript files, images, MapServer requests, etc.)
   use the HTTPS scheme by specifing to c2cgeoportal an HTTP header to test for some value. For instance:
   - In config.yaml.in:
       https_flag_header: X_HTTPS
       https_flag_value: 'on'

7. New raster and profile web services are now available and require some configuration.
    For the configuration of these web services read the documentation at
    'administrator/raster'.

8. Mobile application

   Version 1.0 of c2cgeoportal includes a mobile application template/scaffold.

   To add a mobile application to an existing project you need to copy two
   files from the c2cgeoportal_create scaffold, and add routes and views to the
   project configuration. See below.

   Copy config.js and mobile.cfg from c2cgeoportal_create:

   $ cd {{project}}
   $ ./buildout/bin/pcreate -s c2cgeoportal_create \
           /tmp/{{project}} package={{package}}
   $ cp /tmp/{{project}}/{{package}}/static/mobile/config.js \
        {{package}}/static/mobile/
   $ cp /tmp/{{project}}/jsbuild/mobile.cfg jsbuild/
   $ rm -rf /tmp/{{project}}

   Add routes and views:

   # mobile views and routes
   config.add_route('mobile_index_dev', '/mobile_dev/')
   config.add_view('c2cgeoportal.views.mobile.index',
                   renderer='{{package}}:static/mobile/index.html',
                   route_name='mobile_index_dev')
   config.add_route('mobile_config_dev', '/mobile_dev/config.js')
   config.add_view('c2cgeoportal.views.mobile.config',
                   renderer='{{package}}:static/mobile/config.js',
                   route_name='mobile_config_dev')
   config.add_static_view('mobile_dev', '{{package}}:static/mobile')

   config.add_route('mobile_index_prod', '/mobile/')
   config.add_view('c2cgeoportal.views.mobile.index',
                   renderer='{{package}}:static/mobile/build/production/index.html',
                   route_name='mobile_index_prod')
   config.add_route('mobile_config_prod', '/mobile/config.js')
   config.add_view('c2cgeoportal.views.mobile.config',
                   renderer='{{package}}:static/mobile/build/production/config.js',
                   route_name='mobile_config_prod')
   config.add_static_view('mobile', '{{package}}:static/mobile/build/production')

   Now read http://docs.camptocamp.net/c2cgeoportal/integrator/mobile.html to
   know how to build and customize the mobile application.

9. GeoExt popup css resource in template for debug mode was missing
   - add:
     <link rel="stylesheet" type="text/css" href="${request.static_url('{{package}}:static/lib/cgxp/geoext/resources/css/popup.css')}" />
     in file {{package}}/templates/index.html

10. In the CGXP print plugin config autoFit: true should be set in the "options"
   object instead of the "outputConfig" object.

   Change from:

        {
            ptype: "cgxp_print",
            legendPanelId: "legendPanel",
            featureGridId: "featureGrid",
            outputTarget: "left-panel",
            printURL: "${request.route_url('printproxy', path='')}",
            mapserverURL: "${request.route_url('mapserverproxy', path='')}",
            options: {
                labelAlign: 'top',
                defaults: {
                    anchor:'100%'
                }
            },
            outputConfig: {
                autoFit: true
            }
        },

    to:

        {
            ptype: "cgxp_print",
            legendPanelId: "legendPanel",
            featureGridId: "featureGrid",
            outputTarget: "left-panel",
            printURL: "${request.route_url('printproxy', path='')}",
            mapserverURL: "${request.route_url('mapserverproxy', path='')}",
            options: {
                labelAlign: 'top',
                defaults: {
                    anchor:'100%'
                },
                autoFit: true
            }
        },

11. IE9 slider issue doesn't require a compatible meta anymore.

    Remove the following meta from the index.html template:

    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />

    And add the following lines to the jsbuild/app.cfg file:

    - in the root section:
        {{package}}/static/lib/cgxp/ext.overrides

    - in the include section:
        DragTracker.js #ext.override

12. Add the following line to the root section of the app.js section in jsbuild/app.cfg:

    {{package}}/static/lib/cgxp/dygraphs

    Also add the following line in the index.html template:

    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9">

13. The "featureGridId" parameter has been renamed to "featureProvider" in the
    print config.

14. In case you're using the cgxp_querier plugin, you need to replace the
    "featureType" config option by "featureTypes" which is now an array:

    - featureType: 'the_layer',
    + featureTypes: ['the_layer'],

15. Update the print. A new file is required. To get it do the following:

    ./buildout/bin/pcreate -s c2cgeoportal_create /tmp/{{project}} package={{package}}
    cp /tmp/{{project}}/print/WEB-INF/classes/spring-application-context.xml \
            print/WEB-INF/classes
    git add print/WEB-INF/classes/spring-application-context.xml
    rm -rf /tmp/{{project}}

16. The cgxp-install part is now deactivated by default, so if you still use
    SVN, you have to add it back in your ``buildout.cfg`` file, section
    ``[buildout]``. Since this part needs to be run before jsbuild and cssbuild,
    you have to override the whole parts list. For instance:

        parts = eggs
                activate
                template
                modwsgi
                cgxp-install
                jsbuild
                cssbuild
                po2mo
                print-template
                print-war

    If you are on Git the this line isn't needed any more in
    your ``buildout.cfg`` file, section ``[buildout]``:

        parts -= cgxp-install

17. It is recommended to edit the project's ``development.ini.in`` and
    ``production.ini.in`` files and change ``[app:{{package}}]`` to
    ``[app:app]``, and in the section ``[pipeline:main]`` replace
    ``pipeline = weberror fanstatic {{package}}`` by
    ``pipeline = weberror fanstatic app``. In this way the ``manage_db``
    and ``manage_users`` commands can be used without specifying any
    application name using the ``--app-name`` switch - "app" is the default.
    This change is recommended, but optional.

    You should also modify your create_db script like this commit:
        https://github.com/camptocamp/c2cgeoportal/commit/8ae339c526719de953027beb72f5e1b649a93780

18. Add the FUNCTIONALITY var in viewer.js and use it in the map
    opacity slider config.

        var FUNCTIONALITY = ${functionality | n};

    and

        {
            ptype: "cgxp_mapopacityslider",
            defaultBaseLayerRef: FUNCTIONALITY.default_basemap[0]
        }

    Make sure there's a default_basemap set. default_basemap should probably
    be set for anonymous users in config.yaml.in:

        functionalities:
            anonymous:
                print_template:
                - 1 A4 portrait
                - 2 A3 landscape
                default_basemap: plan

19. The file 'deploy/hooks/post-restore-code' is unneeded, it should be removed.

20. In the file '.gitignore' the following lines should be added:
    *.pyc
    deploy/hooks/post-restore-database
    {{package}}/static/mobile/resources/sass/.sass-cache
    {{package}}/static/mobile/archive/
    {{package}}/static/mobile/build/
    {{package}}/static/mobile/openlayers-mobile.js

21. Improve the checker an add a check collector, see integator/check in the
    documentation to configure them.
    Something like this can be removed in the {{package}}/__init__.py
    config.add_settings({'check_print_template': '1 A4 portrait'})
    config.add_settings({'check_FullTextSearch': 'te'})


Version 0.7
===========

1. The "pserve" command should now be used instead of "paster serve".

   For "pserve" to work a few simple modifications are required in
   development.ini.in, production.ini.in, print/config.yaml.in and
   print/templates/print.mako.in.

   - In development.ini.in and production.ini.in and replace "use
     = egg:Paste#http" by "use = egg:waitress#main".

   - In development.ini.in, production.ini.in, print/config.yaml.in, and
     print/templates/print.mako.in replace "${paster_port}" by
     "${waitress_port}".

   And to be able to use "pserve" you need to add "waitress" to
   the "install_requires" list defined in the application's
   "setup.py" file. For example:

   install_requires=[
       'c2cgeoportal',
       'configobj',
       'pyramid_debugtoolbar',
       'waitress'
   ],

2. Display directly the loading panel introduce those needed changes:
    * In the +package+/templates/viewer.js includes all the code in:
        Ext.onReady(function() {
            // all the code
        });
    * In the +package+/templates/index.html do this replacement:
      -        <script type="text/javascript">
      -            Ext.onReady(function() {
      -                <%include file="viewer.js" />
      -            });
      -        </script>
      +        <script type="text/javascript" src="${request.route_url('viewer')}"></script>
    * Do the same for the edit.js/edit.html

3. If missing, add a MIME type to the "jpeg" OUTPUTFORMAT section
   in mapserver/c2cgeoportal.map.in:
   MIMETYPE "image/jpeg"

4. Mapfile performance tips:
    * To get lighter PNG outputs, use the following outputformat:
      OUTPUTFORMAT
          NAME png
          DRIVER AGG/PNG
          MIMETYPE "image/png"
          IMAGEMODE RGBA
          EXTENSION "png"
          FORMATOPTION "INTERLACE=OFF"
          FORMATOPTION "QUANTIZE_DITHER=OFF"
          FORMATOPTION "QUANTIZE_FORCE=ON"
          FORMATOPTION "QUANTIZE_COLORS=256"
      END
    * For PostGIS layers, make sure to use:
      PROCESSING "CLOSE_CONNECTION=DEFER"


Version 0.6
===========

Editing Interface
-----------------

c2cgeoportal 0.6 features an editing interface. To make the editing interface
work in an existing project several steps are required:

1. The editing interface relies on the CGXP Editing plugin. This plugin is
   available as of commit 58c931d [1] of CGXP. So CGXP should be updated to, at
   least, this commit in the application. See [2] to know how to update CGXP.

   [1] <https://github.com/camptocamp/cgxp/commit/58c931de2f6397ffba223b4305d0b10a18413032>
   [2] <http://docs.camptocamp.net/c2cgeoportal/integrator/update_application.html#update-cgxp>

2. An [edit.js] section should be added to jsbuild/app.cfg (notice the CHANGE
   ME IF NEEDED comment):

   [edit.js]
   root =
       {{package}}/static/lib/cgxp/core/src/script
       {{package}}/static/lib/cgxp/ext
       {{package}}/static/lib/cgxp/geoext/lib
       {{package}}/static/lib/cgxp/openlayers/lib
       {{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthControl/lib
       {{package}}/static/lib/cgxp/openlayers.addins/Spherical/lib
       {{package}}/static/lib/cgxp/gxp/src/script
       {{package}}/static/lib/cgxp/proj4js
       {{package}}/static/lib/cgxp/geoext.ux/ux/Measure/lib
       {{package}}/static/lib/cgxp/geoext.ux/ux/SimplePrint/lib
       {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureEditing/lib
       {{package}}/static/lib/cgxp/sandbox
       {{package}}/static/lib/cgxp/styler/lib
       {{package}}/static/lib/cgxp/ext.ux/TwinTriggerComboBox
       {{package}}/static/lib/cgxp/ext.ux/ColorPicker
       {{package}}/static/lib/cgxp/ext.ux/base64
       {{package}}/static/js
   first =
       Ext/adapter/ext/ext-base.js
       Ext/ext-all.js
       OpenLayers/SingleFile.js
       OpenLayers/Console.js
       OpenLayers/BaseTypes.js
       OpenLayers/BaseTypes/Class.js
       OpenLayers/BaseTypes/Pixel.js
       OpenLayers/BaseTypes/Bounds.js
       OpenLayers/BaseTypes/LonLat.js
       OpenLayers/BaseTypes/Element.js
       OpenLayers/BaseTypes/Size.js
       OpenLayers/Util.js
       OpenLayers/Lang.js
       proj4js/lib/proj4js.js
   exclude =
       GeoExt.js
       GeoExt/SingleFile.js
   include =
       EPSG21781.js #proj4js (CHANGE ME IF NEEDED)
       util.js #GXP
       widgets/Viewer.js #GXP
       CGXP/plugins/Editing.js
       CGXP/plugins/Login.js
       CGXP/plugins/ThemeSelector.js
       CGXP/plugins/LayerTree.js
       CGXP/plugins/MenuShortcut.js
       CGXP/widgets/MapPanel.js
       OpenLayers/Control/Navigation.js
       OpenLayers/Control/KeyboardDefaults.js
       OpenLayers/Control/PanZoomBar.js
       OpenLayers/Control/ArgParser.js
       OpenLayers/Control/Attribution.js
       OpenLayers/Control/ScaleLine.js
       OpenLayers/Control/MousePosition.js
       OpenLayers/Control/OverviewMap.js
       OpenLayers/Control/NavigationHistory.js
       OpenLayers/Layer/Vector.js
       OpenLayers/Renderer/SVG.js
       OpenLayers/Renderer/VML.js

3. Optionally you can add the line
   {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureEditing/lib to the "root"
   list of every [*.js] section of jsbuild/app.cfg. This is optional because
   only the editing interface (edit.js) should require scripts from this
   directory. But it may be a good idea to have every [*.js] section use the
   same "root" list.

4. You need to add two Mako templates to {{package}}/templates, namely edit.html
   and edit.js. These files are in the c2cgeoportal_create paster template, so
   they're not automatically added to the application source tree when the
   c2cgeoportal_update template is applied. The easiest way to get them is to
   apply the c2cgeoportal_create directory outside the existing application,
   and copy the files from the newly created directory to the application:

   cd {{project}}
   ./buildout/bin/paster create --template c2cgeoportal_create \
       --output-dir=/tmp/{{project}} package={{package}}
   cp /tmp/{{project}}/{{package}}/templates/edit.html {{package}}/templates/
   cp /tmp/{{project}}/{{package}}/templates/edit.js {{package}}/templates/
   rm -rf /tmp/{{project}}

5. SQL queries in the DATA properties should be changed in the mapfile for the
   editable layers. They should use the new "mapfile_data_subselect" Buildout
   variable. See the administrator mapfile documentation.

6. Papyrus 0.9 is required. See below.

7. GeoAlchemy 0.7 is required. See below.


Other changes
-------------

1. c2cgeoportal 0.6 requires Papyrus 0.9, so the version of Papyrus should be
   set to 0.9 on the buildout configuration of the c2cgeoportal project
   (section [versions]).

2. c2cgeoportal 0.6 requires GeoAlchemy 0.7. So GeoAlchemy should be set to
   0.7 in the project's buildout configuration.

3. In production.ini.in and development.ini.in jsbuild_root_dir should now be
   set to ${directory}:

   jsbuild_root_dir = ${directory}

4. To be able to use the AddKMLFile CGXP plugin (cgxp_addkmlfile) the directory
   {{package}}/static/lib/cgxp/ext.ux/base64 should be a "root" in each [*.js]
   section of jsbuild/app.cfg. Example:

    [app.js]
    root =
        {{package}}/static/lib/cgxp/core/src/script
        {{package}}/static/lib/cgxp/ext
        {{package}}/static/lib/cgxp/geoext/lib
        {{package}}/static/lib/cgxp/openlayers/lib
        {{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthControl/lib
        {{package}}/static/lib/cgxp/openlayers.addins/Spherical/lib
        {{package}}/static/lib/cgxp/gxp/src/script
        {{package}}/static/lib/cgxp/proj4js
        {{package}}/static/lib/cgxp/geoext.ux/ux/Measure/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/SimplePrint/lib
        {{package}}/static/lib/cgxp/geoext.ux/ux/FeatureEditing/lib
        {{package}}/static/lib/cgxp/sandbox
        {{package}}/static/lib/cgxp/styler/lib
        {{package}}/static/lib/cgxp/ext.ux/TwinTriggerComboBox
        {{package}}/static/lib/cgxp/ext.ux/ColorPicker
        {{package}}/static/lib/cgxp/ext.ux/base64
        {{package}}/static/js

5. To be able to install c2cgeoportal applications behind proxies with limited
   access to the outside world we had to patch Distribute and Buildout. See
   <https://github.com/camptocamp/c2cgeoportal/issues/62> for more details.

   If your application is behind a proxy which can access pypi.camptocamp.net
   only then it is required to use the patched versions of Distribute and
   Buildout. If your application is not behind a proxy it is recommended.

   To change to the patched versions of Distribute and Buildout follow these
   steps:

   - Edit CONST_buildout.cfg and verify that it has an allow-hosts option set
     to pypi.camptocamp.net.

   - Remove the Distribute and Buildout eggs from the buildout/eggs dir:

     rm -rf buildout/eggs/distribute-0.6.14* buildout/eggs/zc.buildout-1.5.2*

   - Run bootstrap.py with specific options to install the patched versions of
     Buildout and Distribute:

     python bootstrap.py --version 1.5.2 --distribute --download-base \
       http://pypi.camptocamp.net/distribute-0.6.22_fix-issue-227/ --setup-source \
       http://pypi.camptocamp.net/distribute-0.6.22_fix-issue-227/distribute_setup.py

   - Run the usual buildout/bin/buildout command.

6. In jsbuild/app.cfg, replace GoogleEarthControl by GoogleEarthView to
   have the following entry:
        {{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthView/lib
   And add the following entries to api.js, and all language files
   (like en.js, fr.js, de.js, ...) to have all identical root:
        {{package}}/static/lib/cgxp/openlayers.addins/GoogleEarthView/lib
        {{package}}/static/lib/cgxp/openlayers.addins/Spherical/lib

7. Templates modifications:

   The base templates are deprecated, to get the new version do
   (Careful: this will overwrite your changes):
       cd {{project}}
       ./buildout/bin/paster create --template c2cgeoportal_create \
           --output-dir=/tmp/{{project}} package={{package}}
       cp /tmp/{{project}}/{{package}}/templates/apihelp.html {{package}}/templates/
       cp /tmp/{{project}}/{{package}}/templates/apiloader.html {{package}}/templates/
       cp /tmp/{{project}}/{{package}}/templates/apiviewer.html {{package}}/templates/
       cp /tmp/{{project}}/{{package}}/templates/index.html {{package}}/templates/
       cp /tmp/{{project}}/{{package}}/templates/viewer.js {{package}}/templates/
       rm -rf /tmp/{{project}}

   Notes:

      * The viewer layout has changed to ease the integration of the Google Earth plugin.
      * A null value for the user's map extent is now permitted.
      * The jsextent property of role is renamed to json_extent.

8. Other changes to jsbuild/app.cfg are recommended. They are even required if
   you added an edit.js section as indicated in the "Editing Interface" section
   above. Your application's jsbuild/app.cfg most probably adds
   language-related files into app.js and api.js, which it should not. The only
   language-related file that should be included in app.js, edit.js and api.js
   is OpenLayers/Lang.js. The other language-related files should go in the
   lang-*.js builds.  See this diff
   https://github.com/camptocamp/c2cgeoportal/pull/105/files and
   https://github.com/camptocamp/c2cgeoportal/pull/166/files to see how app.cfg
   was changed in the create template, that should help you fix your
   application's app.cfg. The note explaining why OpenLayers/Lang.js should be
   included in the main build may be of interest.


Version 0.5 (and before)
========================

-------------------------------
Mon, 27 Feb 2012 14:15:14 +0100

We have release JSTools 0.6 on pypi.python.org. This version includes bug
fixes, for Windows in particular. c2cgeoportal 0.5 requires JSTools 0.6, so the
version of JSTools should be set to 0.6 in the buildout configuration of
c2cgeoportal projects (section [versions]).

-------------------------------
Tue, 31 Jan 2012 13:59:45 +0100

Because OpenLayers has been upgraded, one must replace
OpenLayers/Layer/XYZ.js
by
OpenLayers/Layer/OSM.js
in the [app.js] "include" section of jsbuild/app.cfg.

-------------------------------
Tue, 31 Jan 2012 14:41:44 +0100

In the <package>/template/viewer.js file, in the block 'viewer_layers'
remove the last comma for IE, see commit 11d373b.

-------------------------------
Thu, 26 Jan 2012 13:21:20 +0100

Not required but recommended: you can edit your project's development.ini.in
and production.ini.in files and remove the [app:c2cgeoportal] section and its
content (one line). This section was needed for c2cgeoportal's manage_db and
create_db scripts to know the project package name, but it's not needed
anymore. For example, the manage_db script now has --app-name and --app-config
options.

-------------------------------

Thu, 12 Jan 2012 13:35:23 +0100

Due to wrong moving the files in 'print/print'. If exists the folder
'print/print/WEB-INF/' should be moved to 'print/WEB-INF/' and the
folder 'print/print/' should be removed.

-------------------------------

Wed, 14 Dec 2011 17:49:36 +0100

This migration concerns the changes reorganizing the "create" and "update"
paste templates.

* update the version of c2cgeoportal requirement in the project setup.py
so that c2cgeoportal dependency version is == 0.3.2. You should have:
    install_requires=[
        'PasteScript',
        'c2cgeoportal==0.3.2',
    ],
Then launch buildout to retrieve this new version of the egg c2cgeoportal.

* apply the 'update' template

* the manage_db script is now handled by c2cgeoportal again (this revert
the change introduced in c2cgeoportal v0.3.1):
  * update console_scripts entry points in the project setup.py, you should
  now have:
       'console_scripts': [
           'create_db = <package_name>.scripts.create_db:main',
       ],
  * remove the script manage_db from the project:
    $$ svn rm <package_name>/scripts/CONST_manage_db.py

* rename the following files:
    $$ svn mv apache/CONST_frontend.conf.in apache/frontend.conf.in
    $$ svn mv apache/CONST_mapserver.conf.in apache/mapserver.conf.in
    $$ svn mv apache/CONST_README.txt.in apache/README.txt.in
    $$ svn mv apache/CONST_tilecache.conf.in apache/tilecache.conf.in
    $$ svn mv apache/CONST_wsgi.conf.in apache/wsgi.conf.in
    $$ svn mv CONST_development.ini.in development.ini.in
    $$ svn mv CONST_production.ini.in production.ini.in
These files used to be generated by the update template, they're now generated
by the create template, this is why the CONST_ prefix is removed.
You can also update the svn:ignore property appropriately.

* add a .httpauth file in the project directory (if not already existing),
which contains the required credentials to access to our pypi internal server.
This file is generated when the 'create' template is applied so you have to
create it by hand.
This file should contain the following line:
    "C2C internal pypi server, http://pypi.camptocamp.net/internal-pypi, <login>, <password>"
(where <login> and <password> are to be replaced by the the Camptocamp internal
pypi server login/password)

-------------------------------

Wed, 14 Dec 2011 17:17:56 +0100

The files jsbuild/CONST_app.cfg and jsbuild/app.cfg should be merged together.
Finally jsbuild/CONST_app.cfg should be removed and all jsbuild configuration
should sit in jsbuild/app.cfg.

-------------------------------

/!\ ATTENTION:
Note that you cannot upgrade to c2cgeoportal version >= 0.3.2 directly.
You have to upgrade to v0.3.1 first, see below.

-------------------------------

VERSION 0.3.1

Thu, 08 Dec 2011 10:00:00 +0100

This migration concerns the changes about distributing c2cgeoportal as an egg.

Once project is up to date (svn update) and the 'update' template has been
applied, the project should also be updated in the following ways:

* remove svn:externals to c2cgeoportal and rm -rf c2cgeoportal directory

* update console_scripts entry points in the project setup.py so that script
manage_db now refers to <package_name>.scripts.CONST_manage_db:main. You should
have:
       'console_scripts': [
           'create_db = <package_name>.scripts.create_db:main',
           'manage_db = <package_name>.scripts.CONST_manage_db:main',
       ],

* update the version of c2cgeoportal requirement in the project setup.py
so that c2cgeoportal dependency version is == 0.3.1. You should have:
    install_requires=[
        'PasteScript',
        'c2cgeoportal==0.3.1',
    ],

* add a migrate.cfg file in
MyProject/myproject/CONST_migration/migrate.cfg
This migrate.cfg file is generated when the 'create' template is applied so
you have to create it by hand. The version_table parameter value should
be set to "version_<package_name>".

The content of the migrate.cfg file should look like this:

    [db_settings]
    # Used to identify which repository this database is versioned under.
    # You can use the name of your project.
    repository_id=c2cgeoportal

    # The name of the database table used to track the schema version.
    # This name shouldn't already be used by your project.
    # If this is changed once a database is under version control, you'll need to
    # change the table name in each database too.
    version_table=version_<package_name>

    # When committing a change script, Migrate will attempt to generate the
    # sql for all supported databases; normally, if one of them fails - probably
    # because you don't have that database installed - it is ignored and the
    # commit continues, perhaps ending successfully.
    # Databases in this list MUST compile successfully during a commit, or the
    # entire commit will fail. List the databases your application will actually
    # be using to ensure your updates to that database work properly.
    # This must be a list; example: ['postgres','sqlite']
    required_dbs=[]

* rename the version table to match the name set in the version_table
parameter:
    ALTER TABLE <old_name> RENAME TO version_<package_name>
with <old_name> replaced by the old name of the version table which is
certainly the application's db schema name.

-------------------------------

Wed, 14 Dec 2011 17:00:24 +0100

Implements group restriction to acces to the admin interface.

To continue to acces to the admin interface you should, in the file
'{{project}}/__init__.py' replace the line
-     authentication_policy = AuthTktAuthenticationPolicy(settings.get('authtkt_secret'))
by:
+     authentication_policy = AuthTktAuthenticationPolicy(settings.get('authtkt_secret'),
+            callback=defaultgroupsfinder)
and add the import:
+ from c2cgeoportal.resources import defaultgroupsfinder.

-------------------------------

Wed, 07 Dec 2011 15:10:57 +0100

Replace the CONST_README.txt by the documentation.
Add a CONST_TIP.txt to have some usefull commands.
Than you can do to remove the old CONST_README.txt
$$ svn rm CONST_README.txt.in

-------------------------------

Mon, 28 Nov 2011 17:43:25 +0100

Added apiloader.js in the project templates directory.

-------------------------------

Mon, 28 Nov 2011 16:13:41 +0100

Added missing encoder in the mapfile. In MAP/WEB/METADATA added:
    "wfs_encoding" "UTF-8"

-------------------------------

Mon, 28 Nov 2011 14:51:37 +0100

CGXP mode from SVN to GIT(hub).
Now we use a buildout task to do the clone.

To update your project do:
$$ svn propdel svn:externals {{package}}/static/lib/
$$ rm -rf {{package}}/static/lib/cgxp
$$ svn propset svn:ignore cgxp {{package}}/static/lib/

-------------------------------

Mon, 28 Nov 2011 11:42:25 +0100

Added WFSGetFeature to query feature in a BBOX but desable by default.
-------------------------------

Mon, 21 Nov 2011 12:58:23 +0100

Added a disclaimer cgxp plugin

Added CGXP/plugins/Disclaimer.js to jsbuild/app.cfg so that the Disclaimer
plugin can be used.
Note that the database should also be updated for the disclaimer plugin to
work correctly.
-------------------------------

Thu, 17 Nov 2011 11:24:25 +0100

Added block tools_additional in viewer_base.js
-------------------------------

Wed, 16 Nov 2011 16:11:54 +0100

Fixed gettext config in order to take into account translations from the project templates
-------------------------------

Wed, 09 Nov 2011 17:15:13 +0100

Extended GeoExt.MapPanel to override the getState method

Add CGXP/widgets/MapPanel.js in app.cfg
-------------------------------

Mon, 07 Nov 2011 10:05:22 +0100

Added a colorpicker to the redlining tool.

In the jsbuild/app.cfg, CGXP/plugins/Redlining.js should be replaced by
CGXP/widgets/RedliningColorPicker.js for the new colorpicker or by
CGXP/widgets/RedliningCombo.js to have the old combobox.
