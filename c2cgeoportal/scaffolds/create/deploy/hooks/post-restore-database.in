#!/bin/sh
#
# variables set here:
#   $TARGET: name of the symbolic remote host key (see remote_hosts 
#            section in config file)
#

DATABASES=$@

## Uncomment the following lines if you want to vacuum the databases after the
## restore. In most cases this is not needed because we are working with
## read-only databases.

# for b in $DATABASES
# do
#   psql -c "VACUUM ANALYZE;" $b
# done

psql -c 'GRANT USAGE ON SCHEMA "${schema}" TO "${dbuser}";' ${db}
psql -c 'GRANT SELECT ON ALL TABLES IN SCHEMA "${schema}" TO "${dbuser}";' ${db}

psql -c 'CREATE SCHEMA IF NOT EXISTS ${schema}_static;' ${db}
psql -c 'CREATE TABLE ${schema}_static.shorturl (
    id serial PRIMARY KEY,
    url character varying(1000),
    ref character varying(20) NOT NULL UNIQUE,
    creator_email character varying(200),
    creation timestamp without time zone,
    last_hit timestamp without time zone,
    nb_hits integer
);' ${db}

psql -c 'GRANT USAGE ON SCHEMA "${schema}_static" TO "${dbuser}";' ${db}
psql -c 'GRANT SELECT ON ALL TABLES IN SCHEMA "${schema}_static" TO "${dbuser}";' ${db}
